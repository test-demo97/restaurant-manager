import{d as v,u as X,bb as Q,r as d,k as Y,F as N,G as c,aO as Z,t as n,j as e,R as ee,P as se,bf as te,bg as S,bh as P,K as $,e as I,M as q}from"./index-BP0TVsm5.js";import{u as ae}from"./useDemoGuard-BJoSrPxu.js";import{S as ie}from"./search-ByNraucg.js";import{L as F}from"./link-2-QUJUaaRB.js";const ne=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"M12 8v4",key:"1got3b"}],["path",{d:"M12 16h.01",key:"1drbdi"}]],U=v("shield-alert",ne);const re=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],_=v("shield-check",re);const le=[["path",{d:"m16 11 2 2 4-4",key:"9rsbq5"}],["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],b=v("user-check",le);const de=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]],g=v("user-x",de);function he(){X();const{isPremium:h}=Q(),{checkCanWrite:w}=ae(),[l,p]=d.useState([]),[y,G]=d.useState([]),[J,E]=d.useState(!0),[k,B]=d.useState(""),[H,u]=d.useState(!1),[r,A]=d.useState(null),[C,f]=d.useState(null),[a,m]=d.useState({username:"",password:"",name:"",role:"staff",employee_id:null}),{user:o}=Y();d.useEffect(()=>{j()},[]);async function j(){E(!0);try{if(N&&c){const{data:i,error:t}=await c.from("users").select("*").order("name");if(t)throw t;p(i||[])}else{const i=JSON.parse(localStorage.getItem("kebab_users")||"[]");p(i)}const s=await Z();G(s)}catch(s){console.error("Errore caricamento dati:",s),n("Errore nel caricamento dati","error")}E(!1)}const L=y.filter(s=>!l.find(t=>t.employee_id===s.id&&t.id!==r?.id));function M(s){const i=l.find(t=>t.id===s);if(i?.employee_id)return y.find(t=>t.id===i.employee_id)}const D=l.filter(s=>s.name.toLowerCase().includes(k.toLowerCase())||s.username.toLowerCase().includes(k.toLowerCase()));function V(){A(null),m({username:"",password:"",name:"",role:"staff",employee_id:null}),u(!0)}function z(s){A(s),m({username:s.username,password:"",name:s.name,role:s.role,employee_id:s.employee_id||null}),u(!0)}async function K(){if(!w())return;if(!r&&!h){n("La creazione di nuovi utenti richiede il piano Premium","warning");return}if(!a.username||!a.name){n("Username e nome sono obbligatori","warning");return}if(!r&&!a.password){n("La password è obbligatoria per i nuovi utenti","warning");return}if(l.find(i=>i.username.toLowerCase()===a.username.toLowerCase()&&i.id!==r?.id)){n("Username già esistente","error");return}try{if(N&&c){if(r){const i={username:a.username,name:a.name,role:a.role,employee_id:a.employee_id};a.password&&(i.password=a.password);const{error:t}=await c.from("users").update(i).eq("id",r.id);if(t)throw t;n("Utente modificato con successo","success")}else{const{error:i}=await c.from("users").insert({username:a.username,password:a.password,name:a.name,role:a.role,employee_id:a.employee_id||null,active:!0});if(i)throw i;n("Utente creato con successo","success")}await j()}else{let i;if(r)i=l.map(t=>t.id===r.id?{...t,username:a.username,name:a.name,role:a.role,employee_id:a.employee_id||void 0,...a.password&&{password:a.password}}:t),n("Utente modificato con successo","success");else{const t={id:Date.now(),username:a.username,password:a.password,name:a.name,role:a.role,employee_id:a.employee_id||void 0,active:!0,created_at:new Date().toISOString()};i=[...l,t],n("Utente creato con successo","success")}localStorage.setItem("kebab_users",JSON.stringify(i)),p(i)}u(!1)}catch(i){console.error("Errore salvataggio utente:",i),n("Errore nel salvataggio","error")}}async function T(s){if(!w())return;if(s===o?.id){n("Non puoi disattivare il tuo account","error");return}const i=l.find(t=>t.id===s);if(i)try{if(N&&c){const{error:t}=await c.from("users").update({active:!i.active}).eq("id",s);if(t)throw t;await j()}else{const t=l.map(x=>x.id===s?{...x,active:!x.active}:x);localStorage.setItem("kebab_users",JSON.stringify(t)),p(t)}n("Stato utente aggiornato","success")}catch(t){console.error("Errore aggiornamento stato:",t),n("Errore nell'aggiornamento","error")}}async function W(s){if(!w())return;if(s===o?.id){n("Non puoi eliminare il tuo account","error");return}if(l.find(t=>t.id===s)?.username==="admin"){n("L'utente amministratore predefinito non può essere eliminato","error");return}try{if(N&&c){const{error:t}=await c.from("users").delete().eq("id",s);if(t)throw t;await j()}else{const t=l.filter(x=>x.id!==s);localStorage.setItem("kebab_users",JSON.stringify(t)),p(t)}f(null),n("Utente eliminato","success")}catch(t){console.error("Errore eliminazione utente:",t),n("Errore nell'eliminazione","error")}}function O(s){switch(s){case"superadmin":return e.jsx(U,{className:"w-4 h-4 text-red-400"});case"admin":return e.jsx(_,{className:"w-4 h-4 text-amber-400"});case"staff":return e.jsx(S,{className:"w-4 h-4 text-blue-400"})}}function R(s){switch(s){case"superadmin":return"bg-red-500/20 text-red-400 border border-red-500/30";case"admin":return"bg-amber-500/20 text-amber-400 border border-amber-500/30";case"staff":return"bg-blue-500/20 text-blue-400 border border-blue-500/30"}}return J?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-500"})}):e.jsxs("div",{className:"space-y-3 sm:space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-white",children:"Gestione Utenti"}),e.jsx("p",{className:"text-dark-400 text-xs sm:text-sm",children:"Crea e gestisci gli account del sistema"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:j,className:"btn-secondary btn-sm",children:e.jsx(ee,{className:"w-4 h-4"})}),e.jsxs("button",{onClick:h?V:()=>n("La creazione di nuovi utenti richiede il piano Premium","warning"),className:`btn-sm flex-1 sm:flex-none justify-center ${h?"btn-primary":"btn-secondary opacity-70"}`,title:h?"":"Richiede piano Premium",children:[h?e.jsx(se,{className:"w-4 h-4"}):e.jsx(te,{className:"w-4 h-4"}),"Nuovo Utente"]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2 sm:gap-4",children:[e.jsx("div",{className:"stat-card",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"stat-label text-xs",children:"Totale Utenti"}),e.jsx("p",{className:"stat-value text-lg sm:text-2xl",children:l.length})]}),e.jsx("div",{className:"w-8 h-8 sm:w-12 sm:h-12 rounded-xl bg-blue-500/20 flex items-center justify-center",children:e.jsx(S,{className:"w-4 h-4 sm:w-6 sm:h-6 text-blue-400"})})]})}),e.jsx("div",{className:"stat-card",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"stat-label text-xs",children:"Super Admin"}),e.jsx("p",{className:"stat-value text-lg sm:text-2xl",children:l.filter(s=>s.role==="superadmin").length})]}),e.jsx("div",{className:"w-8 h-8 sm:w-12 sm:h-12 rounded-xl bg-red-500/20 flex items-center justify-center",children:e.jsx(U,{className:"w-4 h-4 sm:w-6 sm:h-6 text-red-400"})})]})}),e.jsx("div",{className:"stat-card",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"stat-label text-xs",children:"Admin"}),e.jsx("p",{className:"stat-value text-lg sm:text-2xl",children:l.filter(s=>s.role==="admin").length})]}),e.jsx("div",{className:"w-8 h-8 sm:w-12 sm:h-12 rounded-xl bg-amber-500/20 flex items-center justify-center",children:e.jsx(_,{className:"w-4 h-4 sm:w-6 sm:h-6 text-amber-400"})})]})}),e.jsx("div",{className:"stat-card",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"stat-label text-xs",children:"Staff"}),e.jsx("p",{className:"stat-value text-lg sm:text-2xl",children:l.filter(s=>s.role==="staff").length})]}),e.jsx("div",{className:"w-8 h-8 sm:w-12 sm:h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center",children:e.jsx(b,{className:"w-4 h-4 sm:w-6 sm:h-6 text-emerald-400"})})]})})]}),e.jsxs("div",{className:"relative max-w-md",children:[e.jsx(ie,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 sm:w-5 sm:h-5 text-dark-400"}),e.jsx("input",{type:"text",placeholder:"Cerca utente...",value:k,onChange:s=>B(s.target.value),className:"input pl-9 sm:pl-10 text-sm sm:text-base"})]}),e.jsx("div",{className:"card hidden md:block",children:e.jsx("div",{className:"table-container",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Utente"}),e.jsx("th",{children:"Username"}),e.jsx("th",{children:"Ruolo"}),e.jsx("th",{children:"Dipendente"}),e.jsx("th",{children:"Stato"}),e.jsx("th",{children:"Ultimo Accesso"}),e.jsx("th",{children:"Azioni"})]})}),e.jsx("tbody",{children:D.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-dark-700 flex items-center justify-center",children:e.jsx("span",{className:"text-lg font-semibold text-primary-400",children:s.name.charAt(0).toUpperCase()})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-white",children:s.name}),s.id===o?.id&&e.jsx("p",{className:"text-xs text-primary-400",children:"(Tu)"})]})]})}),e.jsx("td",{children:e.jsx("p",{className:"font-mono text-dark-300",children:s.username})}),e.jsx("td",{children:e.jsxs("span",{className:`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-sm font-medium ${R(s.role)}`,children:[O(s.role),P[s.role]]})}),e.jsx("td",{children:(()=>{const i=M(s.id);return i?e.jsxs("span",{className:"inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-sm font-medium bg-primary-500/20 text-primary-400",children:[e.jsx(F,{className:"w-3 h-3"}),i.name]}):e.jsx("span",{className:"text-dark-500 text-sm",children:"-"})})()}),e.jsx("td",{children:e.jsx("span",{className:`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-sm font-medium ${s.active?"bg-emerald-500/20 text-emerald-400":"bg-red-500/20 text-red-400"}`,children:s.active?e.jsxs(e.Fragment,{children:[e.jsx(b,{className:"w-3 h-3"}),"Attivo"]}):e.jsxs(e.Fragment,{children:[e.jsx(g,{className:"w-3 h-3"}),"Disattivato"]})})}),e.jsx("td",{children:e.jsx("p",{className:"text-dark-400 text-sm",children:s.last_login?new Date(s.last_login).toLocaleString("it-IT"):"Mai"})}),e.jsx("td",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>z(s),className:"btn-secondary btn-sm",title:"Modifica",children:e.jsx($,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>T(s.id),className:`btn-sm ${s.active?"btn-secondary":"btn-primary"}`,title:s.active?"Disattiva":"Attiva",disabled:s.id===o?.id,children:s.active?e.jsx(g,{className:"w-4 h-4"}):e.jsx(b,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>f(s.id),className:"p-2 text-red-400 hover:bg-red-500/20 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:s.username==="admin"?"Utente predefinito non eliminabile":"Elimina",disabled:s.id===o?.id||s.username==="admin",children:e.jsx(I,{className:"w-4 h-4"})})]})})]},s.id))})]})})}),e.jsx("div",{className:"md:hidden space-y-3",children:D.map(s=>{const i=M(s.id);return e.jsxs("div",{className:"card p-3",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-dark-700 flex items-center justify-center flex-shrink-0",children:e.jsx("span",{className:"text-lg font-semibold text-primary-400",children:s.name.charAt(0).toUpperCase()})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("p",{className:"font-medium text-white text-sm truncate",children:s.name}),s.id===o?.id&&e.jsx("span",{className:"text-xs text-primary-400",children:"(Tu)"})]}),e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium flex-shrink-0 ${s.active?"bg-emerald-500/20 text-emerald-400":"bg-red-500/20 text-red-400"}`,children:[s.active?e.jsx(b,{className:"w-3 h-3"}):e.jsx(g,{className:"w-3 h-3"}),s.active?"Attivo":"Disattivato"]})]}),e.jsxs("p",{className:"font-mono text-dark-400 text-xs mt-0.5",children:["@",s.username]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-2",children:[e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium ${R(s.role)}`,children:[O(s.role),P[s.role]]}),i&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-primary-500/20 text-primary-400",children:[e.jsx(F,{className:"w-3 h-3"}),i.name]})]}),e.jsxs("p",{className:"text-dark-500 text-xs mt-2",children:["Ultimo accesso: ",s.last_login?new Date(s.last_login).toLocaleString("it-IT"):"Mai"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-3 pt-3 border-t border-dark-700",children:[e.jsxs("button",{onClick:()=>z(s),className:"btn-secondary btn-sm flex-1 justify-center text-xs",children:[e.jsx($,{className:"w-3.5 h-3.5"}),"Modifica"]}),e.jsxs("button",{onClick:()=>T(s.id),className:`btn-sm flex-1 justify-center text-xs ${s.active?"btn-secondary":"btn-primary"}`,disabled:s.id===o?.id,children:[s.active?e.jsx(g,{className:"w-3.5 h-3.5"}):e.jsx(b,{className:"w-3.5 h-3.5"}),s.active?"Disattiva":"Attiva"]}),e.jsx("button",{onClick:()=>f(s.id),className:"p-2 text-red-400 hover:bg-red-500/20 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:s.id===o?.id||s.username==="admin",title:s.username==="admin"?"Utente predefinito non eliminabile":"Elimina",children:e.jsx(I,{className:"w-4 h-4"})})]})]},s.id)})}),e.jsxs("div",{className:"bg-dark-800 rounded-xl border border-dark-700 p-3 sm:p-4",children:[e.jsx("h3",{className:"font-semibold text-white mb-2 sm:mb-3 text-sm sm:text-base",children:"Permessi per Ruolo"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4",children:[e.jsxs("div",{className:"bg-dark-900 rounded-lg p-2.5 sm:p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1.5 sm:mb-2",children:[e.jsx(U,{className:"w-4 h-4 sm:w-5 sm:h-5 text-red-400"}),e.jsx("span",{className:"font-medium text-red-400 text-sm",children:"Super Admin"})]}),e.jsx("p",{className:"text-xs text-dark-400",children:"Accesso completo: Dashboard, Ordini, Menu, Tavoli, Inventario, Ricette, Personale, Report, SMAC, Impostazioni, Gestione Utenti"})]}),e.jsxs("div",{className:"bg-dark-900 rounded-lg p-2.5 sm:p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1.5 sm:mb-2",children:[e.jsx(_,{className:"w-4 h-4 sm:w-5 sm:h-5 text-amber-400"}),e.jsx("span",{className:"font-medium text-amber-400 text-sm",children:"Admin"})]}),e.jsx("p",{className:"text-xs text-dark-400",children:"Accesso operativo: Dashboard, Ordini, Menu, Tavoli, Inventario, Ricette, Personale"})]}),e.jsxs("div",{className:"bg-dark-900 rounded-lg p-2.5 sm:p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1.5 sm:mb-2",children:[e.jsx(S,{className:"w-4 h-4 sm:w-5 sm:h-5 text-blue-400"}),e.jsx("span",{className:"font-medium text-blue-400 text-sm",children:"Staff"})]}),e.jsx("p",{className:"text-xs text-dark-400",children:"Servizio: Nuovo Ordine, Ordini, Tavoli, I Miei Turni (solo propri turni e paga)"})]})]})]}),e.jsx(q,{isOpen:H,onClose:()=>u(!1),title:r?"Modifica Utente":"Nuovo Utente",size:"xl",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"md:grid md:grid-cols-2 md:gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-dark-300 mb-1",children:"Nome Completo *"}),e.jsx("input",{type:"text",value:a.name,onChange:s=>m({...a,name:s.target.value}),placeholder:"Es: Mario Rossi",className:"input"})]}),e.jsxs("div",{className:"mt-4 md:mt-0",children:[e.jsx("label",{className:"block text-sm font-medium text-dark-300 mb-1",children:"Username *"}),e.jsx("input",{type:"text",value:a.username,onChange:s=>m({...a,username:s.target.value.toLowerCase()}),placeholder:"Es: mario.rossi",className:"input font-mono"})]})]}),e.jsxs("div",{className:"md:grid md:grid-cols-2 md:gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-dark-300 mb-1",children:["Password ",r?"(lascia vuoto per non modificare)":"*"]}),e.jsx("input",{type:"password",value:a.password,onChange:s=>m({...a,password:s.target.value}),placeholder:r?"••••••••":"Inserisci password",className:"input"})]}),e.jsxs("div",{className:"mt-4 md:mt-0",children:[e.jsx("label",{className:"block text-sm font-medium text-dark-300 mb-1",children:"Ruolo *"}),e.jsxs("select",{value:a.role,onChange:s=>m({...a,role:s.target.value}),className:"input",children:[e.jsx("option",{value:"staff",children:"Staff - Solo servizio"}),e.jsx("option",{value:"admin",children:"Admin - Operativo"}),e.jsx("option",{value:"superadmin",children:"Super Admin - Accesso completo"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-dark-300 mb-1",children:"Collega a Dipendente"}),e.jsxs("select",{value:a.employee_id||"",onChange:s=>m({...a,employee_id:s.target.value?parseInt(s.target.value):null}),className:"input",children:[e.jsx("option",{value:"",children:"Nessun collegamento"}),r?.employee_id&&!L.find(s=>s.id===r.employee_id)&&e.jsxs("option",{value:r.employee_id,children:[y.find(s=>s.id===r.employee_id)?.name," (collegato)"]}),L.map(s=>e.jsxs("option",{value:s.id,children:[s.name," - ",s.role]},s.id))]}),e.jsx("p",{className:"text-xs text-dark-400 mt-1",children:"Collega l'utente a un dipendente per permettere di vedere turni e paga personali"})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx("button",{onClick:()=>u(!1),className:"btn-secondary",children:"Annulla"}),e.jsx("button",{onClick:K,className:"btn-primary",children:r?"Salva Modifiche":"Crea Utente"})]})]})}),e.jsx(q,{isOpen:C!==null,onClose:()=>f(null),title:"Conferma Eliminazione",size:"sm",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-dark-300",children:"Sei sicuro di voler eliminare questo utente? L'azione è irreversibile."}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>f(null),className:"btn-secondary",children:"Annulla"}),e.jsx("button",{onClick:()=>C&&W(C),className:"bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl font-medium transition-colors",children:"Elimina"})]})]})})]})}export{he as Users};
