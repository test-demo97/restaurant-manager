import{d as I,u as H,r as h,D as K,$ as U,t as l,j as s,R as W,c as k,v as S,h as Y,b9 as T,F as Z,G as F}from"./index-BP0TVsm5.js";import{C as ss}from"./calendar-ixF2_BIP.js";import{C as es}from"./chevron-down-CpFrdbwl.js";import{C as as}from"./chevron-right-Zeo8Ppur.js";const ts=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"m9 15 2 2 4-4",key:"1grp1n"}]],D=I("file-check",ts);const rs=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"m14.5 12.5-5 5",key:"b62r18"}],["path",{d:"m9.5 12.5 5 5",key:"1rk7el"}]],is=I("file-x",rs);async function O(p,u){if(Z&&F){const{error:m}=await F.from("orders").update({smac_passed:u}).eq("id",p);if(m)throw m}else{const m="kebab_",c=JSON.parse(localStorage.getItem(m+"orders")||"[]"),j=c.findIndex(b=>b.id===p);j!==-1&&(c[j].smac_passed=u,localStorage.setItem(m+"orders",JSON.stringify(c)))}}function ds(){H();const[p,u]=h.useState([]),[m,c]=h.useState({}),[j,b]=h.useState(!0),[N,z]=h.useState(new Date().toISOString().split("T")[0]),[g,C]=h.useState("all"),[R,L]=h.useState(new Set);h.useEffect(()=>{_()},[N]);async function _(){b(!0);try{const r=(await K(N)).filter(t=>t.status!=="cancelled");u(r);const i=[...new Set(r.filter(t=>t.session_id).map(t=>t.session_id))],a={};await Promise.all(i.map(async t=>{const n=await U(t);a[t]=n})),c(a)}catch(e){console.error("Error loading orders:",e),l("Errore nel caricamento ordini","error")}finally{b(!1)}}const d=(()=>{const e={},r=[];p.forEach(a=>{a.session_id?(e[a.session_id]||(e[a.session_id]=[]),e[a.session_id].push(a)):r.push(a)});const i=[];return Object.entries(e).forEach(([a,t])=>{const n=t[0],$=t.reduce((o,x)=>o+x.total,0),w=m[Number(a)]||[];let v=n.smac_passed,y=0;if(w.length>0){const o=w.filter(x=>x.smac_passed);y=o.reduce((x,Q)=>x+Q.amount,0),o.length===0?v=!1:o.length===w.length?v=!0:v="partial"}else y=n.smac_passed?$:0;i.push({type:"session",sessionId:Number(a),orders:t.sort((o,x)=>(o.order_number||0)-(x.order_number||0)),payments:w,total:$,tableName:n.table_name,customerName:n.customer_name,smacPassed:v,smacAmount:y})}),r.forEach(a=>{i.push({type:"single",orders:[a],payments:[],total:a.total,tableName:a.table_name,customerName:a.customer_name,smacPassed:a.smac_passed,smacAmount:a.smac_passed?a.total:0})}),i.sort((a,t)=>new Date(t.orders[0].created_at).getTime()-new Date(a.orders[0].created_at).getTime())})(),P=d.filter(e=>g==="passed"?e.smacPassed===!0:g==="not_passed"?e.smacPassed===!1||e.smacPassed==="partial":!0),A=d.reduce((e,r)=>e+r.smacAmount,0),M=d.reduce((e,r)=>e+(r.total-r.smacAmount),0),E=d.filter(e=>e.smacPassed===!0).length,f=d.filter(e=>e.smacPassed===!1||e.smacPassed==="partial").length;function V(e){L(r=>{const i=new Set(r);return i.has(e)?i.delete(e):i.add(e),i})}async function G(e){try{const r=!e.smacPassed;for(const i of e.orders)await O(i.id,r);u(i=>i.map(a=>e.orders.some(t=>t.id===a.id)?{...a,smac_passed:r}:a)),l(r?"SMAC registrata":"SMAC rimossa","success")}catch(r){console.error("Error updating SMAC:",r),l("Errore nell'aggiornamento","error")}}async function q(e){try{const r=e.smacPassed!==!0;for(const i of e.payments)await T(i.id,r);e.sessionId&&c(i=>({...i,[e.sessionId]:i[e.sessionId].map(a=>({...a,smac_passed:r}))})),l(r?"SMAC registrata per tutti i pagamenti":"SMAC rimossa da tutti i pagamenti","success")}catch(r){console.error("Error updating payments SMAC:",r),l("Errore nell'aggiornamento","error")}}async function J(e,r){try{const i=!e.smac_passed;await T(e.id,i),c(a=>({...a,[r]:a[r].map(t=>t.id===e.id?{...t,smac_passed:i}:t)})),l(i?"SMAC registrata":"SMAC rimossa","success")}catch(i){console.error("Error updating payment SMAC:",i),l("Errore nell'aggiornamento","error")}}async function X(){if(confirm(`Segnare tutti i ${f} ordini/conti come SMAC passata?`))try{for(const e of p.filter(r=>!r.smac_passed))await O(e.id,!0);l(`${f} ordini/conti segnati come SMAC passata`,"success"),_()}catch(e){console.error("Error updating SMAC:",e),l("Errore nell'aggiornamento","error")}}const B=e=>new Date(e).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"});return j?s.jsx("div",{className:"flex items-center justify-center h-64",children:s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-500"})}):s.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[s.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-white",children:"Dichiarazioni SMAC"}),s.jsx("p",{className:"text-dark-400 mt-1 text-xs sm:text-sm",children:"Gestione SMAC per la dichiarazione fiscale"})]}),s.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[s.jsx("button",{onClick:_,className:"btn-secondary p-2 sm:px-4 sm:py-2",children:s.jsx(W,{className:"w-4 h-4 sm:w-5 sm:h-5"})}),f>0&&s.jsxs("button",{onClick:X,className:"btn-primary text-xs sm:text-sm flex-1 sm:flex-none justify-center",children:[s.jsx(k,{className:"w-4 h-4 sm:w-5 sm:h-5"}),s.jsx("span",{className:"hidden sm:inline",children:"Segna Tutti come"})," Passati"]})]})]}),s.jsxs("div",{className:"flex flex-wrap items-center gap-2 sm:gap-4",children:[s.jsx(ss,{className:"w-5 h-5 text-dark-400 hidden sm:block"}),s.jsx("input",{type:"date",value:N,onChange:e=>z(e.target.value),className:"input w-auto text-sm sm:text-base"}),s.jsx("span",{className:"text-dark-400 text-sm sm:text-base hidden sm:inline",children:B(N)})]}),s.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-2 sm:gap-4",children:[s.jsx("div",{className:"stat-card",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"min-w-0 flex-1",children:[s.jsx("p",{className:"stat-label text-xs sm:text-sm",children:"Totali"}),s.jsx("p",{className:"stat-value text-lg sm:text-2xl",children:d.length}),s.jsxs("p",{className:"text-xs text-dark-500",children:[p.length," comande"]})]}),s.jsx("div",{className:"w-8 h-8 sm:w-12 sm:h-12 rounded-xl bg-blue-500/20 flex items-center justify-center flex-shrink-0",children:s.jsx(D,{className:"w-4 h-4 sm:w-6 sm:h-6 text-blue-400"})})]})}),s.jsx("div",{className:"stat-card glow-sm",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"min-w-0 flex-1",children:[s.jsx("p",{className:"stat-label text-xs sm:text-sm",children:"SMAC Passata"}),s.jsxs("p",{className:"stat-value text-emerald-400 text-lg sm:text-2xl",children:["€",A.toFixed(2)]}),s.jsxs("p",{className:"text-xs text-dark-500",children:[E," conti"]})]}),s.jsx("div",{className:"w-8 h-8 sm:w-12 sm:h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center flex-shrink-0",children:s.jsx(k,{className:"w-4 h-4 sm:w-6 sm:h-6 text-emerald-400"})})]})}),s.jsx("div",{className:"stat-card",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"min-w-0 flex-1",children:[s.jsx("p",{className:"stat-label text-xs sm:text-sm",children:"Non Passata"}),s.jsxs("p",{className:"stat-value text-amber-400 text-lg sm:text-2xl",children:["€",M.toFixed(2)]}),s.jsxs("p",{className:"text-xs text-dark-500",children:[f," conti"]})]}),s.jsx("div",{className:"w-8 h-8 sm:w-12 sm:h-12 rounded-xl bg-amber-500/20 flex items-center justify-center flex-shrink-0",children:s.jsx(S,{className:"w-4 h-4 sm:w-6 sm:h-6 text-amber-400"})})]})}),s.jsx("div",{className:"stat-card",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"min-w-0 flex-1",children:[s.jsx("p",{className:"stat-label text-xs sm:text-sm",children:"Incasso"}),s.jsxs("p",{className:"stat-value text-lg sm:text-2xl",children:["€",(A+M).toFixed(2)]})]}),s.jsx("div",{className:"w-8 h-8 sm:w-12 sm:h-12 rounded-xl bg-primary-500/20 flex items-center justify-center flex-shrink-0",children:s.jsx(D,{className:"w-4 h-4 sm:w-6 sm:h-6 text-primary-400"})})]})})]}),s.jsxs("div",{className:"flex items-center gap-2 overflow-x-auto -mx-4 px-4 sm:mx-0 sm:px-0",children:[s.jsxs("button",{onClick:()=>C("all"),className:`px-3 sm:px-4 py-1.5 sm:py-2 rounded-xl font-medium transition-all text-xs sm:text-sm whitespace-nowrap ${g==="all"?"bg-primary-500 text-dark-900":"bg-dark-800 text-dark-300 hover:bg-dark-700"}`,children:["Tutti (",d.length,")"]}),s.jsx("button",{onClick:()=>C("passed"),className:`px-3 sm:px-4 py-1.5 sm:py-2 rounded-xl font-medium transition-all text-xs sm:text-sm whitespace-nowrap ${g==="passed"?"bg-emerald-500 text-white":"bg-dark-800 text-dark-300 hover:bg-dark-700"}`,children:s.jsxs("span",{className:"flex items-center gap-1 sm:gap-2",children:[s.jsx(k,{className:"w-3 h-3 sm:w-4 sm:h-4"}),"Passata (",E,")"]})}),s.jsx("button",{onClick:()=>C("not_passed"),className:`px-3 sm:px-4 py-1.5 sm:py-2 rounded-xl font-medium transition-all text-xs sm:text-sm whitespace-nowrap ${g==="not_passed"?"bg-amber-500 text-dark-900":"bg-dark-800 text-dark-300 hover:bg-dark-700"}`,children:s.jsxs("span",{className:"flex items-center gap-1 sm:gap-2",children:[s.jsx(S,{className:"w-3 h-3 sm:w-4 sm:h-4"}),"Non Passata (",f,")"]})})]}),s.jsxs("div",{className:"card",children:[s.jsx("div",{className:"card-header",children:s.jsx("h2",{className:"font-semibold text-white text-sm sm:text-base",children:"Ordini del Giorno"})}),s.jsx("div",{className:"divide-y divide-dark-700",children:P.length===0?s.jsxs("div",{className:"p-6 sm:p-8 text-center text-dark-400",children:[s.jsx(is,{className:"w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-3 opacity-50"}),s.jsx("p",{className:"text-sm sm:text-base",children:"Nessun ordine trovato per questa data"})]}):P.map(e=>{const r=e.type==="session"&&e.orders.length>1,i=r&&R.has(e.sessionId),a=e.orders[0];return s.jsxs("div",{children:[s.jsxs("div",{className:`flex items-center justify-between p-3 sm:p-4 hover:bg-dark-900/50 transition-colors gap-2 ${r?"cursor-pointer":""}`,onClick:r?()=>V(e.sessionId):void 0,children:[s.jsxs("div",{className:"flex items-center gap-2 sm:gap-4 min-w-0 flex-1",children:[s.jsxs("div",{className:"flex items-center gap-1 sm:gap-2 flex-shrink-0",children:[s.jsx("div",{className:"w-5 sm:w-6 flex items-center justify-center",children:r?i?s.jsx(es,{className:"w-4 h-4 sm:w-5 sm:h-5 text-dark-400"}):s.jsx(as,{className:"w-4 h-4 sm:w-5 sm:h-5 text-dark-400"}):null}),s.jsx("div",{className:`w-8 h-8 sm:w-12 sm:h-12 rounded-xl flex items-center justify-center ${e.smacPassed===!0?"bg-emerald-500/20":e.smacPassed==="partial"?"bg-blue-500/20":"bg-amber-500/20"}`,children:e.smacPassed===!0?s.jsx(k,{className:"w-4 h-4 sm:w-6 sm:h-6 text-emerald-400"}):e.smacPassed==="partial"?s.jsx(S,{className:"w-4 h-4 sm:w-6 sm:h-6 text-blue-400"}):s.jsx(S,{className:"w-4 h-4 sm:w-6 sm:h-6 text-amber-400"})})]}),s.jsxs("div",{className:"min-w-0 flex-1",children:[s.jsx("div",{className:"font-semibold text-white text-sm sm:text-base",children:r?s.jsxs(s.Fragment,{children:[s.jsxs("span",{className:"whitespace-nowrap",children:["Conto - ",e.tableName]}),s.jsxs("span",{className:"block sm:inline text-xs text-dark-400 sm:ml-2",children:[e.payments.length>0&&`(${e.payments.length} pag.) `,"(",e.orders.length," com.)"]})]}):`#${a.id}`}),s.jsxs("div",{className:"flex flex-wrap items-center gap-1 sm:gap-3 text-xs sm:text-sm text-dark-400",children:[s.jsx("span",{children:a.order_type==="dine_in"?`T.${e.tableName||a.table_id}`:a.order_type==="takeaway"?"Asporto":"Domicilio"}),s.jsx("span",{className:"hidden sm:inline",children:"•"}),s.jsx("span",{className:"hidden sm:inline",children:a.payment_method==="cash"?"Contanti":a.payment_method==="card"?"Carta":"Online"})]})]})]}),s.jsxs("div",{className:"flex items-center gap-2 sm:gap-4 flex-shrink-0",children:[s.jsxs("div",{className:"text-right",children:[s.jsxs("p",{className:"text-base sm:text-xl font-bold text-primary-400",children:["€",e.total.toFixed(2)]}),s.jsx("p",{className:`text-xs sm:text-sm ${e.smacPassed===!0?"text-emerald-400":e.smacPassed==="partial"?"text-blue-400":"text-amber-400"}`,children:e.smacPassed===!0?"Passata":e.smacPassed==="partial"?s.jsxs(s.Fragment,{children:[s.jsxs("span",{className:"block",children:["Parziale (€",e.smacAmount.toFixed(2),")"]}),s.jsxs("span",{className:"block sm:inline",children:["Manc. €",(e.total-e.smacAmount).toFixed(2)]})]}):"Non Passata"})]}),s.jsx("button",{onClick:t=>{t.stopPropagation(),e.payments.length>0?q(e):G(e)},className:`p-2 sm:p-3 rounded-xl transition-all ${e.smacPassed===!0?"bg-emerald-500 text-white hover:bg-emerald-600":"bg-dark-700 text-dark-300 hover:bg-amber-500 hover:text-dark-900"}`,title:e.smacPassed===!0?"Rimuovi SMAC":"Segna come SMAC passata",children:s.jsx(Y,{className:"w-4 h-4 sm:w-5 sm:h-5"})})]})]}),r&&i&&s.jsx("div",{className:"bg-dark-900/30 border-t border-dark-700",children:e.payments.length>0?e.payments.map(t=>s.jsxs("div",{className:"flex items-center justify-between px-3 sm:px-4 py-2 sm:py-3 pl-10 sm:pl-20 border-b border-dark-800 last:border-b-0",children:[s.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[s.jsx("span",{className:"text-dark-500",children:"└"}),s.jsxs("div",{children:[s.jsxs("p",{className:"text-xs sm:text-sm text-white font-medium",children:["€",t.amount.toFixed(2),t.notes&&s.jsxs("span",{className:"text-dark-400 ml-2 font-normal",children:["(",t.notes,")"]})]}),s.jsxs("p",{className:"text-xs text-dark-500",children:[t.payment_method==="cash"?"Contanti":t.payment_method==="card"?"Carta":"Online"," • ",new Date(t.paid_at).toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})]})]})]}),s.jsxs("button",{onClick:n=>{n.stopPropagation(),J(t,e.sessionId)},className:`flex items-center gap-1 text-xs px-2 py-1 rounded transition-all ${t.smac_passed?"bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500/40":"bg-red-500/20 text-red-400 hover:bg-red-500/40"}`,title:t.smac_passed?"Rimuovi SMAC":"Segna come SMAC passata",children:["SMAC ",t.smac_passed?"✓":"✗"]})]},t.id)):e.orders.map(t=>s.jsxs("div",{className:"flex items-center justify-between px-3 sm:px-4 py-2 sm:py-3 pl-10 sm:pl-20 border-b border-dark-800 last:border-b-0",children:[s.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[s.jsx("span",{className:"text-dark-500",children:"└"}),s.jsxs("div",{children:[s.jsxs("p",{className:"text-xs sm:text-sm text-dark-300",children:["Comanda ",t.order_number||1]}),s.jsx("p",{className:"text-xs text-dark-500",children:new Date(t.created_at).toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})})]})]}),s.jsxs("p",{className:"text-xs sm:text-sm font-medium text-dark-300",children:["€",t.total.toFixed(2)]})]},t.id))})]},e.type==="session"?`session-${e.sessionId}`:`order-${a.id}`)})})]}),s.jsxs("div",{className:"bg-blue-500/10 border border-blue-500/30 rounded-xl p-3 sm:p-4",children:[s.jsx("h3",{className:"font-semibold text-blue-400 mb-2 text-sm sm:text-base",children:"Cos'è la SMAC?"}),s.jsxs("p",{className:"text-xs sm:text-sm text-dark-300",children:["La ",s.jsx("strong",{children:"SMAC"})," (Carta Servizi) è il sistema di San Marino per la tracciabilità delle transazioni commerciali. Quando un cliente presenta la sua carta SMAC al momento del pagamento, l'importo viene registrato per beneficiare di detrazioni fiscali."]})]})]})}export{ds as Smac};
