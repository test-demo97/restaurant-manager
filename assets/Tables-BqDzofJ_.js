import{j as e,M as w,f as ke,O as Ps,N as Ts,l as kt,k as St,i as _t,r,p as fs,ai as gs,q as Ge,t as c,aj as Qe,P as Pt,U as we,J as Le,e as Tt,ak as bs,K as Mt,X as js,al as vs,am as Ns,an as zt,ao as Et,ap as At,aq as Rt,y as Ft,A as Ot,B as ys,a2 as qe,a3 as Be,a4 as Ue,a5 as Ve,x as ws,Q as Cs,s as It,ar as $t,ab as Dt,ac as Gt}from"./index-DlwzvMJs.js";import{B as oe}from"./banknote-CISDn-gD.js";import{P as Se}from"./printer-Bp5hlnmn.js";import{L as Qt,S as Lt,a as qt,b as Bt}from"./SessionDetailsModal-n8HBYYV4.js";import{u as Ut}from"./useCurrency-BeQWT6-C.js";import{u as Vt}from"./useDemoGuard-DvQLN8mP.js";import{C as We}from"./calendar-CLndiYrK.js";import{F as ks}from"./file-text-DyR65ehk.js";import{C as Ss}from"./clock-Be8V2WBc.js";import{L as Ce}from"./link-2-zExL_Gn8.js";import{M as Wt}from"./message-square-BNimbRBY.js";import{G as _s}from"./globe-CqaEG_LP.js";function Jt(G){const{isOpen:_e,onClose:ce,session:E,sessionPayments:T,remainingAmount:C,remainingSessionItems:J,sessionCovers:M,sessionCoverUnitPrice:A,splitMode:O,setSplitMode:K,coverSelectedCount:p,onChangeCoverSelectedCount:X,selectedItems:de,onIncrementItem:Q,onDecrementItem:me,onApplyItemsSelection:k,splitPaymentForm:R,onChangeSplitPaymentForm:y,changeCalculator:xe,onChangeChangeCalculator:H,onAddSplitPayment:l,calculateSelectedItemsTotal:Pe,calculateSplitChange:Te,smacEnabled:he,onPrintPaymentReceipt:L,formatPrice:Y}=G,u=Y||(o=>o.toFixed(2));return e.jsx(w,{isOpen:_e,onClose:ce,title:"Dividi Conto",size:"2xl",children:E&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 bg-dark-900 rounded-xl",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-3",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-dark-400",children:"Totale"}),e.jsx("p",{className:"text-base lg:text-lg font-bold text-white",children:u(E.total+(p>0?p*A:0))})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-dark-400",children:"Pagato"}),e.jsx("p",{className:"text-base lg:text-lg font-bold text-emerald-400",children:u((T||[]).reduce((o,g)=>o+(g.amount||0),0)+(p>0,0))})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-dark-400",children:"Rimanente"}),e.jsx("p",{className:"text-base lg:text-lg font-bold text-primary-400",children:u(E.total+(p>0?p*A:0)-(T||[]).reduce((o,g)=>o+(g.amount||0),0))})]})]}),E.total>0&&e.jsx("div",{className:"w-full bg-dark-700 rounded-full h-2",children:e.jsx("div",{className:"bg-gradient-to-r from-emerald-500 to-emerald-400 h-2 rounded-full transition-all duration-500",style:{width:`${Math.min(100,(E.total-C)/E.total*100)}%`}})})]}),e.jsxs("div",{className:"md:grid md:grid-cols-2 md:gap-4",children:[e.jsx("div",{children:T.length>0?e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-dark-400 mb-2",children:"Pagamenti effettuati"}),e.jsx("div",{className:"space-y-2 max-h-40 lg:max-h-64 overflow-y-auto",children:T.map(o=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-dark-900 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[o.payment_method==="cash"&&e.jsx(oe,{className:"w-4 h-4 text-emerald-400"}),o.payment_method==="card"&&e.jsx(ke,{className:"w-4 h-4 text-blue-400"}),o.payment_method==="online"&&e.jsx(Se,{className:"w-4 h-4 text-purple-400"}),e.jsx("span",{className:"text-white text-sm",children:u(o.amount)}),o.notes&&e.jsxs("span",{className:"text-dark-400 text-xs",children:["- ",o.notes]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[he&&o.smac_passed&&e.jsx("span",{className:"text-[10px] bg-primary-500/20 text-primary-400 px-1.5 py-0.5 rounded-full",children:"SMAC"}),e.jsx("button",{onClick:()=>L(o),className:"p-1 hover:bg-dark-700 rounded transition-colors",title:"Stampa scontrino",children:e.jsx(Se,{className:"w-3.5 h-3.5 text-dark-400"})})]})]},o.id))})]}):e.jsx("div",{className:"p-4 bg-dark-900 rounded-xl text-center text-dark-500 text-sm",children:"Nessun pagamento ancora effettuato"})}),e.jsxs("div",{className:"mt-4 md:mt-0",children:[C>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsxs("button",{onClick:()=>K("manual"),className:`flex-1 p-2 lg:p-3 rounded-xl border-2 flex flex-col items-center gap-1 transition-all ${O==="manual"?"border-primary-500 bg-primary-500/10":"border-dark-700 hover:border-dark-600"}`,children:[e.jsx(oe,{className:"w-4 h-4 lg:w-5 lg:h-5"}),e.jsx("span",{className:"text-xs lg:text-sm font-medium",children:"Manuale"})]}),e.jsxs("button",{onClick:()=>K("items"),className:`flex-1 p-2 lg:p-3 rounded-xl border-2 flex flex-col items-center gap-1 transition-all ${O==="items"?"border-primary-500 bg-primary-500/10":"border-dark-700 hover:border-dark-600"}`,children:[e.jsx(Qt,{className:"w-4 h-4 lg:w-5 lg:h-5"}),e.jsx("span",{className:"text-xs lg:text-sm font-medium",children:"Per Prodotto"})]})]}),O==="items"&&e.jsxs("div",{className:"p-4 border border-blue-500/30 bg-blue-500/5 rounded-xl space-y-4",children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Seleziona quanti pezzi di ogni prodotto pagare."}),e.jsx("div",{className:"max-h-48 overflow-y-auto space-y-2",children:J.length===0?e.jsx("p",{className:"text-center text-dark-500 py-4",children:"Tutti i prodotti sono stati pagati"}):J.map(o=>{const g=Number(o.id||0),z=de[g]||0,I=z>0;return e.jsxs("div",{className:`p-3 rounded-lg border-2 ${I?"border-blue-500 bg-blue-500/10":"border-dark-700"}`,children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-white font-medium truncate",children:o.menu_item_name}),e.jsxs("p",{className:"text-xs text-dark-400",children:[u(o.price??0)," • ",o.remainingQty??0," rimasti"]})]}),e.jsxs("div",{className:"flex items-center gap-1 bg-dark-800 rounded-lg p-1",children:[e.jsx("button",{onClick:()=>me(g),disabled:z===0,className:"w-8 h-8 rounded bg-dark-700 disabled:opacity-30",children:"-"}),e.jsx("span",{className:"w-8 text-center font-bold",children:z}),e.jsx("button",{onClick:()=>Q(g),disabled:z>=(o.remainingQty??0),className:"w-8 h-8 rounded bg-dark-700 disabled:opacity-30",children:"+"})]})]}),I&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-dark-600 flex justify-between items-center",children:[e.jsxs("span",{className:"text-xs text-dark-400",children:[z,"/",o.remainingQty??0," selezionati"]}),e.jsx("span",{className:"text-sm font-semibold text-blue-400",children:u((o.price??0)*z)})]})]},o.id)})}),e.jsxs("div",{className:"space-y-3",children:[M>0&&A>0&&e.jsxs("div",{className:`p-3 rounded-lg border-2 ${p>0?"border-blue-500 bg-blue-500/10":"border-dark-700"}`,children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-white font-medium",children:"Coperto"}),e.jsxs("p",{className:"text-xs text-dark-400",children:[u(A)," • ",M," pers."]})]}),e.jsxs("div",{className:"flex items-center gap-1 bg-dark-800 rounded-lg p-1",children:[e.jsx("button",{onClick:()=>X(Math.max(0,p-1)),disabled:p===0,className:"w-8 h-8 rounded bg-dark-700 disabled:opacity-30",children:"-"}),e.jsx("span",{className:"w-8 text-center font-bold",children:p}),e.jsx("button",{onClick:()=>X(Math.min(M,p+1)),disabled:p>=M,className:"w-8 h-8 rounded bg-dark-700 disabled:opacity-30",children:"+"})]})]}),p>0&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-dark-600 flex justify-between items-center",children:[e.jsxs("span",{className:"text-xs text-dark-400",children:[p,"/",M," selezionati"]}),e.jsx("span",{className:"text-sm font-semibold text-blue-400",children:u(A*p)})]})]},"coperto"),e.jsxs("div",{className:"p-3 bg-dark-900 rounded-lg flex justify-between",children:[e.jsx("span",{children:"Totale:"}),e.jsx("span",{className:"text-blue-400 font-bold",children:u(Pe()+(p>0?p*A:0))})]})]}),e.jsx("button",{onClick:k,disabled:Object.keys(de).length===0&&p===0,className:"btn-primary w-full bg-blue-600 hover:bg-blue-700",children:"Applica Selezione"})]}),O==="manual"&&e.jsxs("div",{className:"space-y-4 p-4 border border-dark-700 rounded-xl",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Importo"}),e.jsx("input",{type:"number",step:"0.01",value:R.amount,onChange:o=>y({amount:o.target.value}),className:"input",placeholder:`Max €${C.toFixed(2)}`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Note"}),e.jsx("input",{type:"text",value:R.notes,onChange:o=>y({notes:o.target.value}),className:"input",placeholder:"Es. Marco"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>y({method:"cash"}),className:`flex-1 p-2 rounded-lg border flex items-center justify-center gap-2 ${R.method==="cash"?"border-primary-500 bg-primary-500/10":"border-dark-700"}`,children:[e.jsx(oe,{className:"w-4 h-4"})," Contanti"]}),e.jsxs("button",{onClick:()=>y({method:"card"}),className:`flex-1 p-2 rounded-lg border flex items-center justify-center gap-2 ${R.method==="card"?"border-primary-500 bg-primary-500/10":"border-dark-700"}`,children:[e.jsx(ke,{className:"w-4 h-4"})," Carta"]})]}),he&&e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-primary-500/5 border border-primary-500/20 rounded-lg",children:[e.jsx("input",{type:"checkbox",id:"split_smac_comp",checked:R.smac,onChange:o=>y({smac:o.target.checked}),className:"w-5 h-5"}),e.jsx("label",{htmlFor:"split_smac_comp",className:"text-white",children:"SMAC passato"})]}),R.method==="cash"&&R.amount&&e.jsxs("div",{className:"p-3 bg-emerald-500/10 border border-emerald-500/30 rounded-xl space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ps,{className:"w-4 h-4 text-emerald-400"}),e.jsx("span",{className:"font-medium text-emerald-400",children:"Calcolatore Resto"})]}),e.jsx("input",{type:"number",value:xe.customerGives,onChange:o=>H({customerGives:o.target.value}),className:"input",placeholder:"Cliente dà €..."}),xe.customerGives&&e.jsxs("div",{className:"p-3 bg-dark-900 rounded-lg flex justify-between",children:[e.jsx("span",{className:"text-emerald-400 font-semibold",children:"RESTO:"}),e.jsx("span",{className:"text-2xl font-bold text-emerald-400",children:u(Te())})]})]}),e.jsx("button",{onClick:l,className:"btn-primary w-full",children:"Aggiungi Pagamento"})]})]}),C===0&&e.jsxs("div",{className:"p-4 bg-emerald-500/10 border border-emerald-500/30 rounded-xl text-center",children:[e.jsx(Ts,{className:"w-10 h-10 mx-auto mb-2 text-emerald-400"}),e.jsx("h4",{className:"text-lg font-bold text-emerald-400",children:"Conto Saldato!"}),e.jsx("p",{className:"text-dark-400 text-sm",children:"Il conto è stato completamente pagato."})]})]})]}),e.jsx("div",{className:"pt-2",children:e.jsx("button",{onClick:ce,className:"btn-secondary w-full",children:"Chiudi"})})]})})}function oa(){const{formatPrice:G}=Ut(),_e=kt(),{isDemo:ce}=Vt(),{user:E}=St(),{smacEnabled:T}=_t(),[C,J]=r.useState([]),[M,A]=r.useState([]),[O,K]=r.useState([]),[p,X]=r.useState(!0),[de,Q]=r.useState(!1),[me,k]=r.useState(!1),[R,y]=r.useState(!1),[xe,H]=r.useState(!1),[l,Pe]=r.useState(null),[Te,he]=r.useState([]),[L,Y]=r.useState([]),[u,o]=r.useState(0),[g,z]=r.useState([]),[I,Ms]=r.useState(0),[q,zs]=r.useState(0),[Je,Es]=r.useState(!1),[As,Me]=r.useState("manual"),[B,pe]=r.useState({paymentMethod:"cash",amount:"",change:0,notes:"",smac:!1}),[S,Z]=r.useState({paymentMethod:"cash",amount:"",change:0,customerGives:"",showChange:!1}),[Ke,Rs]=r.useState(0),[Fs,Xe]=r.useState(!1),[He,Ye]=r.useState([]),[$,ue]=r.useState({name:"",capacity:1}),[i,_]=r.useState({customer_name:"",phone:"",date:"",time:"",guests:1,notes:"",table_ids:[]}),[fe,ge]=r.useState(null),[U,ze]=r.useState(null),[Ee,Os]=r.useState(null),[P,ee]=r.useState({covers:"2",customer_name:"",customer_phone:""}),[b,se]=r.useState({method:"cash",smac:!1}),[Ze,Is]=r.useState(null),[es,ss]=r.useState(!1),[$s,ts]=r.useState(!1),[Ds,te]=r.useState(!1),[Gs,be]=r.useState(!1),[Qs,Ae]=r.useState(!1),[Ls,Re]=r.useState(!1),[d,qs]=r.useState(null),[Bs,as]=r.useState([]),[je,ae]=r.useState({}),[j,ne]=r.useState(0),[F,Us]=r.useState(new Date().toISOString().split("T")[0]),[Vs,ve]=r.useState(!1),[Ws,Ne]=r.useState(!1),[x,ns]=r.useState(null),[Js,Fe]=r.useState(!1),[rs,ls]=r.useState([]),[Ks,V]=r.useState(!1),[Xs,re]=r.useState([]),[is,Oe]=r.useState(null),[Ie,$e]=r.useState(null);r.useEffect(()=>{v()},[F]),r.useEffect(()=>{const s=()=>{(async()=>{try{const[t,a]=await Promise.all([fs(),gs(F)]);J(t),A(a);const n=await Qe();K(n||[])}catch(t){console.error("Error refreshing tables on update event",t)}})()};return window.addEventListener("orders-updated",s),window.addEventListener("table-sessions-updated",s),window.addEventListener("reservations-updated",s),window.addEventListener("tables-updated",s),window.addEventListener("settings-updated",s),()=>{window.removeEventListener("orders-updated",s),window.removeEventListener("table-sessions-updated",s),window.removeEventListener("reservations-updated",s),window.removeEventListener("tables-updated",s),window.removeEventListener("settings-updated",s)}},[F]);const le=()=>!ce||E&&E.role==="admin",v=async()=>{try{const[s,t,a]=await Promise.all([fs(),gs(F),Ge()]);J(s),A(t),Is(a),ss((a?.cover_charge||0)>0),X(!1)}catch(s){console.error("Error loading data:",s),c("Errore nel caricamento dati","error"),X(!1)}};r.useEffect(()=>{(async()=>{try{const s=await Qe();K(s||[])}catch(s){console.error("Error loading active sessions",s)}})()},[]);function os(s){return M.find(t=>(t.table_ids||[t.table_id]).includes(s))||null}function ie(s){return O.find(n=>n.table_id===s&&n.status==="open")?"occupied":os(s)?"reserved":"available"}function Hs(s){s&&_({...i,table_ids:[s],date:F}),k(!0)}function cs(s){s?(ue({name:s.name,capacity:s.capacity}),ge(s)):(ue({name:"",capacity:1}),ge(null)),ve(!0)}function Ys(){_({...i,date:F}),k(!0)}async function Zs(s){if(window.confirm("Sei sicuro di voler eliminare questo tavolo? Questa azione è irreversibile."))try{await zt(s),await v(),c("Tavolo eliminato","success")}catch(a){console.error(a),c("Errore eliminazione tavolo","error")}}function et(s){const t=i.table_ids||[];t.includes(s)?_({...i,table_ids:t.filter(a=>a!==s)}):_({...i,table_ids:[...t,s]})}async function st(){try{fe?(await At(fe.id,$),c("Tavolo aggiornato","success")):(await Rt({name:$.name,capacity:$.capacity}),c("Tavolo creato","success")),ve(!1),ge(null),await v()}catch(s){console.error(s),c("Errore salvataggio tavolo","error")}}async function tt(){try{const s={table_ids:i.table_ids,table_id:i.table_ids&&i.table_ids.length>0?i.table_ids[0]:0,date:i.date,time:i.time,customer_name:i.customer_name,phone:i.phone,guests:i.guests,notes:i.notes,status:"confirmed"};await vs(s),k(!1),await v(),c("Prenotazione creata","success")}catch(s){console.error(s);const t=s;t&&t.conflicts&&Array.isArray(t.conflicts)&&t.conflicts.length>0?(re(t.conflicts),Oe({table_ids:i.table_ids,table_id:i.table_ids&&i.table_ids.length>0?i.table_ids[0]:0,date:i.date,time:i.time,customer_name:i.customer_name,phone:i.phone,guests:i.guests,notes:i.notes,status:"confirmed"}),V(!0)):c("Errore creazione prenotazione","error")}}async function at(){try{if(!U)return;await Ns(U.id,i),k(!1),await v(),c("Prenotazione aggiornata","success")}catch(s){console.error(s);const t=s;t&&t.conflicts&&Array.isArray(t.conflicts)&&t.conflicts.length>0?(re(t.conflicts),$e({id:U.id,updates:i}),V(!0)):c("Errore aggiornamento prenotazione","error")}}function nt(s){ns(s),Ne(!0)}function rt(s){const t=M.filter(a=>(a.table_ids||[a.table_id]).includes(s));ls(t),Fe(!0)}function ds(s){ze(s),_({customer_name:s.customer_name||"",phone:s.phone||"",date:s.date||F,time:s.time||"",guests:s.guests||1,notes:s.notes||"",table_ids:s.table_ids||(s.table_id?[s.table_id]:[])}),k(!0)}async function De(s){try{await Et(s),await v(),c("Prenotazione cancellata","success")}catch(t){console.error(t),c("Errore cancellazione prenotazione","error")}}const lt=async s=>{try{await ys(s.id);const[t,a,n]=await Promise.all([ws(s.id),Be(s.id),Ue(s.id)]),h=(await Qe()).find(m=>m.id===s.id);Pe(h||s),he(t),Y(a),o(n),y(!0)}catch(t){console.error("Error loading session details:",t),c("Errore nel caricamento dettagli","error")}};function it(){try{const s=i.table_ids||[];return C.filter(t=>s.includes(t.id)).reduce((t,a)=>t+(a.capacity||0),0)}catch{return 0}}async function ot(){if(le()&&Ee)try{const s=await Ft(Ee,parseInt(P.covers)||1,P.customer_name||void 0,P.customer_phone||void 0);try{s&&s.id&&await Ot({date:new Date().toISOString().split("T")[0],total:0,payment_method:"cash",order_type:"dine_in",table_id:Ee,notes:"Conto creato all'apertura sessione",status:"pending",smac_passed:!1,customer_name:P.customer_name||s.customer_name||"",customer_phone:P.customer_phone||s.customer_phone||"",created_by:"session-placeholder",session_id:s.id,order_number:1},[])}catch(t){console.error("Error creating placeholder order for new session:",t)}if(es&&s&&s.id)try{await ys(s.id,!0)}catch(t){console.error("Error applying cover on new session:",t)}c("Conto aperto","success"),Q(!1),v()}catch(s){console.error("Error opening session:",s),c("Errore nell'apertura conto","error")}}function ct(){l&&_e(`/orders/new?table=${l.table_id}&session=${l.id}`)}async function dt(){if(!le()||!l)return;if((l?.total??0)===0){if(window.confirm("Vuoi chiudere questo conto a €0.00?"))try{await qe(l.id,"cash",!1,!1),c("Conto chiuso","success"),y(!1),v()}catch(n){console.error("Error closing session:",n),c("Errore nella chiusura","error")}return}const t=(await Ge()).cover_charge||0;if(t>0&&(l?.covers??0)>0){const a=t*(l?.covers??0);Rs(a);const n=!!Je;Xe(n),ye(n)}else ye(!1)}function ye(s){Xe(s),ts(!1),se({method:"cash",smac:!1}),Z(t=>({...t,customerGives:"",showChange:!1})),te(!0)}async function ms(){if(le()&&l)try{await qe(l.id,b.method,b.smac,Fs),c("Conto chiuso","success"),te(!1),y(!1),v()}catch(s){console.error("Error closing session:",s),c("Errore nella chiusura","error")}}function mt(){l&&be(!0)}async function xt(s){if(le()&&l)try{await $t(l.id,s),c("Tavolo trasferito","success"),be(!1),y(!1),v()}catch(t){console.error("Error transferring table:",t),c("Errore nel trasferimento","error")}}async function ht(){if(l){pe(s=>({...s,amount:"",method:"cash",notes:"",smac:!1})),Me("manual"),ae({}),Z(s=>({...s,customerGives:"",showChange:!1}));try{const s=[];for(const n of Te)(await Cs(n.id)).forEach(h=>{s.push({...h,order_number:n.order_number||1})});as(s);const t=await Ve(l.id),a=s.map(n=>({...n,remainingQty:n.quantity-(t[n.id]||0)})).filter(n=>n.remainingQty>0);z(a)}catch(s){console.error("Error loading items:",s)}ne(0),H(!0)}}function pt(){const s=parseFloat(S.customerGives)||0,t=parseFloat(B.amount)||0;return Math.max(0,s-t)}function xs(){return Object.entries(je).reduce((s,[t,a])=>{const n=g.find(f=>f.id===Number(t));return n&&a>0?s+n.price*a:s},0)}function ut(s){const t=g.find(a=>a.id===s);t&&ae(a=>{const n=a[s]||0;return n<t.remainingQty?{...a,[s]:n+1}:a})}function ft(s){ae(t=>{const a=t[s]||0;if(a>0){const n=a-1;if(n===0){const{[s]:f,...h}=t;return h}return{...t,[s]:n}}return t})}function gt(s){const t=g.find(a=>a.id===s);t&&ae(a=>{if((a[s]||0)===t.remainingQty){const{[s]:f,...h}=a;return h}else return{...a,[s]:t.remainingQty}})}function bt(){const s=xs(),t=j>0&&I>0?q*j:0,a=s+t;if(a>0&&a<=u+.01){const n=Object.entries(je).map(([m,W])=>{const N=g.find(D=>D.id===Number(m));return N?`${W}x ${N.menu_item_name}`:""}).filter(Boolean);j>0&&n.push(`${j}x Coperto`);const f=n.join(", "),h=Object.entries(je).map(([m,W])=>{const N=g.find(D=>D.id===Number(m));return N?{order_item_id:N.id,quantity:W,menu_item_name:N.menu_item_name,price:N.price}:null}).filter(m=>m!==null);j>0&&h.push({order_item_id:void 0,quantity:j,menu_item_name:"Coperto",price:q}),Ye(h),pe(m=>({...m,amount:Math.min(a,u).toFixed(2),notes:f.length>40?f.substring(0,40)+"...":f})),Me("manual"),ae({}),ne(0)}}async function jt(){if(!le())return;if(!l){c("Sessione non trovata","error");return}const s=parseFloat(B.amount);if(isNaN(s)||s<=0){c("Inserisci un importo valido","warning");return}if(s>u+.01){c("Importo superiore al rimanente","warning");return}try{await Gt(l.id,s,B.method??"cash",B.notes||void 0,B.smac,He.length>0?He:void 0);const[t,a,n]=await Promise.all([Be(l.id),Ue(l.id),Ve(l.id)]);Y(t),o(a);const f=Bs.map(h=>({...h,remainingQty:h.quantity-(n[h.id]||0)})).filter(h=>h.remainingQty>0);if(z(f),pe(h=>({...h,amount:"",method:"cash",notes:"",smac:!1})),Ye([]),c("Pagamento aggiunto","success"),a<=.01)try{await qe(l.id,"split",!1),c("Conto saldato e chiuso","success"),H(!1),y(!1),v()}catch(h){console.error("Error closing session:",h),c("Pagamento aggiunto, ma errore nella chiusura automatica","warning")}}catch(t){console.error("Error adding payment:",t),c("Errore nell'aggiunta pagamento","error")}}async function vt(){if(l)try{const[s,t,a]=await Promise.all([Be(l.id),Ue(l.id),Ve(l.id)]),n=await ws(l.id),f=[];for(const m of n)(await Cs(m.id)).forEach(N=>{f.push({...N,order_number:m.order_number||1})});const h=f.map(m=>({...m,remainingQty:m.quantity-(a[m.id]||0)})).filter(m=>m.remainingQty>0);try{const m=await It(l.id),W=await Ge(),N=m?.covers||0,D=W.cover_charge||0,us=n.reduce((wt,Ct)=>wt+Ct.total,0)+D*N,yt=Math.abs((m?.total||0)-us)<.01||(m?.total||0)>=us-.01;Ms(N),zs(D),Es(yt&&D>0&&N>0)}catch(m){console.error("Error loading session info for bill status modal (tables):",m)}as(f),Y(s),o(t),z(h),Ae(!0)}catch(s){console.error("Error loading bill status (tables):",s),c("Errore nel caricamento stato conto","error")}}async function hs(s){try{const t=await Dt(s);t&&(qs(t),Re(!0))}catch(t){console.error("Error generating receipt:",t),c("Errore nella generazione scontrino","error")}}function Nt(){if(!d)return;const s=`
      <html>
        <head>
          <title>Scontrino</title>
          <style>
            body { font-family: 'Courier New', monospace; padding: 20px; max-width: 300px; margin: 0 auto; }
            .header { text-align: center; margin-bottom: 20px; }
            .shop-name { font-size: 18px; font-weight: bold; }
            .divider { border-top: 1px dashed #000; margin: 10px 0; }
            .item { display: flex; justify-content: space-between; margin: 5px 0; }
            .total { font-weight: bold; font-size: 16px; }
            .footer { text-align: center; margin-top: 20px; font-size: 12px; }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="shop-name">${d?.shop_info?.name??""}</div>
            ${d?.shop_info?.address?`<div>${d.shop_info.address}</div>`:""}
            ${d?.shop_info?.phone?`<div>Tel: ${d.shop_info.phone}</div>`:""}
          </div>
          <div class="divider"></div>
          <div>Data: ${d?.date??""} ${d?.time??""}</div>
          <div class="divider"></div>
          ${(d?.items||[]).map(a=>`
            <div class="item">
              <span>${a.quantity}x ${a.name}</span>
              <span>€${a.total.toFixed(2)}</span>
            </div>
          `).join("")}
          <div class="divider"></div>
          <div class="item total">
            <span>TOTALE</span>
            <span>€${(d?.total??0).toFixed(2)}</span>
          </div>
          <div>Pagamento: ${d?.payment_method==="cash"?"Contanti":d?.payment_method==="card"?"Carta":"Online"}</div>
          ${T&&d?.smac_passed?"<div>SMAC: Sì</div>":""}
          <div class="divider"></div>
          <div class="footer">Grazie e arrivederci!</div>
        </body>
      </html>
    `,t=window.open("","_blank");t&&(t.document.write(s),t.document.close(),t.print())}if(p)return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-500"})});const ps=s=>{const t=ie(s),a=O.find(f=>f.table_id===s)||null,n=os(s);t==="occupied"?a&&lt(a):(t==="available"||t==="reserved")&&(Os(s),ee(n?{covers:n.guests?.toString()||"2",customer_name:n.customer_name||"",customer_phone:n.phone||""}:{covers:"2",customer_name:"",customer_phone:""}),Q(!0))};return e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-white",children:"Tavoli e Prenotazioni"}),e.jsx("p",{className:"text-dark-400 mt-1 text-sm sm:text-base",children:"Gestisci tavoli e prenotazioni"})]}),e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[e.jsxs("button",{onClick:()=>Ys(),className:"btn-secondary flex-1 sm:flex-none",children:[e.jsx(We,{className:"w-4 h-4 sm:w-5 sm:h-5"}),e.jsx("span",{className:"text-sm sm:text-base",children:"Prenotazione"})]}),e.jsxs("button",{onClick:()=>cs(),className:"btn-primary flex-1 sm:flex-none",children:[e.jsx(Pt,{className:"w-4 h-4 sm:w-5 sm:h-5"}),e.jsx("span",{className:"text-sm sm:text-base",children:"Tavolo"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 sm:gap-4",children:[e.jsx(We,{className:"w-4 h-4 sm:w-5 sm:h-5 text-dark-400"}),e.jsx("input",{type:"date",value:F,onChange:s=>Us(s.target.value),className:"input w-auto text-sm sm:text-base"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 sm:gap-6",children:[e.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2",children:[e.jsx("div",{className:"w-3 h-3 sm:w-4 sm:h-4 rounded bg-emerald-500"}),e.jsx("span",{className:"text-xs sm:text-sm text-dark-300",children:"Disponibile"})]}),e.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2",children:[e.jsx("div",{className:"w-3 h-3 sm:w-4 sm:h-4 rounded bg-red-500"}),e.jsx("span",{className:"text-xs sm:text-sm text-dark-300",children:"Occupato"})]}),e.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2",children:[e.jsx("div",{className:"w-3 h-3 sm:w-4 sm:h-4 rounded bg-amber-500"}),e.jsx("span",{className:"text-xs sm:text-sm text-dark-300",children:"Prenotato"})]})]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-6 gap-1 sm:gap-3",children:C.map(s=>{const t=ie(s.id),a=O.find(n=>n.table_id===s.id);return e.jsxs("div",{onClick:()=>ps(s.id),className:`
                group relative
                ${t==="available"?"table-available cursor-pointer hover:scale-105":""}
                ${t==="occupied"?"table-occupied cursor-pointer hover:scale-105":""}
                ${t==="reserved"?"table-reserved cursor-pointer hover:scale-105":""}
                  transform scale-90 pt-6 sm:pt-8 p-2 sm:p-3 transition-transform flex flex-col justify-between min-h-[110px]
              `,children:[e.jsx("h3",{className:"text-base sm:text-lg font-bold text-center w-full mt-8 sm:mt-10",children:s.name}),e.jsxs("div",{className:"flex items-center justify-center gap-1 mt-1",children:[e.jsx(we,{className:"w-3 h-3 sm:w-4 sm:h-4"}),e.jsx("span",{className:"text-xs sm:text-sm",children:s.capacity})]}),a&&e.jsxs("div",{className:"mt-2 text-[10px] sm:text-xs space-y-1 text-center",children:[e.jsxs("p",{className:"flex items-center justify-center gap-1",children:[e.jsx(we,{className:"w-3 h-3"}),a.covers," coperti"]}),e.jsxs("p",{className:"font-semibold text-base sm:text-lg",children:["€",a.total.toFixed(2)]})]}),(t==="available"||t==="reserved")&&e.jsxs("div",{className:"mt-2 sm:mt-3 space-y-1",children:[e.jsx("button",{onClick:n=>{n.stopPropagation(),ps(s.id)},className:"text-[10px] sm:text-xs font-medium text-emerald-400 hover:text-emerald-300",children:"Apri Conto"}),e.jsx("button",{onClick:n=>{n.stopPropagation(),Hs(s.id)},className:"block text-[10px] sm:text-xs underline hover:no-underline",children:"Prenota"})]}),e.jsxs("div",{className:"absolute top-1 right-1 sm:top-2 sm:right-2 flex gap-2 transition-colors",children:[e.jsx("button",{onClick:n=>{n.stopPropagation(),rt(s.id)},className:"p-2 bg-dark-800 rounded hover:bg-dark-700",title:"Visualizza prenotazioni",children:e.jsx(ks,{className:"w-4 h-4 sm:w-5 sm:h-5"})}),e.jsx("button",{onClick:n=>{n.stopPropagation(),cs(s)},className:"p-2 bg-dark-800 rounded hover:bg-dark-700",title:"Modifica tavolo",children:e.jsx(Le,{className:"w-4 h-4 sm:w-5 sm:h-5"})}),e.jsx("button",{onClick:n=>{n.stopPropagation(),Zs(s.id)},className:"p-2 bg-dark-800 rounded hover:bg-red-500/20",title:"Elimina tavolo",children:e.jsx(Tt,{className:"w-4 h-4 sm:w-5 sm:h-5"})})]})]},s.id)})}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("h2",{className:"font-semibold text-white text-sm sm:text-base",children:["Prenotazioni per ",new Date(F).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long"})]})}),e.jsx("div",{className:"card-body",children:M.length===0?e.jsx("p",{className:"text-dark-400 text-center py-4 text-sm",children:"Nessuna prenotazione per questa data"}):e.jsx("div",{className:"space-y-2 sm:space-y-3",children:M.map(s=>e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between p-3 sm:p-4 bg-dark-900 rounded-xl gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 sm:gap-4",children:[e.jsx("div",{className:"w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-primary-500/20 flex items-center justify-center flex-shrink-0",children:e.jsx(Ss,{className:"w-5 h-5 sm:w-6 sm:h-6 text-primary-400"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"font-semibold text-white text-sm sm:text-base truncate",children:s.customer_name}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-2 sm:gap-x-3 gap-y-0.5 text-xs sm:text-sm text-dark-400",children:[e.jsx("span",{children:s.time}),e.jsxs("span",{className:"flex items-center gap-1",children:[s.table_ids&&s.table_ids.length>1&&e.jsx(Ce,{className:"w-3 h-3 text-primary-400"}),s.table_name]}),e.jsxs("span",{children:[s.guests," ospiti"]})]}),s.phone&&e.jsxs("div",{className:"flex items-center gap-1 text-xs sm:text-sm text-dark-400",children:[e.jsx(bs,{className:"w-3 h-3"}),s.phone]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 justify-end",children:[e.jsx("span",{className:`badge text-xs ${s.status==="confirmed"?"badge-success":"badge-danger"}`,children:s.status==="confirmed"?"Confermata":"Annullata"}),e.jsx("button",{onClick:()=>nt(s),className:"p-1.5 sm:p-2 hover:bg-dark-700 rounded-lg transition-colors",title:"Visualizza dettagli",children:e.jsx(Mt,{className:"w-4 h-4 sm:w-5 sm:h-5 text-dark-400"})}),e.jsx("button",{onClick:()=>ds(s),className:"p-1.5 sm:p-2 hover:bg-dark-700 rounded-lg transition-colors",title:"Modifica",children:e.jsx(Le,{className:"w-4 h-4 sm:w-5 sm:h-5 text-dark-400"})}),s.status==="confirmed"&&e.jsx("button",{onClick:()=>De(s.id),className:"p-1.5 sm:p-2 hover:bg-red-500/20 rounded-lg transition-colors",title:"Annulla",children:e.jsx(js,{className:"w-4 h-4 sm:w-5 sm:h-5 text-red-400"})})]})]},s.id))})})]}),e.jsx(w,{isOpen:Vs,onClose:()=>{ve(!1),ge(null)},title:fe?"Modifica Tavolo":"Nuovo Tavolo",size:"sm",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Nome Tavolo"}),e.jsx("input",{type:"text",value:$.name,onChange:s=>ue({...$,name:s.target.value}),className:"input",placeholder:"Es. Tavolo 1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Capacità (posti)"}),e.jsx("input",{type:"number",min:"1",value:$.capacity,onChange:s=>ue({...$,capacity:Number(s.target.value)}),className:"input"})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-4",children:[e.jsx("button",{onClick:st,className:"btn-primary flex-1",children:fe?"Salva":"Crea"}),e.jsx("button",{onClick:()=>ve(!1),className:"btn-secondary",children:"Annulla"})]})]})}),e.jsx(w,{isOpen:me,onClose:()=>{k(!1),ze(null)},title:U?"Modifica Prenotazione":"Nuova Prenotazione",size:"xl",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Data"}),e.jsx("input",{type:"date",value:i.date,onChange:s=>_({...i,date:s.target.value}),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Ora"}),e.jsx("input",{type:"time",value:i.time,onChange:s=>_({...i,time:s.target.value}),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Telefono"}),e.jsx("input",{type:"tel",value:i.phone,onChange:s=>_({...i,phone:s.target.value}),className:"input",placeholder:"+39..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Ospiti"}),e.jsx("input",{type:"number",min:"1",value:i.guests,onChange:s=>_({...i,guests:Number(s.target.value)}),className:"input"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Nome Cliente *"}),e.jsx("input",{type:"text",value:i.customer_name,onChange:s=>_({...i,customer_name:s.target.value}),className:"input",placeholder:"Nome e cognome"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"label mb-0",children:[e.jsx(Ce,{className:"w-4 h-4 inline mr-1"}),"Tavoli"]}),e.jsxs("span",{className:"text-xs text-dark-400",children:["Capacità totale: ",e.jsx("span",{className:"text-primary-400 font-semibold",children:it()})," posti"]})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2 max-h-32 overflow-y-auto p-2 bg-dark-900 rounded-xl",children:C.map(s=>{const t=i.table_ids.includes(s.id),a=ie(s.id),n=a==="available"||me&&(a==="occupied"||a==="reserved");return e.jsxs("button",{type:"button",onClick:()=>n&&et(s.id),disabled:!n,className:`p-3 rounded-lg border-2 text-sm flex items-center gap-2 transition-all ${t?"border-primary-500 bg-primary-500/10 text-white":n?"border-dark-600 text-dark-300 hover:border-dark-500":"border-dark-700 text-dark-500 opacity-50 cursor-not-allowed"}`,children:[t?e.jsx(Lt,{className:"w-4 h-4 text-primary-400 flex-shrink-0"}):e.jsx(qt,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"flex-1 text-left",children:s.name}),e.jsxs("span",{className:"text-xs text-dark-400 flex-shrink-0",children:[s.capacity,"p"]})]},s.id)})}),i.table_ids.length>1&&e.jsxs("p",{className:"text-xs text-primary-400 mt-2 flex items-center gap-1",children:[e.jsx(Ce,{className:"w-3 h-3"}),"Tavoli uniti: ",C.filter(s=>i.table_ids.includes(s.id)).map(s=>s.name).join(" + ")]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Note"}),e.jsx("textarea",{value:i.notes,onChange:s=>_({...i,notes:s.target.value}),className:"input resize-none h-16",placeholder:"Note aggiuntive..."})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-2",children:[e.jsx("button",{onClick:U?at:tt,className:"btn-primary flex-1",children:U?"Salva Modifiche":"Crea Prenotazione"}),e.jsx("button",{onClick:()=>{k(!1),ze(null)},className:"btn-secondary",children:"Annulla"})]})]})}),e.jsx(w,{isOpen:Ws,onClose:()=>Ne(!1),title:"Dettagli Prenotazione",size:"md",children:x&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("span",{className:`badge text-lg px-4 py-2 ${x?.status==="confirmed"?"badge-success":x?.status==="cancelled"?"badge-danger":"badge-secondary"}`,children:x?.status==="confirmed"?"Confermata":x?.status==="cancelled"?"Annullata":"Completata"})}),e.jsx("div",{className:"p-4 bg-dark-900 rounded-xl space-y-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-primary-500/20 flex items-center justify-center",children:e.jsx(we,{className:"w-6 h-6 text-primary-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-white text-lg",children:x?.customer_name}),x?.phone&&e.jsxs("div",{className:"flex items-center gap-1 text-dark-400",children:[e.jsx(bs,{className:"w-4 h-4"}),e.jsx("a",{href:`tel:${x?.phone}`,className:"hover:text-primary-400",children:x?.phone})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-4 bg-dark-900 rounded-xl text-center",children:[e.jsx(We,{className:"w-6 h-6 text-primary-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-dark-400",children:"Data"}),e.jsx("p",{className:"font-semibold text-white",children:new Date(x?.date??"").toLocaleDateString("it-IT",{weekday:"short",day:"numeric",month:"short"})})]}),e.jsxs("div",{className:"p-4 bg-dark-900 rounded-xl text-center",children:[e.jsx(Ss,{className:"w-6 h-6 text-primary-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-dark-400",children:"Ora"}),e.jsx("p",{className:"font-semibold text-white",children:x?.time})]}),e.jsxs("div",{className:"p-4 bg-dark-900 rounded-xl text-center",children:[e.jsx(we,{className:"w-6 h-6 text-primary-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-dark-400",children:"Ospiti"}),e.jsxs("p",{className:"font-semibold text-white",children:[x?.guests," persone"]})]}),e.jsxs("div",{className:"p-4 bg-dark-900 rounded-xl text-center",children:[e.jsx(Ce,{className:"w-6 h-6 text-primary-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-dark-400",children:(x?.table_ids?.length??0)>1?"Tavoli Uniti":"Tavolo"}),e.jsx("p",{className:"font-semibold text-white",children:x?.table_name}),(x?.table_ids?.length??0)>1&&e.jsxs("p",{className:"text-xs text-primary-400 mt-1",children:[x?.table_ids?.length??0," tavoli"]})]})]}),x?.notes&&e.jsxs("div",{className:"p-4 bg-dark-900 rounded-xl",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Wt,{className:"w-4 h-4 text-dark-400"}),e.jsx("p",{className:"text-sm text-dark-400",children:"Note"})]}),e.jsx("p",{className:"text-white",children:x?.notes})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-4",children:[e.jsxs("button",{onClick:()=>x&&ds(x),className:"btn-secondary flex-1",children:[e.jsx(Le,{className:"w-5 h-5"}),"Modifica"]}),x?.status==="confirmed"&&e.jsxs("button",{onClick:()=>{x&&(De(x.id),Ne(!1))},className:"btn-danger",children:[e.jsx(js,{className:"w-5 h-5"}),"Annulla"]})]})]})}),e.jsx(w,{isOpen:Js,onClose:()=>Fe(!1),title:"Prenotazioni tavolo",size:"sm",children:e.jsx("div",{className:"space-y-3 max-h-[60vh] overflow-y-auto",children:rs.length===0?e.jsx("p",{className:"text-dark-400 text-center py-4",children:"Nessuna prenotazione per questo tavolo oggi"}):e.jsx("div",{className:"space-y-2",children:rs.map(s=>e.jsxs("div",{className:"p-2 sm:p-3 bg-dark-900 rounded-xl flex items-center justify-between",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-semibold text-white text-sm truncate",children:s.customer_name}),e.jsxs("p",{className:"text-xs text-dark-400",children:[s.time," • ",s.guests," ospiti"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>{ns(s),Ne(!0),Fe(!1)},className:"btn-secondary py-1 px-2 text-xs",children:"Dettagli"}),e.jsx("button",{onClick:()=>{De(s.id),ls(t=>t.filter(a=>a.id!==s.id))},className:"btn-danger py-1 px-2 text-xs",children:"Annulla"})]})]},s.id))})})}),e.jsx(w,{isOpen:Ks,onClose:()=>V(!1),title:"Conflitto Prenotazioni",size:"md",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-dark-300",children:"Attenzione: ci sono prenotazioni vicine per questo tavolo nelle seguenti fasce orarie. Vuoi procedere comunque?"}),e.jsx("div",{className:"space-y-2",children:Xs.map(s=>e.jsxs("div",{className:"p-3 bg-dark-900 rounded-xl flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-white",children:s.customer_name}),e.jsxs("p",{className:"text-sm text-dark-400",children:[s.date," • ",s.time," • ",s.guests," ospiti"]})]}),e.jsxs("div",{className:"text-sm text-dark-400",children:["Tavoli: ",s.table_names||(s.table_ids||[s.table_id]).join(", ")]})]},s.id))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn-secondary flex-1",onClick:()=>{V(!1),re([]),Oe(null),$e(null)},children:"Annulla"}),e.jsx("button",{className:"btn-primary flex-1",onClick:async()=>{try{is?(await vs(is,{force:!0}),k(!1),V(!1),Oe(null),re([]),await v(),c("Prenotazione creata (forzata)","success")):Ie&&(await Ns(Ie.id,Ie.updates,{force:!0}),k(!1),V(!1),$e(null),re([]),await v(),c("Prenotazione aggiornata (forzata)","success"))}catch(s){console.error("Errore forzando prenotazione:",s),c("Errore durante la conferma forzata","error")}},children:"Conferma e Salva"})]})]})}),e.jsx(w,{isOpen:de,onClose:()=>Q(!1),title:"Apri Conto",size:"sm",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Numero Coperti"}),e.jsx("input",{type:"number",min:"1",value:P.covers,onChange:s=>ee({...P,covers:s.target.value}),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Nome Cliente (opzionale)"}),e.jsx("input",{type:"text",value:P.customer_name,onChange:s=>ee({...P,customer_name:s.target.value}),className:"input",placeholder:"Es. Marco Rossi"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Telefono (opzionale)"}),e.jsx("input",{type:"tel",value:P.customer_phone,onChange:s=>ee({...P,customer_phone:s.target.value}),className:"input",placeholder:"+39..."})]}),(Ze?.cover_charge||0)>0&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{id:"open_session_apply_cover_tables",type:"checkbox",checked:es,onChange:s=>ss(s.target.checked),className:"w-5 h-5"}),e.jsxs("label",{htmlFor:"open_session_apply_cover_tables",className:"text-white text-sm",children:["Applica coperto (",G(Ze?.cover_charge??0)," / ospite)"]})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-4",children:[e.jsx("button",{onClick:ot,className:"btn-primary flex-1",children:"Apri Conto"}),e.jsx("button",{onClick:()=>Q(!1),className:"btn-secondary",children:"Annulla"})]})]})}),e.jsx(Bt,{isOpen:R,onClose:()=>y(!1),sessionId:l?.id??void 0,onAddOrder:()=>ct(),onTransfer:()=>mt(),onOpenSplit:()=>ht(),onOpenBillStatus:()=>vt(),onCloseSession:()=>dt()}),e.jsx(w,{isOpen:$s,onClose:()=>ts(!1),title:"Coperto",size:"sm",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-center p-4 bg-dark-900 rounded-xl",children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Coperto da applicare"}),e.jsxs("p",{className:"text-2xl font-bold text-primary-400",children:["€",Ke.toFixed(2)]}),e.jsxs("p",{className:"text-xs text-dark-500 mt-1",children:["(",l?.covers||0," coperti × €",(Ke/(l?.covers||1)).toFixed(2),")"]})]}),e.jsx("p",{className:"text-center text-dark-300",children:"Vuoi applicare il coperto a questo conto?"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx("button",{onClick:()=>ye(!0),className:"btn-primary py-3",children:"Sì, applica"}),e.jsx("button",{onClick:()=>ye(!1),className:"btn-secondary py-3",children:"No, senza coperto"})]})]})}),e.jsx(w,{isOpen:Ds,onClose:()=>te(!1),title:"Chiudi Conto",size:b.method==="cash"&&(l?.total??0)>0?"2xl":"md",children:l&&e.jsxs("div",{className:b.method==="cash"&&(l?.total??0)>0?"md:grid md:grid-cols-2 md:gap-6":"",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center p-4 bg-dark-900 rounded-xl",children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Totale da pagare"}),e.jsxs("p",{className:"text-3xl font-bold text-primary-400",children:["€",(l?.total??0).toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Metodo di Pagamento"}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("button",{onClick:()=>se({...b,method:"cash"}),className:`p-4 rounded-xl border-2 flex flex-col items-center gap-2 transition-colors ${b.method==="cash"?"border-primary-500 bg-primary-500/10":"border-dark-700 hover:border-dark-600"}`,children:[e.jsx(oe,{className:"w-6 h-6"}),e.jsx("span",{className:"text-sm",children:"Contanti"})]}),e.jsxs("button",{onClick:()=>se({...b,method:"card"}),className:`p-4 rounded-xl border-2 flex flex-col items-center gap-2 transition-colors ${b.method==="card"?"border-primary-500 bg-primary-500/10":"border-dark-700 hover:border-dark-600"}`,children:[e.jsx(ke,{className:"w-6 h-6"}),e.jsx("span",{className:"text-sm",children:"Carta"})]}),e.jsxs("button",{onClick:()=>se({...b,method:"online"}),className:`p-4 rounded-xl border-2 flex flex-col items-center gap-2 transition-colors ${b.method==="online"?"border-primary-500 bg-primary-500/10":"border-dark-700 hover:border-dark-600"}`,children:[e.jsx(_s,{className:"w-6 h-6"}),e.jsx("span",{className:"text-sm",children:"Online"})]})]})]}),T&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"smac",checked:b.smac,onChange:s=>se({...b,smac:s.target.checked}),className:"w-5 h-5 rounded border-dark-600 bg-dark-800 text-primary-500 focus:ring-primary-500"}),e.jsx("label",{htmlFor:"smac",className:"text-white",children:"SMAC passato"})]}),(b.method!=="cash"||(l?.total??0)===0)&&e.jsxs("div",{className:"flex items-center gap-3 pt-4",children:[e.jsx("button",{onClick:ms,className:"btn-primary flex-1",children:"Conferma Pagamento"}),e.jsx("button",{onClick:()=>te(!1),className:"btn-secondary",children:"Annulla"})]})]}),b.method==="cash"&&(l?.total??0)>0&&e.jsxs("div",{className:"mt-6 md:mt-0 space-y-4",children:[e.jsxs("div",{className:"p-4 bg-emerald-500/10 border border-emerald-500/30 rounded-xl space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ps,{className:"w-4 h-4 text-emerald-400"}),e.jsx("span",{className:"font-medium text-emerald-400",children:"Calcolatore Resto"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label text-emerald-300",children:"Cliente dà"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"number",step:"0.01",value:S.customerGives,onChange:s=>Z({...S,customerGives:s.target.value}),className:"input flex-1",placeholder:"Es. 50.00"}),e.jsx("span",{className:"flex items-center text-dark-400",children:"€"})]})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:[5,10,20,50,100].map(s=>e.jsxs("button",{type:"button",onClick:()=>Z({...S,customerGives:s.toString()}),className:"px-3 py-1 text-sm bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-300 rounded-lg transition-colors",children:["€",s]},s))}),S.customerGives&&parseFloat(S.customerGives)>0&&e.jsxs("div",{className:"p-3 bg-dark-900 rounded-lg",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-dark-400",children:"Totale conto:"}),e.jsxs("span",{className:"text-white",children:["€",(l?.total??0).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between items-center mt-1",children:[e.jsx("span",{className:"text-dark-400",children:"Cliente dà:"}),e.jsxs("span",{className:"text-white",children:["€",parseFloat(S.customerGives).toFixed(2)]})]}),e.jsx("div",{className:"border-t border-dark-700 my-2"}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-emerald-400 font-semibold",children:"RESTO DA DARE:"}),e.jsxs("span",{className:"text-2xl font-bold text-emerald-400",children:["€",Math.max(0,parseFloat(S.customerGives)-(l?.total??0)).toFixed(2)]})]}),parseFloat(S.customerGives)<(l?.total??0)&&e.jsxs("p",{className:"text-amber-400 text-sm mt-2",children:["⚠️ Il cliente non ha dato abbastanza! Mancano €",((l?.total??0)-parseFloat(S.customerGives)).toFixed(2)]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:ms,className:"btn-primary flex-1",children:"Conferma Pagamento"}),e.jsx("button",{onClick:()=>te(!1),className:"btn-secondary",children:"Annulla"})]})]})]})}),e.jsx(w,{isOpen:Gs,onClose:()=>be(!1),title:"Trasferisci Tavolo",size:"md",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-dark-400",children:"Seleziona il nuovo tavolo:"}),e.jsx("div",{className:"grid grid-cols-3 gap-3 max-h-64 overflow-y-auto",children:C.filter(s=>s.id!==l?.table_id&&ie(s.id)==="available").map(s=>e.jsxs("button",{onClick:()=>xt(s.id),className:"p-4 bg-dark-900 rounded-xl hover:bg-dark-800 transition-colors text-center",children:[e.jsx("p",{className:"font-semibold text-white",children:s.name}),e.jsxs("p",{className:"text-sm text-dark-400",children:[s.capacity," posti"]})]},s.id))}),C.filter(s=>s.id!==l?.table_id&&ie(s.id)==="available").length===0&&e.jsx("p",{className:"text-center text-dark-400 py-4",children:"Nessun tavolo libero disponibile"}),e.jsx("button",{onClick:()=>be(!1),className:"btn-secondary w-full",children:"Annulla"})]})}),e.jsx(Jt,{isOpen:xe,onClose:()=>H(!1),session:l?{id:l.id,total:l.total}:null,sessionPayments:L,remainingAmount:u,remainingSessionItems:g,sessionCovers:I,sessionCoverUnitPrice:q,sessionIncludesCover:Je,onToggleSessionCover:async()=>{},splitMode:As,setSplitMode:Me,selectedItems:je,onIncrementItem:ut,onDecrementItem:ft,onApplyItemsSelection:bt,onToggleAllItemQuantity:gt,splitPaymentForm:B,onChangeSplitPaymentForm:s=>pe(t=>({...t,...s})),changeCalculator:S,onChangeChangeCalculator:s=>Z(t=>({...t,...s})),onAddSplitPayment:jt,calculateSelectedItemsTotal:xs,calculateSplitChange:pt,smacEnabled:T,onPrintPaymentReceipt:hs,formatPrice:s=>G(s),coverSelectedCount:j,onChangeCoverSelectedCount:ne}),e.jsx(w,{isOpen:Qs,onClose:()=>Ae(!1),title:"Stato del Conto",size:"2xl",children:l&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 p-4 bg-dark-900 rounded-xl",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Totale"}),e.jsxs("p",{className:"text-lg font-bold text-white",children:["€",(l?.total??0).toFixed(2)]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Pagato"}),e.jsxs("p",{className:"text-lg font-bold text-emerald-400",children:["€",((l?.total??0)-u).toFixed(2)]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Rimanente"}),e.jsxs("p",{className:"text-lg font-bold text-primary-400",children:["€",u.toFixed(2)]})]})]}),e.jsxs("div",{className:"md:grid md:grid-cols-2 md:gap-6",children:[L.length>0?e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-medium text-dark-400 mb-3",children:["Pagamenti effettuati (",L.length,")"]}),e.jsx("div",{className:"space-y-3 max-h-64 md:max-h-80 overflow-y-auto",children:L.map((s,t)=>e.jsxs("div",{className:"p-4 bg-dark-900 rounded-xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.payment_method==="cash"&&e.jsx(oe,{className:"w-5 h-5 text-emerald-400"}),s.payment_method==="card"&&e.jsx(ke,{className:"w-5 h-5 text-blue-400"}),s.payment_method==="online"&&e.jsx(_s,{className:"w-5 h-5 text-purple-400"}),e.jsxs("span",{className:"font-semibold text-white",children:["Pagamento #",t+1]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-lg font-bold text-primary-400",children:["€",s.amount.toFixed(2)]}),T&&s.smac_passed&&e.jsx("span",{className:"text-xs bg-primary-500/20 text-primary-400 px-2 py-0.5 rounded-full",children:"SMAC"})]})]}),e.jsxs("div",{className:"text-sm text-dark-400 space-y-1",children:[e.jsxs("p",{children:["Metodo: ",s.payment_method==="cash"?"Contanti":s.payment_method==="card"?"Carta":"Online"]}),e.jsxs("p",{children:["Data: ",new Date(s.paid_at).toLocaleString("it-IT")]}),s.notes&&e.jsxs("p",{children:["Note: ",s.notes]})]}),s.paid_items&&s.paid_items.length>0&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-dark-700",children:[e.jsx("p",{className:"text-xs text-dark-500 mb-2",children:"Prodotti pagati:"}),e.jsx("div",{className:"space-y-1",children:s.paid_items.map((a,n)=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-dark-300",children:[a.quantity,"x ",a.menu_item_name]}),e.jsxs("span",{className:"text-dark-400",children:["€",(a.price*a.quantity).toFixed(2)]})]},n))})]}),e.jsxs("button",{onClick:()=>hs(s),className:"mt-3 w-full btn-secondary text-sm py-2 flex items-center justify-center gap-2",children:[e.jsx(Se,{className:"w-4 h-4"}),"Stampa Scontrino"]})]},s.id))})]}):e.jsxs("div",{className:"p-6 bg-dark-900 rounded-xl text-center",children:[e.jsx(ks,{className:"w-12 h-12 mx-auto mb-3 text-dark-600"}),e.jsx("p",{className:"text-dark-400",children:"Nessun pagamento ancora effettuato"})]}),e.jsx("div",{className:"mt-4 md:mt-0",children:g.length>0?e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-dark-400 mb-3",children:"Prodotti ancora da pagare"}),I>0&&q>0&&e.jsxs("div",{className:`p-3 rounded-lg border-2 ${j>0?"border-blue-500 bg-blue-500/10":"border-dark-700"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:"Coperto"}),e.jsxs("p",{className:"text-xs text-dark-400",children:[G(q)," cad."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>ne(Math.max(0,j-1)),className:"w-8 h-8 rounded bg-dark-700",children:"-"}),e.jsx("span",{className:"w-8 text-center font-bold",children:j}),e.jsx("button",{onClick:()=>ne(Math.min(I,j+1)),className:"w-8 h-8 rounded bg-dark-700",children:"+"})]})]}),j>0&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-dark-700 flex justify-between",children:[e.jsxs("span",{className:"text-xs text-dark-400",children:[j,"/",I," selezionati"]}),e.jsx("span",{className:"text-sm font-semibold text-blue-400",children:G(j*q)})]})]}),e.jsx("div",{className:"space-y-2 max-h-48 md:max-h-80 overflow-y-auto",children:g.map(s=>e.jsxs("div",{className:"flex justify-between p-2 bg-dark-900 rounded-lg",children:[e.jsxs("span",{className:"text-white",children:[s.remainingQty,"x ",s.menu_item_name]}),e.jsxs("span",{className:"text-primary-400",children:["€",(s.price*s.remainingQty).toFixed(2)]})]},s.id))})]}):e.jsxs("div",{className:"p-6 bg-emerald-500/10 border border-emerald-500/30 rounded-xl text-center",children:[e.jsx(Ts,{className:"w-12 h-12 mx-auto mb-3 text-emerald-400"}),e.jsx("p",{className:"text-emerald-400 font-medium",children:"Tutto pagato!"})]})})]}),e.jsx("button",{onClick:()=>Ae(!1),className:"btn-secondary w-full",children:"Chiudi"})]})}),e.jsx(w,{isOpen:Ls,onClose:()=>Re(!1),title:"Scontrino",size:"sm",children:d&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white text-black p-6 rounded-lg font-mono text-sm",children:[e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("p",{className:"font-bold text-lg",children:d?.shop_info?.name}),d?.shop_info?.address&&e.jsx("p",{className:"text-xs",children:d?.shop_info?.address}),d?.shop_info?.phone&&e.jsxs("p",{className:"text-xs",children:["Tel: ",d?.shop_info?.phone]})]}),e.jsx("div",{className:"border-t border-dashed border-gray-400 my-3"}),e.jsx("div",{className:"text-xs mb-3",children:e.jsxs("p",{children:["Data: ",d?.date," ",d?.time]})}),e.jsx("div",{className:"border-t border-dashed border-gray-400 my-3"}),e.jsx("div",{className:"space-y-1",children:(d?.items||[]).map((s,t)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:[s.quantity,"x ",s.name]}),e.jsxs("span",{children:["€",s.total.toFixed(2)]})]},t))}),e.jsx("div",{className:"border-t border-dashed border-gray-400 my-3"}),e.jsxs("div",{className:"flex justify-between font-bold text-lg",children:[e.jsx("span",{children:"TOTALE"}),e.jsxs("span",{children:["€",(d?.total??0).toFixed(2)]})]}),e.jsxs("div",{className:"text-xs mt-3",children:[e.jsxs("p",{children:["Pagamento: ",d?.payment_method==="cash"?"Contanti":d?.payment_method==="card"?"Carta":"Online"]}),T&&d?.smac_passed&&e.jsx("p",{children:"SMAC: Sì"})]}),e.jsx("div",{className:"border-t border-dashed border-gray-400 my-3"}),e.jsx("div",{className:"text-center text-xs",children:e.jsx("p",{children:"Grazie e arrivederci!"})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:Nt,className:"btn-primary flex-1 flex items-center justify-center gap-2",children:[e.jsx(Se,{className:"w-5 h-5"}),"Stampa"]}),e.jsx("button",{onClick:()=>Re(!1),className:"btn-secondary",children:"Chiudi"})]})]})})]})}export{oa as Tables,oa as default};
