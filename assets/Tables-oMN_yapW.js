import{j as e,M as w,f as Te,O as Rs,N as Fs,l as _t,k as Pt,i as Tt,r,p as Ns,ai as ys,q as Se,t as c,aj as Ue,P as Mt,U as _e,J as Be,e as zt,ak as ws,K as Et,X as Cs,al as ks,am as Ss,an as At,ao as Rt,ap as Ft,aq as Ot,y as It,A as $t,B as _s,a2 as Ve,a3 as We,a4 as Je,a5 as Ke,x as Ps,Q as Ts,s as Ms,ar as Dt,ab as Gt,ac as Qt}from"./index-DTQOtD2j.js";import{B as de}from"./banknote-Bfr6kugK.js";import{P as Me}from"./printer-g1QjRDnT.js";import{L as Lt,S as qt,a as Ut,b as Bt}from"./SessionDetailsModal-CI12xKxq.js";import{u as Vt}from"./useCurrency-CnO8RJjc.js";import{u as Wt}from"./useDemoGuard-QhVO4_G2.js";import{C as Xe}from"./calendar-D8XHi2a0.js";import{F as zs}from"./file-text-Z9iPRLmd.js";import{C as Es}from"./clock-C_M1xgB3.js";import{L as Pe}from"./link-2-CublzpIA.js";import{M as Jt}from"./message-square-CzDcgJPK.js";import{G as As}from"./globe-CqIwrVyw.js";function Kt(L){const{isOpen:ze,onClose:me,session:A,sessionPayments:M,remainingAmount:C,remainingSessionItems:K,sessionCovers:z,sessionCoverUnitPrice:R,splitMode:$,setSplitMode:X,coverSelectedCount:p,onChangeCoverSelectedCount:H,selectedItems:xe,onIncrementItem:q,onDecrementItem:he,onApplyItemsSelection:k,splitPaymentForm:F,onChangeSplitPaymentForm:y,changeCalculator:pe,onChangeChangeCalculator:Y,onAddSplitPayment:l,calculateSelectedItemsTotal:Ee,calculateSplitChange:ue,smacEnabled:fe,onPrintPaymentReceipt:U,formatPrice:Z}=L,f=Z||(o=>o.toFixed(2));return e.jsx(w,{isOpen:ze,onClose:me,title:"Dividi Conto",size:"2xl",children:A&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 bg-dark-900 rounded-xl",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-3",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-dark-400",children:"Totale"}),e.jsx("p",{className:"text-base lg:text-lg font-bold text-white",children:f(A.total+(p>0?p*R:0))})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-dark-400",children:"Pagato"}),e.jsx("p",{className:"text-base lg:text-lg font-bold text-emerald-400",children:f((M||[]).reduce((o,g)=>o+(g.amount||0),0)+(p>0,0))})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-dark-400",children:"Rimanente"}),e.jsx("p",{className:"text-base lg:text-lg font-bold text-primary-400",children:f(A.total+(p>0?p*R:0)-(M||[]).reduce((o,g)=>o+(g.amount||0),0))})]})]}),A.total>0&&e.jsx("div",{className:"w-full bg-dark-700 rounded-full h-2",children:e.jsx("div",{className:"bg-gradient-to-r from-emerald-500 to-emerald-400 h-2 rounded-full transition-all duration-500",style:{width:`${Math.min(100,(A.total-C)/A.total*100)}%`}})})]}),e.jsxs("div",{className:"md:grid md:grid-cols-2 md:gap-4",children:[e.jsx("div",{children:M.length>0?e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-dark-400 mb-2",children:"Pagamenti effettuati"}),e.jsx("div",{className:"space-y-2 max-h-40 lg:max-h-64 overflow-y-auto",children:M.map(o=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-dark-900 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[o.payment_method==="cash"&&e.jsx(de,{className:"w-4 h-4 text-emerald-400"}),o.payment_method==="card"&&e.jsx(Te,{className:"w-4 h-4 text-blue-400"}),o.payment_method==="online"&&e.jsx(Me,{className:"w-4 h-4 text-purple-400"}),e.jsx("span",{className:"text-white text-sm",children:f(o.amount)}),o.notes&&e.jsxs("span",{className:"text-dark-400 text-xs",children:["- ",o.notes]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[fe&&o.smac_passed&&e.jsx("span",{className:"text-[10px] bg-primary-500/20 text-primary-400 px-1.5 py-0.5 rounded-full",children:"SMAC"}),e.jsx("button",{onClick:()=>U(o),className:"p-1 hover:bg-dark-700 rounded transition-colors",title:"Stampa scontrino",children:e.jsx(Me,{className:"w-3.5 h-3.5 text-dark-400"})})]})]},o.id))})]}):e.jsx("div",{className:"p-4 bg-dark-900 rounded-xl text-center text-dark-500 text-sm",children:"Nessun pagamento ancora effettuato"})}),e.jsxs("div",{className:"mt-4 md:mt-0",children:[C>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsxs("button",{onClick:()=>X("manual"),className:`flex-1 p-2 lg:p-3 rounded-xl border-2 flex flex-col items-center gap-1 transition-all ${$==="manual"?"border-primary-500 bg-primary-500/10":"border-dark-700 hover:border-dark-600"}`,children:[e.jsx(de,{className:"w-4 h-4 lg:w-5 lg:h-5"}),e.jsx("span",{className:"text-xs lg:text-sm font-medium",children:"Manuale"})]}),e.jsxs("button",{onClick:()=>X("items"),className:`flex-1 p-2 lg:p-3 rounded-xl border-2 flex flex-col items-center gap-1 transition-all ${$==="items"?"border-primary-500 bg-primary-500/10":"border-dark-700 hover:border-dark-600"}`,children:[e.jsx(Lt,{className:"w-4 h-4 lg:w-5 lg:h-5"}),e.jsx("span",{className:"text-xs lg:text-sm font-medium",children:"Per Prodotto"})]})]}),$==="items"&&e.jsxs("div",{className:"p-4 border border-blue-500/30 bg-blue-500/5 rounded-xl space-y-4",children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Seleziona quanti pezzi di ogni prodotto pagare."}),e.jsx("div",{className:"max-h-48 overflow-y-auto space-y-2",children:K.length===0?e.jsx("p",{className:"text-center text-dark-500 py-4",children:"Tutti i prodotti sono stati pagati"}):K.map(o=>{const g=Number(o.id||0),E=xe[g]||0,D=E>0;return e.jsxs("div",{className:`p-3 rounded-lg border-2 ${D?"border-blue-500 bg-blue-500/10":"border-dark-700"}`,children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-white font-medium truncate",children:o.menu_item_name}),e.jsxs("p",{className:"text-xs text-dark-400",children:[f(o.price??0)," • ",o.remainingQty??0," rimasti"]})]}),e.jsxs("div",{className:"flex items-center gap-1 bg-dark-800 rounded-lg p-1",children:[e.jsx("button",{onClick:()=>he(g),disabled:E===0,className:"w-8 h-8 rounded bg-dark-700 disabled:opacity-30",children:"-"}),e.jsx("span",{className:"w-8 text-center font-bold",children:E}),e.jsx("button",{onClick:()=>q(g),disabled:E>=(o.remainingQty??0),className:"w-8 h-8 rounded bg-dark-700 disabled:opacity-30",children:"+"})]})]}),D&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-dark-600 flex justify-between items-center",children:[e.jsxs("span",{className:"text-xs text-dark-400",children:[E,"/",o.remainingQty??0," selezionati"]}),e.jsx("span",{className:"text-sm font-semibold text-blue-400",children:f((o.price??0)*E)})]})]},o.id)})}),e.jsxs("div",{className:"space-y-3",children:[z>0&&R>0&&e.jsxs("div",{className:`p-3 rounded-lg border-2 ${p>0?"border-blue-500 bg-blue-500/10":"border-dark-700"}`,children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-white font-medium",children:"Coperto"}),e.jsxs("p",{className:"text-xs text-dark-400",children:[f(R)," • ",z," pers."]})]}),e.jsxs("div",{className:"flex items-center gap-1 bg-dark-800 rounded-lg p-1",children:[e.jsx("button",{onClick:()=>H(Math.max(0,p-1)),disabled:p===0,className:"w-8 h-8 rounded bg-dark-700 disabled:opacity-30",children:"-"}),e.jsx("span",{className:"w-8 text-center font-bold",children:p}),e.jsx("button",{onClick:()=>H(Math.min(z,p+1)),disabled:p>=z,className:"w-8 h-8 rounded bg-dark-700 disabled:opacity-30",children:"+"})]})]}),p>0&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-dark-600 flex justify-between items-center",children:[e.jsxs("span",{className:"text-xs text-dark-400",children:[p,"/",z," selezionati"]}),e.jsx("span",{className:"text-sm font-semibold text-blue-400",children:f(R*p)})]})]},"coperto"),e.jsxs("div",{className:"p-3 bg-dark-900 rounded-lg flex justify-between",children:[e.jsx("span",{children:"Totale:"}),e.jsx("span",{className:"text-blue-400 font-bold",children:f(Ee()+(p>0?p*R:0))})]})]}),e.jsx("button",{onClick:k,disabled:Object.keys(xe).length===0&&p===0,className:"btn-primary w-full bg-blue-600 hover:bg-blue-700",children:"Applica Selezione"})]}),$==="manual"&&e.jsxs("div",{className:"space-y-4 p-4 border border-dark-700 rounded-xl",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Importo"}),e.jsx("input",{type:"number",step:"0.01",value:F.amount,onChange:o=>y({amount:o.target.value}),className:"input",placeholder:`Max €${C.toFixed(2)}`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Note"}),e.jsx("input",{type:"text",value:F.notes,onChange:o=>y({notes:o.target.value}),className:"input",placeholder:"Es. Marco"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>y({method:"cash"}),className:`flex-1 p-2 rounded-lg border flex items-center justify-center gap-2 ${F.method==="cash"?"border-primary-500 bg-primary-500/10":"border-dark-700"}`,children:[e.jsx(de,{className:"w-4 h-4"})," Contanti"]}),e.jsxs("button",{onClick:()=>y({method:"card"}),className:`flex-1 p-2 rounded-lg border flex items-center justify-center gap-2 ${F.method==="card"?"border-primary-500 bg-primary-500/10":"border-dark-700"}`,children:[e.jsx(Te,{className:"w-4 h-4"})," Carta"]})]}),fe&&e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-primary-500/5 border border-primary-500/20 rounded-lg",children:[e.jsx("input",{type:"checkbox",id:"split_smac_comp",checked:F.smac,onChange:o=>y({smac:o.target.checked}),className:"w-5 h-5"}),e.jsx("label",{htmlFor:"split_smac_comp",className:"text-white",children:"SMAC passato"})]}),F.method==="cash"&&F.amount&&e.jsxs("div",{className:"p-3 bg-emerald-500/10 border border-emerald-500/30 rounded-xl space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Rs,{className:"w-4 h-4 text-emerald-400"}),e.jsx("span",{className:"font-medium text-emerald-400",children:"Calcolatore Resto"})]}),e.jsx("input",{type:"number",value:pe.customerGives,onChange:o=>Y({customerGives:o.target.value}),className:"input",placeholder:"Cliente dà €..."}),pe.customerGives&&e.jsxs("div",{className:"p-3 bg-dark-900 rounded-lg flex justify-between",children:[e.jsx("span",{className:"text-emerald-400 font-semibold",children:"RESTO:"}),e.jsx("span",{className:"text-2xl font-bold text-emerald-400",children:f(ue())})]})]}),e.jsx("button",{onClick:l,className:"btn-primary w-full",children:"Aggiungi Pagamento"})]})]}),C===0&&e.jsxs("div",{className:"p-4 bg-emerald-500/10 border border-emerald-500/30 rounded-xl text-center",children:[e.jsx(Fs,{className:"w-10 h-10 mx-auto mb-2 text-emerald-400"}),e.jsx("h4",{className:"text-lg font-bold text-emerald-400",children:"Conto Saldato!"}),e.jsx("p",{className:"text-dark-400 text-sm",children:"Il conto è stato completamente pagato."})]})]})]}),e.jsx("div",{className:"pt-2",children:e.jsx("button",{onClick:me,className:"btn-secondary w-full",children:"Chiudi"})})]})})}function oa(){const{formatPrice:L}=Vt(),ze=_t(),{isDemo:me}=Wt(),{user:A}=Pt(),{smacEnabled:M}=Tt(),[C,K]=r.useState([]),[z,R]=r.useState([]),[$,X]=r.useState([]),[p,H]=r.useState(!0),[xe,q]=r.useState(!1),[he,k]=r.useState(!1),[F,y]=r.useState(!1),[pe,Y]=r.useState(!1),[l,Ee]=r.useState(null),[ue,fe]=r.useState([]),[U,Z]=r.useState([]),[f,o]=r.useState(0),[g,E]=r.useState([]),[D,He]=r.useState(0),[B,Ye]=r.useState(0),[Ze,es]=r.useState(!1),[Os,Ae]=r.useState("manual"),[V,ge]=r.useState({paymentMethod:"cash",amount:"",change:0,notes:"",smac:!1}),[S,ee]=r.useState({paymentMethod:"cash",amount:"",change:0,customerGives:"",showChange:!1}),[ss,Is]=r.useState(0),[$s,ts]=r.useState(!1),[as,ns]=r.useState([]),[G,be]=r.useState({name:"",capacity:1}),[i,_]=r.useState({customer_name:"",phone:"",date:"",time:"",guests:1,notes:"",table_ids:[]}),[je,ve]=r.useState(null),[W,Re]=r.useState(null),[Fe,Ds]=r.useState(null),[P,se]=r.useState({covers:"2",customer_name:"",customer_phone:""}),[j,te]=r.useState({method:"cash",smac:!1}),[rs,Gs]=r.useState(null),[ls,is]=r.useState(!1),[Qs,os]=r.useState(!1),[Ls,ae]=r.useState(!1),[qs,Ne]=r.useState(!1),[Us,Oe]=r.useState(!1),[Bs,Ie]=r.useState(!1),[m,Vs]=r.useState(null),[Ws,cs]=r.useState([]),[ye,ne]=r.useState({}),[v,re]=r.useState(0),[O,Js]=r.useState(new Date().toISOString().split("T")[0]),[Ks,we]=r.useState(!1),[Xs,Ce]=r.useState(!1),[h,ds]=r.useState(null),[Hs,$e]=r.useState(!1),[ms,xs]=r.useState([]),[Ys,J]=r.useState(!1),[Zs,le]=r.useState([]),[hs,De]=r.useState(null),[Ge,Qe]=r.useState(null);r.useEffect(()=>{N()},[O]),r.useEffect(()=>{const s=()=>{(async()=>{try{const[t,a]=await Promise.all([Ns(),ys(O)]);K(t),R(a);const n=await Ue();X(n||[])}catch(t){console.error("Error refreshing tables on update event",t)}})()};return window.addEventListener("orders-updated",s),window.addEventListener("table-sessions-updated",s),window.addEventListener("reservations-updated",s),window.addEventListener("tables-updated",s),window.addEventListener("settings-updated",s),()=>{window.removeEventListener("orders-updated",s),window.removeEventListener("table-sessions-updated",s),window.removeEventListener("reservations-updated",s),window.removeEventListener("tables-updated",s),window.removeEventListener("settings-updated",s)}},[O]);const ie=()=>!me||A&&A.role==="admin",N=async()=>{try{const[s,t,a]=await Promise.all([Ns(),ys(O),Se()]);K(s),R(t),Gs(a),is((a?.cover_charge||0)>0),H(!1)}catch(s){console.error("Error loading data:",s),c("Errore nel caricamento dati","error"),H(!1)}};r.useEffect(()=>{(async()=>{try{const s=await Ue();X(s||[])}catch(s){console.error("Error loading active sessions",s)}})()},[]);function ps(s){return z.find(t=>(t.table_ids||[t.table_id]).includes(s))||null}function oe(s){return $.find(n=>n.table_id===s&&n.status==="open")?"occupied":ps(s)?"reserved":"available"}function et(s){s&&_({...i,table_ids:[s],date:O}),k(!0)}function us(s){s?(be({name:s.name,capacity:s.capacity}),ve(s)):(be({name:"",capacity:1}),ve(null)),we(!0)}function st(){_({...i,date:O}),k(!0)}async function tt(s){if(window.confirm("Sei sicuro di voler eliminare questo tavolo? Questa azione è irreversibile."))try{await At(s),await N(),c("Tavolo eliminato","success")}catch(a){console.error(a),c("Errore eliminazione tavolo","error")}}function at(s){const t=i.table_ids||[];t.includes(s)?_({...i,table_ids:t.filter(a=>a!==s)}):_({...i,table_ids:[...t,s]})}async function nt(){try{je?(await Ft(je.id,G),c("Tavolo aggiornato","success")):(await Ot({name:G.name,capacity:G.capacity}),c("Tavolo creato","success")),we(!1),ve(null),await N()}catch(s){console.error(s),c("Errore salvataggio tavolo","error")}}async function rt(){try{const s={table_ids:i.table_ids,table_id:i.table_ids&&i.table_ids.length>0?i.table_ids[0]:0,date:i.date,time:i.time,customer_name:i.customer_name,phone:i.phone,guests:i.guests,notes:i.notes,status:"confirmed"};await ks(s),k(!1),await N(),c("Prenotazione creata","success")}catch(s){console.error(s);const t=s;t&&t.conflicts&&Array.isArray(t.conflicts)&&t.conflicts.length>0?(le(t.conflicts),De({table_ids:i.table_ids,table_id:i.table_ids&&i.table_ids.length>0?i.table_ids[0]:0,date:i.date,time:i.time,customer_name:i.customer_name,phone:i.phone,guests:i.guests,notes:i.notes,status:"confirmed"}),J(!0)):c("Errore creazione prenotazione","error")}}async function lt(){try{if(!W)return;await Ss(W.id,i),k(!1),await N(),c("Prenotazione aggiornata","success")}catch(s){console.error(s);const t=s;t&&t.conflicts&&Array.isArray(t.conflicts)&&t.conflicts.length>0?(le(t.conflicts),Qe({id:W.id,updates:i}),J(!0)):c("Errore aggiornamento prenotazione","error")}}function it(s){ds(s),Ce(!0)}function ot(s){const t=z.filter(a=>(a.table_ids||[a.table_id]).includes(s));xs(t),$e(!0)}function fs(s){Re(s),_({customer_name:s.customer_name||"",phone:s.phone||"",date:s.date||O,time:s.time||"",guests:s.guests||1,notes:s.notes||"",table_ids:s.table_ids||(s.table_id?[s.table_id]:[])}),k(!0)}async function Le(s){try{await Rt(s),await N(),c("Prenotazione cancellata","success")}catch(t){console.error(t),c("Errore cancellazione prenotazione","error")}}const ct=async s=>{try{await _s(s.id);const[t,a,n]=await Promise.all([Ps(s.id),We(s.id),Je(s.id)]),x=(await Ue()).find(d=>d.id===s.id);Ee(x||s),fe(t),Z(a),o(n),y(!0)}catch(t){console.error("Error loading session details:",t),c("Errore nel caricamento dettagli","error")}};function dt(){try{const s=i.table_ids||[];return C.filter(t=>s.includes(t.id)).reduce((t,a)=>t+(a.capacity||0),0)}catch{return 0}}async function mt(){if(ie()&&Fe)try{const s=await It(Fe,parseInt(P.covers)||1,P.customer_name||void 0,P.customer_phone||void 0);try{s&&s.id&&await $t({date:new Date().toISOString().split("T")[0],total:0,payment_method:"cash",order_type:"dine_in",table_id:Fe,notes:"Conto creato all'apertura sessione",status:"pending",smac_passed:!1,customer_name:P.customer_name||s.customer_name||"",customer_phone:P.customer_phone||s.customer_phone||"",created_by:"session-placeholder",session_id:s.id,order_number:1},[])}catch(t){console.error("Error creating placeholder order for new session:",t)}if(ls&&s&&s.id)try{await _s(s.id,!0)}catch(t){console.error("Error applying cover on new session:",t)}c("Conto aperto","success"),q(!1),N()}catch(s){console.error("Error opening session:",s),c("Errore nell'apertura conto","error")}}function xt(){l&&ze(`/orders/new?table=${l.table_id}&session=${l.id}`)}async function ht(){if(!ie()||!l)return;if((l?.total??0)===0){if(window.confirm("Vuoi chiudere questo conto a €0.00?"))try{await Ve(l.id,"cash",!1,!1),c("Conto chiuso","success"),y(!1),N()}catch(n){console.error("Error closing session:",n),c("Errore nella chiusura","error")}return}const t=(await Se()).cover_charge||0;if(t>0&&(l?.covers??0)>0){const a=t*(l?.covers??0);Is(a);const n=!!Ze;ts(n),ke(n)}else ke(!1)}function ke(s){ts(s),os(!1),te({method:"cash",smac:!1}),ee(t=>({...t,customerGives:"",showChange:!1})),ae(!0)}async function gs(){if(ie()&&l)try{await Ve(l.id,j.method,j.smac,$s),c("Conto chiuso","success"),ae(!1),y(!1),N()}catch(s){console.error("Error closing session:",s),c("Errore nella chiusura","error")}}function pt(){l&&Ne(!0)}async function ut(s){if(ie()&&l)try{await Dt(l.id,s),c("Tavolo trasferito","success"),Ne(!1),y(!1),N()}catch(t){console.error("Error transferring table:",t),c("Errore nel trasferimento","error")}}async function ft(){if(l){ge(s=>({...s,amount:"",method:"cash",notes:"",smac:!1})),Ae("manual"),ne({}),ee(s=>({...s,customerGives:"",showChange:!1}));try{const s=[];for(const T of ue)(await Ts(T.id)).forEach(qe=>{s.push({...qe,order_number:T.order_number||1})});cs(s);const t=await Ke(l.id),a=s.map(T=>({...T,remainingQty:T.quantity-(t[T.id]||0)})).filter(T=>T.remainingQty>0);E(a);const n=await Ms(l.id),u=await Se(),x=n?.covers||0,d=u.cover_charge||0,b=ue.reduce((T,ce)=>T+ce.total,0)+d*x,I=Math.abs((n?.total||0)-b)<.01||(n?.total||0)>=b-.01;He(x),Ye(d),es(I&&d>0&&x>0)}catch(s){console.error("Error loading items:",s)}re(0),Y(!0)}}function gt(){const s=parseFloat(S.customerGives)||0,t=parseFloat(V.amount)||0;return Math.max(0,s-t)}function bs(){return Object.entries(ye).reduce((s,[t,a])=>{const n=g.find(u=>u.id===Number(t));return n&&a>0?s+n.price*a:s},0)}function bt(s){const t=g.find(a=>a.id===s);t&&ne(a=>{const n=a[s]||0;return n<t.remainingQty?{...a,[s]:n+1}:a})}function jt(s){ne(t=>{const a=t[s]||0;if(a>0){const n=a-1;if(n===0){const{[s]:u,...x}=t;return x}return{...t,[s]:n}}return t})}function vt(s){const t=g.find(a=>a.id===s);t&&ne(a=>{if((a[s]||0)===t.remainingQty){const{[s]:u,...x}=a;return x}else return{...a,[s]:t.remainingQty}})}function Nt(){const s=bs(),t=v>0&&D>0?B*v:0,a=s+t;if(a>0&&a<=f+.01){const n=Object.entries(ye).map(([d,Q])=>{const b=g.find(I=>I.id===Number(d));return b?`${Q}x ${b.menu_item_name}`:""}).filter(Boolean);v>0&&n.push(`${v}x Coperto`);const u=n.join(", "),x=Object.entries(ye).map(([d,Q])=>{const b=g.find(I=>I.id===Number(d));return b?{order_item_id:b.id,quantity:Q,menu_item_name:b.menu_item_name,price:b.price}:null}).filter(d=>d!==null);v>0&&x.push({order_item_id:void 0,quantity:v,menu_item_name:"Coperto",price:B}),ns(x),ge(d=>({...d,amount:Math.min(a,f).toFixed(2),notes:u.length>40?u.substring(0,40)+"...":u})),Ae("manual"),ne({}),re(0)}}async function yt(){if(!ie())return;if(!l){c("Sessione non trovata","error");return}const s=parseFloat(V.amount);if(isNaN(s)||s<=0){c("Inserisci un importo valido","warning");return}if(s>f+.01){c("Importo superiore al rimanente","warning");return}try{await Qt(l.id,s,V.method??"cash",V.notes||void 0,V.smac,as.length>0?as:void 0);const[t,a,n]=await Promise.all([We(l.id),Je(l.id),Ke(l.id)]);Z(t),o(a);const u=Ws.map(x=>({...x,remainingQty:x.quantity-(n[x.id]||0)})).filter(x=>x.remainingQty>0);if(E(u),ge(x=>({...x,amount:"",method:"cash",notes:"",smac:!1})),ns([]),c("Pagamento aggiunto","success"),a<=.01)try{await Ve(l.id,"split",!1),c("Conto saldato e chiuso","success"),Y(!1),y(!1),N()}catch(x){console.error("Error closing session:",x),c("Pagamento aggiunto, ma errore nella chiusura automatica","warning")}}catch(t){console.error("Error adding payment:",t),c("Errore nell'aggiunta pagamento","error")}}async function wt(){if(l)try{const[s,t,a]=await Promise.all([We(l.id),Je(l.id),Ke(l.id)]),n=await Ps(l.id),u=[];for(const d of n)(await Ts(d.id)).forEach(b=>{u.push({...b,order_number:d.order_number||1})});const x=u.map(d=>({...d,remainingQty:d.quantity-(a[d.id]||0)})).filter(d=>d.remainingQty>0);try{const d=await Ms(l.id),Q=await Se(),b=d?.covers||0,I=Q.cover_charge||0,ce=n.reduce((kt,St)=>kt+St.total,0)+I*b,qe=Math.abs((d?.total||0)-ce)<.01||(d?.total||0)>=ce-.01;He(b),Ye(I),es(qe&&I>0&&b>0)}catch(d){console.error("Error loading session info for bill status modal (tables):",d)}cs(u),Z(s),o(t),E(x),Oe(!0)}catch(s){console.error("Error loading bill status (tables):",s),c("Errore nel caricamento stato conto","error")}}async function js(s){try{const t=await Gt(s);t&&(Vs(t),Ie(!0))}catch(t){console.error("Error generating receipt:",t),c("Errore nella generazione scontrino","error")}}function Ct(){if(!m)return;const s=`
      <html>
        <head>
          <title>Scontrino</title>
          <style>
            body { font-family: 'Courier New', monospace; padding: 20px; max-width: 300px; margin: 0 auto; }
            .header { text-align: center; margin-bottom: 20px; }
            .shop-name { font-size: 18px; font-weight: bold; }
            .divider { border-top: 1px dashed #000; margin: 10px 0; }
            .item { display: flex; justify-content: space-between; margin: 5px 0; }
            .total { font-weight: bold; font-size: 16px; }
            .footer { text-align: center; margin-top: 20px; font-size: 12px; }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="shop-name">${m?.shop_info?.name??""}</div>
            ${m?.shop_info?.address?`<div>${m.shop_info.address}</div>`:""}
            ${m?.shop_info?.phone?`<div>Tel: ${m.shop_info.phone}</div>`:""}
          </div>
          <div class="divider"></div>
          <div>Data: ${m?.date??""} ${m?.time??""}</div>
          <div class="divider"></div>
          ${(m?.items||[]).map(a=>`
            <div class="item">
              <span>${a.quantity}x ${a.name}</span>
              <span>€${a.total.toFixed(2)}</span>
            </div>
          `).join("")}
          <div class="divider"></div>
          <div class="item total">
            <span>TOTALE</span>
            <span>€${(m?.total??0).toFixed(2)}</span>
          </div>
          <div>Pagamento: ${m?.payment_method==="cash"?"Contanti":m?.payment_method==="card"?"Carta":"Online"}</div>
          ${M&&m?.smac_passed?"<div>SMAC: Sì</div>":""}
          <div class="divider"></div>
          <div class="footer">Grazie e arrivederci!</div>
        </body>
      </html>
    `,t=window.open("","_blank");t&&(t.document.write(s),t.document.close(),t.print())}if(p)return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-500"})});const vs=s=>{const t=oe(s),a=$.find(u=>u.table_id===s)||null,n=ps(s);t==="occupied"?a&&ct(a):(t==="available"||t==="reserved")&&(Ds(s),se(n?{covers:n.guests?.toString()||"2",customer_name:n.customer_name||"",customer_phone:n.phone||""}:{covers:"2",customer_name:"",customer_phone:""}),q(!0))};return e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-white",children:"Tavoli e Prenotazioni"}),e.jsx("p",{className:"text-dark-400 mt-1 text-sm sm:text-base",children:"Gestisci tavoli e prenotazioni"})]}),e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[e.jsxs("button",{onClick:()=>st(),className:"btn-secondary flex-1 sm:flex-none",children:[e.jsx(Xe,{className:"w-4 h-4 sm:w-5 sm:h-5"}),e.jsx("span",{className:"text-sm sm:text-base",children:"Prenotazione"})]}),e.jsxs("button",{onClick:()=>us(),className:"btn-primary flex-1 sm:flex-none",children:[e.jsx(Mt,{className:"w-4 h-4 sm:w-5 sm:h-5"}),e.jsx("span",{className:"text-sm sm:text-base",children:"Tavolo"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 sm:gap-4",children:[e.jsx(Xe,{className:"w-4 h-4 sm:w-5 sm:h-5 text-dark-400"}),e.jsx("input",{type:"date",value:O,onChange:s=>Js(s.target.value),className:"input w-auto text-sm sm:text-base"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 sm:gap-6",children:[e.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2",children:[e.jsx("div",{className:"w-3 h-3 sm:w-4 sm:h-4 rounded bg-emerald-500"}),e.jsx("span",{className:"text-xs sm:text-sm text-dark-300",children:"Disponibile"})]}),e.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2",children:[e.jsx("div",{className:"w-3 h-3 sm:w-4 sm:h-4 rounded bg-red-500"}),e.jsx("span",{className:"text-xs sm:text-sm text-dark-300",children:"Occupato"})]}),e.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2",children:[e.jsx("div",{className:"w-3 h-3 sm:w-4 sm:h-4 rounded bg-amber-500"}),e.jsx("span",{className:"text-xs sm:text-sm text-dark-300",children:"Prenotato"})]})]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-6 gap-1 sm:gap-3",children:C.map(s=>{const t=oe(s.id),a=$.find(n=>n.table_id===s.id);return e.jsxs("div",{onClick:()=>vs(s.id),className:`
                group relative
                ${t==="available"?"table-available cursor-pointer hover:scale-105":""}
                ${t==="occupied"?"table-occupied cursor-pointer hover:scale-105":""}
                ${t==="reserved"?"table-reserved cursor-pointer hover:scale-105":""}
                  transform scale-90 pt-6 sm:pt-8 p-2 sm:p-3 transition-transform flex flex-col justify-between min-h-[110px]
              `,children:[e.jsx("h3",{className:"text-base sm:text-lg font-bold text-center w-full mt-8 sm:mt-10",children:s.name}),e.jsxs("div",{className:"flex items-center justify-center gap-1 mt-1",children:[e.jsx(_e,{className:"w-3 h-3 sm:w-4 sm:h-4"}),e.jsx("span",{className:"text-xs sm:text-sm",children:s.capacity})]}),a&&e.jsxs("div",{className:"mt-2 text-[10px] sm:text-xs space-y-1 text-center",children:[e.jsxs("p",{className:"flex items-center justify-center gap-1",children:[e.jsx(_e,{className:"w-3 h-3"}),a.covers," coperti"]}),e.jsxs("p",{className:"font-semibold text-base sm:text-lg",children:["€",a.total.toFixed(2)]})]}),(t==="available"||t==="reserved")&&e.jsxs("div",{className:"mt-2 sm:mt-3 space-y-1",children:[e.jsx("button",{onClick:n=>{n.stopPropagation(),vs(s.id)},className:"text-[10px] sm:text-xs font-medium text-emerald-400 hover:text-emerald-300",children:"Apri Conto"}),e.jsx("button",{onClick:n=>{n.stopPropagation(),et(s.id)},className:"block text-[10px] sm:text-xs underline hover:no-underline",children:"Prenota"})]}),e.jsxs("div",{className:"absolute top-1 right-1 sm:top-2 sm:right-2 flex gap-2 transition-colors",children:[e.jsx("button",{onClick:n=>{n.stopPropagation(),ot(s.id)},className:"p-2 bg-dark-800 rounded hover:bg-dark-700",title:"Visualizza prenotazioni",children:e.jsx(zs,{className:"w-4 h-4 sm:w-5 sm:h-5"})}),e.jsx("button",{onClick:n=>{n.stopPropagation(),us(s)},className:"p-2 bg-dark-800 rounded hover:bg-dark-700",title:"Modifica tavolo",children:e.jsx(Be,{className:"w-4 h-4 sm:w-5 sm:h-5"})}),e.jsx("button",{onClick:n=>{n.stopPropagation(),tt(s.id)},className:"p-2 bg-dark-800 rounded hover:bg-red-500/20",title:"Elimina tavolo",children:e.jsx(zt,{className:"w-4 h-4 sm:w-5 sm:h-5"})})]})]},s.id)})}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("h2",{className:"font-semibold text-white text-sm sm:text-base",children:["Prenotazioni per ",new Date(O).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long"})]})}),e.jsx("div",{className:"card-body",children:z.length===0?e.jsx("p",{className:"text-dark-400 text-center py-4 text-sm",children:"Nessuna prenotazione per questa data"}):e.jsx("div",{className:"space-y-2 sm:space-y-3",children:z.map(s=>e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between p-3 sm:p-4 bg-dark-900 rounded-xl gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 sm:gap-4",children:[e.jsx("div",{className:"w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-primary-500/20 flex items-center justify-center flex-shrink-0",children:e.jsx(Es,{className:"w-5 h-5 sm:w-6 sm:h-6 text-primary-400"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"font-semibold text-white text-sm sm:text-base truncate",children:s.customer_name}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-2 sm:gap-x-3 gap-y-0.5 text-xs sm:text-sm text-dark-400",children:[e.jsx("span",{children:s.time}),e.jsxs("span",{className:"flex items-center gap-1",children:[s.table_ids&&s.table_ids.length>1&&e.jsx(Pe,{className:"w-3 h-3 text-primary-400"}),s.table_name]}),e.jsxs("span",{children:[s.guests," ospiti"]})]}),s.phone&&e.jsxs("div",{className:"flex items-center gap-1 text-xs sm:text-sm text-dark-400",children:[e.jsx(ws,{className:"w-3 h-3"}),s.phone]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 justify-end",children:[e.jsx("span",{className:`badge text-xs ${s.status==="confirmed"?"badge-success":"badge-danger"}`,children:s.status==="confirmed"?"Confermata":"Annullata"}),e.jsx("button",{onClick:()=>it(s),className:"p-1.5 sm:p-2 hover:bg-dark-700 rounded-lg transition-colors",title:"Visualizza dettagli",children:e.jsx(Et,{className:"w-4 h-4 sm:w-5 sm:h-5 text-dark-400"})}),e.jsx("button",{onClick:()=>fs(s),className:"p-1.5 sm:p-2 hover:bg-dark-700 rounded-lg transition-colors",title:"Modifica",children:e.jsx(Be,{className:"w-4 h-4 sm:w-5 sm:h-5 text-dark-400"})}),s.status==="confirmed"&&e.jsx("button",{onClick:()=>Le(s.id),className:"p-1.5 sm:p-2 hover:bg-red-500/20 rounded-lg transition-colors",title:"Annulla",children:e.jsx(Cs,{className:"w-4 h-4 sm:w-5 sm:h-5 text-red-400"})})]})]},s.id))})})]}),e.jsx(w,{isOpen:Ks,onClose:()=>{we(!1),ve(null)},title:je?"Modifica Tavolo":"Nuovo Tavolo",size:"sm",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Nome Tavolo"}),e.jsx("input",{type:"text",value:G.name,onChange:s=>be({...G,name:s.target.value}),className:"input",placeholder:"Es. Tavolo 1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Capacità (posti)"}),e.jsx("input",{type:"number",min:"1",value:G.capacity,onChange:s=>be({...G,capacity:Number(s.target.value)}),className:"input"})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-4",children:[e.jsx("button",{onClick:nt,className:"btn-primary flex-1",children:je?"Salva":"Crea"}),e.jsx("button",{onClick:()=>we(!1),className:"btn-secondary",children:"Annulla"})]})]})}),e.jsx(w,{isOpen:he,onClose:()=>{k(!1),Re(null)},title:W?"Modifica Prenotazione":"Nuova Prenotazione",size:"xl",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Data"}),e.jsx("input",{type:"date",value:i.date,onChange:s=>_({...i,date:s.target.value}),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Ora"}),e.jsx("input",{type:"time",value:i.time,onChange:s=>_({...i,time:s.target.value}),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Telefono"}),e.jsx("input",{type:"tel",value:i.phone,onChange:s=>_({...i,phone:s.target.value}),className:"input",placeholder:"+39..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Ospiti"}),e.jsx("input",{type:"number",min:"1",value:i.guests,onChange:s=>_({...i,guests:Number(s.target.value)}),className:"input"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Nome Cliente *"}),e.jsx("input",{type:"text",value:i.customer_name,onChange:s=>_({...i,customer_name:s.target.value}),className:"input",placeholder:"Nome e cognome"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"label mb-0",children:[e.jsx(Pe,{className:"w-4 h-4 inline mr-1"}),"Tavoli"]}),e.jsxs("span",{className:"text-xs text-dark-400",children:["Capacità totale: ",e.jsx("span",{className:"text-primary-400 font-semibold",children:dt()})," posti"]})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2 max-h-32 overflow-y-auto p-2 bg-dark-900 rounded-xl",children:C.map(s=>{const t=i.table_ids.includes(s.id),a=oe(s.id),n=a==="available"||he&&(a==="occupied"||a==="reserved");return e.jsxs("button",{type:"button",onClick:()=>n&&at(s.id),disabled:!n,className:`p-3 rounded-lg border-2 text-sm flex items-center gap-2 transition-all ${t?"border-primary-500 bg-primary-500/10 text-white":n?"border-dark-600 text-dark-300 hover:border-dark-500":"border-dark-700 text-dark-500 opacity-50 cursor-not-allowed"}`,children:[t?e.jsx(qt,{className:"w-4 h-4 text-primary-400 flex-shrink-0"}):e.jsx(Ut,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"flex-1 text-left",children:s.name}),e.jsxs("span",{className:"text-xs text-dark-400 flex-shrink-0",children:[s.capacity,"p"]})]},s.id)})}),i.table_ids.length>1&&e.jsxs("p",{className:"text-xs text-primary-400 mt-2 flex items-center gap-1",children:[e.jsx(Pe,{className:"w-3 h-3"}),"Tavoli uniti: ",C.filter(s=>i.table_ids.includes(s.id)).map(s=>s.name).join(" + ")]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Note"}),e.jsx("textarea",{value:i.notes,onChange:s=>_({...i,notes:s.target.value}),className:"input resize-none h-16",placeholder:"Note aggiuntive..."})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-2",children:[e.jsx("button",{onClick:W?lt:rt,className:"btn-primary flex-1",children:W?"Salva Modifiche":"Crea Prenotazione"}),e.jsx("button",{onClick:()=>{k(!1),Re(null)},className:"btn-secondary",children:"Annulla"})]})]})}),e.jsx(w,{isOpen:Xs,onClose:()=>Ce(!1),title:"Dettagli Prenotazione",size:"md",children:h&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("span",{className:`badge text-lg px-4 py-2 ${h?.status==="confirmed"?"badge-success":h?.status==="cancelled"?"badge-danger":"badge-secondary"}`,children:h?.status==="confirmed"?"Confermata":h?.status==="cancelled"?"Annullata":"Completata"})}),e.jsx("div",{className:"p-4 bg-dark-900 rounded-xl space-y-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-primary-500/20 flex items-center justify-center",children:e.jsx(_e,{className:"w-6 h-6 text-primary-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-white text-lg",children:h?.customer_name}),h?.phone&&e.jsxs("div",{className:"flex items-center gap-1 text-dark-400",children:[e.jsx(ws,{className:"w-4 h-4"}),e.jsx("a",{href:`tel:${h?.phone}`,className:"hover:text-primary-400",children:h?.phone})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-4 bg-dark-900 rounded-xl text-center",children:[e.jsx(Xe,{className:"w-6 h-6 text-primary-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-dark-400",children:"Data"}),e.jsx("p",{className:"font-semibold text-white",children:new Date(h?.date??"").toLocaleDateString("it-IT",{weekday:"short",day:"numeric",month:"short"})})]}),e.jsxs("div",{className:"p-4 bg-dark-900 rounded-xl text-center",children:[e.jsx(Es,{className:"w-6 h-6 text-primary-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-dark-400",children:"Ora"}),e.jsx("p",{className:"font-semibold text-white",children:h?.time})]}),e.jsxs("div",{className:"p-4 bg-dark-900 rounded-xl text-center",children:[e.jsx(_e,{className:"w-6 h-6 text-primary-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-dark-400",children:"Ospiti"}),e.jsxs("p",{className:"font-semibold text-white",children:[h?.guests," persone"]})]}),e.jsxs("div",{className:"p-4 bg-dark-900 rounded-xl text-center",children:[e.jsx(Pe,{className:"w-6 h-6 text-primary-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-dark-400",children:(h?.table_ids?.length??0)>1?"Tavoli Uniti":"Tavolo"}),e.jsx("p",{className:"font-semibold text-white",children:h?.table_name}),(h?.table_ids?.length??0)>1&&e.jsxs("p",{className:"text-xs text-primary-400 mt-1",children:[h?.table_ids?.length??0," tavoli"]})]})]}),h?.notes&&e.jsxs("div",{className:"p-4 bg-dark-900 rounded-xl",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Jt,{className:"w-4 h-4 text-dark-400"}),e.jsx("p",{className:"text-sm text-dark-400",children:"Note"})]}),e.jsx("p",{className:"text-white",children:h?.notes})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-4",children:[e.jsxs("button",{onClick:()=>h&&fs(h),className:"btn-secondary flex-1",children:[e.jsx(Be,{className:"w-5 h-5"}),"Modifica"]}),h?.status==="confirmed"&&e.jsxs("button",{onClick:()=>{h&&(Le(h.id),Ce(!1))},className:"btn-danger",children:[e.jsx(Cs,{className:"w-5 h-5"}),"Annulla"]})]})]})}),e.jsx(w,{isOpen:Hs,onClose:()=>$e(!1),title:"Prenotazioni tavolo",size:"sm",children:e.jsx("div",{className:"space-y-3 max-h-[60vh] overflow-y-auto",children:ms.length===0?e.jsx("p",{className:"text-dark-400 text-center py-4",children:"Nessuna prenotazione per questo tavolo oggi"}):e.jsx("div",{className:"space-y-2",children:ms.map(s=>e.jsxs("div",{className:"p-2 sm:p-3 bg-dark-900 rounded-xl flex items-center justify-between",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-semibold text-white text-sm truncate",children:s.customer_name}),e.jsxs("p",{className:"text-xs text-dark-400",children:[s.time," • ",s.guests," ospiti"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>{ds(s),Ce(!0),$e(!1)},className:"btn-secondary py-1 px-2 text-xs",children:"Dettagli"}),e.jsx("button",{onClick:()=>{Le(s.id),xs(t=>t.filter(a=>a.id!==s.id))},className:"btn-danger py-1 px-2 text-xs",children:"Annulla"})]})]},s.id))})})}),e.jsx(w,{isOpen:Ys,onClose:()=>J(!1),title:"Conflitto Prenotazioni",size:"md",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-dark-300",children:"Attenzione: ci sono prenotazioni vicine per questo tavolo nelle seguenti fasce orarie. Vuoi procedere comunque?"}),e.jsx("div",{className:"space-y-2",children:Zs.map(s=>e.jsxs("div",{className:"p-3 bg-dark-900 rounded-xl flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-white",children:s.customer_name}),e.jsxs("p",{className:"text-sm text-dark-400",children:[s.date," • ",s.time," • ",s.guests," ospiti"]})]}),e.jsxs("div",{className:"text-sm text-dark-400",children:["Tavoli: ",s.table_names||(s.table_ids||[s.table_id]).join(", ")]})]},s.id))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn-secondary flex-1",onClick:()=>{J(!1),le([]),De(null),Qe(null)},children:"Annulla"}),e.jsx("button",{className:"btn-primary flex-1",onClick:async()=>{try{hs?(await ks(hs,{force:!0}),k(!1),J(!1),De(null),le([]),await N(),c("Prenotazione creata (forzata)","success")):Ge&&(await Ss(Ge.id,Ge.updates,{force:!0}),k(!1),J(!1),Qe(null),le([]),await N(),c("Prenotazione aggiornata (forzata)","success"))}catch(s){console.error("Errore forzando prenotazione:",s),c("Errore durante la conferma forzata","error")}},children:"Conferma e Salva"})]})]})}),e.jsx(w,{isOpen:xe,onClose:()=>q(!1),title:"Apri Conto",size:"sm",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Numero Coperti"}),e.jsx("input",{type:"number",min:"1",value:P.covers,onChange:s=>se({...P,covers:s.target.value}),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Nome Cliente (opzionale)"}),e.jsx("input",{type:"text",value:P.customer_name,onChange:s=>se({...P,customer_name:s.target.value}),className:"input",placeholder:"Es. Marco Rossi"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Telefono (opzionale)"}),e.jsx("input",{type:"tel",value:P.customer_phone,onChange:s=>se({...P,customer_phone:s.target.value}),className:"input",placeholder:"+39..."})]}),(rs?.cover_charge||0)>0&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{id:"open_session_apply_cover_tables",type:"checkbox",checked:ls,onChange:s=>is(s.target.checked),className:"w-5 h-5"}),e.jsxs("label",{htmlFor:"open_session_apply_cover_tables",className:"text-white text-sm",children:["Applica coperto (",L(rs?.cover_charge??0)," / ospite)"]})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-4",children:[e.jsx("button",{onClick:mt,className:"btn-primary flex-1",children:"Apri Conto"}),e.jsx("button",{onClick:()=>q(!1),className:"btn-secondary",children:"Annulla"})]})]})}),e.jsx(Bt,{isOpen:F,onClose:()=>y(!1),sessionId:l?.id??void 0,onAddOrder:()=>xt(),onTransfer:()=>pt(),onOpenSplit:()=>ft(),onOpenBillStatus:()=>wt(),onCloseSession:()=>ht()}),e.jsx(w,{isOpen:Qs,onClose:()=>os(!1),title:"Coperto",size:"sm",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-center p-4 bg-dark-900 rounded-xl",children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Coperto da applicare"}),e.jsxs("p",{className:"text-2xl font-bold text-primary-400",children:["€",ss.toFixed(2)]}),e.jsxs("p",{className:"text-xs text-dark-500 mt-1",children:["(",l?.covers||0," coperti × €",(ss/(l?.covers||1)).toFixed(2),")"]})]}),e.jsx("p",{className:"text-center text-dark-300",children:"Vuoi applicare il coperto a questo conto?"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx("button",{onClick:()=>ke(!0),className:"btn-primary py-3",children:"Sì, applica"}),e.jsx("button",{onClick:()=>ke(!1),className:"btn-secondary py-3",children:"No, senza coperto"})]})]})}),e.jsx(w,{isOpen:Ls,onClose:()=>ae(!1),title:"Chiudi Conto",size:j.method==="cash"&&(l?.total??0)>0?"2xl":"md",children:l&&e.jsxs("div",{className:j.method==="cash"&&(l?.total??0)>0?"md:grid md:grid-cols-2 md:gap-6":"",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center p-4 bg-dark-900 rounded-xl",children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Totale da pagare"}),e.jsxs("p",{className:"text-3xl font-bold text-primary-400",children:["€",(l?.total??0).toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Metodo di Pagamento"}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("button",{onClick:()=>te({...j,method:"cash"}),className:`p-4 rounded-xl border-2 flex flex-col items-center gap-2 transition-colors ${j.method==="cash"?"border-primary-500 bg-primary-500/10":"border-dark-700 hover:border-dark-600"}`,children:[e.jsx(de,{className:"w-6 h-6"}),e.jsx("span",{className:"text-sm",children:"Contanti"})]}),e.jsxs("button",{onClick:()=>te({...j,method:"card"}),className:`p-4 rounded-xl border-2 flex flex-col items-center gap-2 transition-colors ${j.method==="card"?"border-primary-500 bg-primary-500/10":"border-dark-700 hover:border-dark-600"}`,children:[e.jsx(Te,{className:"w-6 h-6"}),e.jsx("span",{className:"text-sm",children:"Carta"})]}),e.jsxs("button",{onClick:()=>te({...j,method:"online"}),className:`p-4 rounded-xl border-2 flex flex-col items-center gap-2 transition-colors ${j.method==="online"?"border-primary-500 bg-primary-500/10":"border-dark-700 hover:border-dark-600"}`,children:[e.jsx(As,{className:"w-6 h-6"}),e.jsx("span",{className:"text-sm",children:"Online"})]})]})]}),M&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"smac",checked:j.smac,onChange:s=>te({...j,smac:s.target.checked}),className:"w-5 h-5 rounded border-dark-600 bg-dark-800 text-primary-500 focus:ring-primary-500"}),e.jsx("label",{htmlFor:"smac",className:"text-white",children:"SMAC passato"})]}),(j.method!=="cash"||(l?.total??0)===0)&&e.jsxs("div",{className:"flex items-center gap-3 pt-4",children:[e.jsx("button",{onClick:gs,className:"btn-primary flex-1",children:"Conferma Pagamento"}),e.jsx("button",{onClick:()=>ae(!1),className:"btn-secondary",children:"Annulla"})]})]}),j.method==="cash"&&(l?.total??0)>0&&e.jsxs("div",{className:"mt-6 md:mt-0 space-y-4",children:[e.jsxs("div",{className:"p-4 bg-emerald-500/10 border border-emerald-500/30 rounded-xl space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Rs,{className:"w-4 h-4 text-emerald-400"}),e.jsx("span",{className:"font-medium text-emerald-400",children:"Calcolatore Resto"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label text-emerald-300",children:"Cliente dà"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"number",step:"0.01",value:S.customerGives,onChange:s=>ee({...S,customerGives:s.target.value}),className:"input flex-1",placeholder:"Es. 50.00"}),e.jsx("span",{className:"flex items-center text-dark-400",children:"€"})]})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:[5,10,20,50,100].map(s=>e.jsxs("button",{type:"button",onClick:()=>ee({...S,customerGives:s.toString()}),className:"px-3 py-1 text-sm bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-300 rounded-lg transition-colors",children:["€",s]},s))}),S.customerGives&&parseFloat(S.customerGives)>0&&e.jsxs("div",{className:"p-3 bg-dark-900 rounded-lg",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-dark-400",children:"Totale conto:"}),e.jsxs("span",{className:"text-white",children:["€",(l?.total??0).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between items-center mt-1",children:[e.jsx("span",{className:"text-dark-400",children:"Cliente dà:"}),e.jsxs("span",{className:"text-white",children:["€",parseFloat(S.customerGives).toFixed(2)]})]}),e.jsx("div",{className:"border-t border-dark-700 my-2"}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-emerald-400 font-semibold",children:"RESTO DA DARE:"}),e.jsxs("span",{className:"text-2xl font-bold text-emerald-400",children:["€",Math.max(0,parseFloat(S.customerGives)-(l?.total??0)).toFixed(2)]})]}),parseFloat(S.customerGives)<(l?.total??0)&&e.jsxs("p",{className:"text-amber-400 text-sm mt-2",children:["⚠️ Il cliente non ha dato abbastanza! Mancano €",((l?.total??0)-parseFloat(S.customerGives)).toFixed(2)]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:gs,className:"btn-primary flex-1",children:"Conferma Pagamento"}),e.jsx("button",{onClick:()=>ae(!1),className:"btn-secondary",children:"Annulla"})]})]})]})}),e.jsx(w,{isOpen:qs,onClose:()=>Ne(!1),title:"Trasferisci Tavolo",size:"md",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-dark-400",children:"Seleziona il nuovo tavolo:"}),e.jsx("div",{className:"grid grid-cols-3 gap-3 max-h-64 overflow-y-auto",children:C.filter(s=>s.id!==l?.table_id&&oe(s.id)==="available").map(s=>e.jsxs("button",{onClick:()=>ut(s.id),className:"p-4 bg-dark-900 rounded-xl hover:bg-dark-800 transition-colors text-center",children:[e.jsx("p",{className:"font-semibold text-white",children:s.name}),e.jsxs("p",{className:"text-sm text-dark-400",children:[s.capacity," posti"]})]},s.id))}),C.filter(s=>s.id!==l?.table_id&&oe(s.id)==="available").length===0&&e.jsx("p",{className:"text-center text-dark-400 py-4",children:"Nessun tavolo libero disponibile"}),e.jsx("button",{onClick:()=>Ne(!1),className:"btn-secondary w-full",children:"Annulla"})]})}),e.jsx(Kt,{isOpen:pe,onClose:()=>Y(!1),session:l?{id:l.id,total:l.total}:null,sessionPayments:U,remainingAmount:f,remainingSessionItems:g,sessionCovers:D,sessionCoverUnitPrice:B,sessionIncludesCover:Ze,onToggleSessionCover:async()=>{},splitMode:Os,setSplitMode:Ae,selectedItems:ye,onIncrementItem:bt,onDecrementItem:jt,onApplyItemsSelection:Nt,onToggleAllItemQuantity:vt,splitPaymentForm:V,onChangeSplitPaymentForm:s=>ge(t=>({...t,...s})),changeCalculator:S,onChangeChangeCalculator:s=>ee(t=>({...t,...s})),onAddSplitPayment:yt,calculateSelectedItemsTotal:bs,calculateSplitChange:gt,smacEnabled:M,onPrintPaymentReceipt:js,formatPrice:s=>L(s),coverSelectedCount:v,onChangeCoverSelectedCount:re}),e.jsx(w,{isOpen:Us,onClose:()=>Oe(!1),title:"Stato del Conto",size:"2xl",children:l&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 p-4 bg-dark-900 rounded-xl",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Totale"}),e.jsxs("p",{className:"text-lg font-bold text-white",children:["€",(l?.total??0).toFixed(2)]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Pagato"}),e.jsxs("p",{className:"text-lg font-bold text-emerald-400",children:["€",((l?.total??0)-f).toFixed(2)]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Rimanente"}),e.jsxs("p",{className:"text-lg font-bold text-primary-400",children:["€",f.toFixed(2)]})]})]}),e.jsxs("div",{className:"md:grid md:grid-cols-2 md:gap-6",children:[U.length>0?e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-medium text-dark-400 mb-3",children:["Pagamenti effettuati (",U.length,")"]}),e.jsx("div",{className:"space-y-3 max-h-64 md:max-h-80 overflow-y-auto",children:U.map((s,t)=>e.jsxs("div",{className:"p-4 bg-dark-900 rounded-xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.payment_method==="cash"&&e.jsx(de,{className:"w-5 h-5 text-emerald-400"}),s.payment_method==="card"&&e.jsx(Te,{className:"w-5 h-5 text-blue-400"}),s.payment_method==="online"&&e.jsx(As,{className:"w-5 h-5 text-purple-400"}),e.jsxs("span",{className:"font-semibold text-white",children:["Pagamento #",t+1]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-lg font-bold text-primary-400",children:["€",s.amount.toFixed(2)]}),M&&s.smac_passed&&e.jsx("span",{className:"text-xs bg-primary-500/20 text-primary-400 px-2 py-0.5 rounded-full",children:"SMAC"})]})]}),e.jsxs("div",{className:"text-sm text-dark-400 space-y-1",children:[e.jsxs("p",{children:["Metodo: ",s.payment_method==="cash"?"Contanti":s.payment_method==="card"?"Carta":"Online"]}),e.jsxs("p",{children:["Data: ",new Date(s.paid_at).toLocaleString("it-IT")]}),s.notes&&e.jsxs("p",{children:["Note: ",s.notes]})]}),s.paid_items&&s.paid_items.length>0&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-dark-700",children:[e.jsx("p",{className:"text-xs text-dark-500 mb-2",children:"Prodotti pagati:"}),e.jsx("div",{className:"space-y-1",children:s.paid_items.map((a,n)=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-dark-300",children:[a.quantity,"x ",a.menu_item_name]}),e.jsxs("span",{className:"text-dark-400",children:["€",(a.price*a.quantity).toFixed(2)]})]},n))})]}),e.jsxs("button",{onClick:()=>js(s),className:"mt-3 w-full btn-secondary text-sm py-2 flex items-center justify-center gap-2",children:[e.jsx(Me,{className:"w-4 h-4"}),"Stampa Scontrino"]})]},s.id))})]}):e.jsxs("div",{className:"p-6 bg-dark-900 rounded-xl text-center",children:[e.jsx(zs,{className:"w-12 h-12 mx-auto mb-3 text-dark-600"}),e.jsx("p",{className:"text-dark-400",children:"Nessun pagamento ancora effettuato"})]}),e.jsx("div",{className:"mt-4 md:mt-0",children:g.length>0?e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-dark-400 mb-3",children:"Prodotti ancora da pagare"}),D>0&&B>0&&e.jsxs("div",{className:`p-3 rounded-lg border-2 ${v>0?"border-blue-500 bg-blue-500/10":"border-dark-700"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:"Coperto"}),e.jsxs("p",{className:"text-xs text-dark-400",children:[L(B)," cad."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>re(Math.max(0,v-1)),className:"w-8 h-8 rounded bg-dark-700",children:"-"}),e.jsx("span",{className:"w-8 text-center font-bold",children:v}),e.jsx("button",{onClick:()=>re(Math.min(D,v+1)),className:"w-8 h-8 rounded bg-dark-700",children:"+"})]})]}),v>0&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-dark-700 flex justify-between",children:[e.jsxs("span",{className:"text-xs text-dark-400",children:[v,"/",D," selezionati"]}),e.jsx("span",{className:"text-sm font-semibold text-blue-400",children:L(v*B)})]})]}),e.jsx("div",{className:"space-y-2 max-h-48 md:max-h-80 overflow-y-auto",children:g.map(s=>e.jsxs("div",{className:"flex justify-between p-2 bg-dark-900 rounded-lg",children:[e.jsxs("span",{className:"text-white",children:[s.remainingQty,"x ",s.menu_item_name]}),e.jsxs("span",{className:"text-primary-400",children:["€",(s.price*s.remainingQty).toFixed(2)]})]},s.id))})]}):e.jsxs("div",{className:"p-6 bg-emerald-500/10 border border-emerald-500/30 rounded-xl text-center",children:[e.jsx(Fs,{className:"w-12 h-12 mx-auto mb-3 text-emerald-400"}),e.jsx("p",{className:"text-emerald-400 font-medium",children:"Tutto pagato!"})]})})]}),e.jsx("button",{onClick:()=>Oe(!1),className:"btn-secondary w-full",children:"Chiudi"})]})}),e.jsx(w,{isOpen:Bs,onClose:()=>Ie(!1),title:"Scontrino",size:"sm",children:m&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white text-black p-6 rounded-lg font-mono text-sm",children:[e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("p",{className:"font-bold text-lg",children:m?.shop_info?.name}),m?.shop_info?.address&&e.jsx("p",{className:"text-xs",children:m?.shop_info?.address}),m?.shop_info?.phone&&e.jsxs("p",{className:"text-xs",children:["Tel: ",m?.shop_info?.phone]})]}),e.jsx("div",{className:"border-t border-dashed border-gray-400 my-3"}),e.jsx("div",{className:"text-xs mb-3",children:e.jsxs("p",{children:["Data: ",m?.date," ",m?.time]})}),e.jsx("div",{className:"border-t border-dashed border-gray-400 my-3"}),e.jsx("div",{className:"space-y-1",children:(m?.items||[]).map((s,t)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:[s.quantity,"x ",s.name]}),e.jsxs("span",{children:["€",s.total.toFixed(2)]})]},t))}),e.jsx("div",{className:"border-t border-dashed border-gray-400 my-3"}),e.jsxs("div",{className:"flex justify-between font-bold text-lg",children:[e.jsx("span",{children:"TOTALE"}),e.jsxs("span",{children:["€",(m?.total??0).toFixed(2)]})]}),e.jsxs("div",{className:"text-xs mt-3",children:[e.jsxs("p",{children:["Pagamento: ",m?.payment_method==="cash"?"Contanti":m?.payment_method==="card"?"Carta":"Online"]}),M&&m?.smac_passed&&e.jsx("p",{children:"SMAC: Sì"})]}),e.jsx("div",{className:"border-t border-dashed border-gray-400 my-3"}),e.jsx("div",{className:"text-center text-xs",children:e.jsx("p",{children:"Grazie e arrivederci!"})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:Ct,className:"btn-primary flex-1 flex items-center justify-center gap-2",children:[e.jsx(Me,{className:"w-5 h-5"}),"Stampa"]}),e.jsx("button",{onClick:()=>Ie(!1),className:"btn-secondary",children:"Chiudi"})]})]})})]})}export{oa as Tables,oa as default};
