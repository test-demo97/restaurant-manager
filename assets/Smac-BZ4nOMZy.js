import{d as R,u as W,r as m,D as Y,a2 as Z,t as d,j as e,R as ee,c as C,v as _,h as se,bb as ae,bc as $,E as te,F}from"./index-BXDN7nMf.js";import{u as re}from"./useCurrency-CLhcENHk.js";import{C as ie}from"./calendar-DYpSHTt3.js";import{C as ne}from"./chevron-down-B-nxkYmA.js";import{C as le}from"./chevron-right-C7FhHSIh.js";const ce=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"m9 15 2 2 4-4",key:"1grp1n"}]],z=R("file-check",ce);const me=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"m14.5 12.5-5 5",key:"b62r18"}],["path",{d:"m9.5 12.5 5 5",key:"1rk7el"}]],de=R("file-x",me);async function L(g,b){if(te&&F){const{error:x}=await F.from("orders").update({smac_passed:b}).eq("id",g);if(x)throw x}else{const x="kebab_",h=JSON.parse(localStorage.getItem(x+"orders")||"[]"),v=h.findIndex(y=>y.id===g);v!==-1&&(h[v].smac_passed=b,localStorage.setItem(x+"orders",JSON.stringify(h)))}}function fe(){W();const[g,b]=m.useState([]),[x,h]=m.useState({}),{formatPrice:v}=re(),[y,M]=m.useState(!0),[S,E]=m.useState(new Date().toISOString().split("T")[0]),[j,V]=m.useState([]),[N,A]=m.useState("all"),[G,q]=m.useState(new Set);m.useEffect(()=>{k()},[S]),m.useEffect(()=>{let s=!0;async function r(){try{const a=[],t=[],l=new Date().toISOString().slice(0,10);for(let n=0;n<7;n++){const o=new Date;o.setDate(o.getDate()-n);const u=o.toISOString().slice(0,10);u!==l&&t.push(ae(u).then(c=>({date:u,non_smac_total:c.non_smac_total})))}(await Promise.all(t)).forEach(n=>{n.non_smac_total&&n.non_smac_total>.001&&a.push(n)}),s&&V(a)}catch(i){console.error("Error loading SMAC alerts:",i)}}return r(),()=>{s=!1}},[]);async function k(){M(!0);try{const r=(await Y(S)).filter(t=>t.status!=="cancelled");b(r);const i=[...new Set(r.filter(t=>t.session_id).map(t=>t.session_id))],a={};await Promise.all(i.map(async t=>{const l=await Z(t);a[t]=l})),h(a)}catch(s){console.error("Error loading orders:",s),d("Errore nel caricamento ordini","error")}finally{M(!1)}}const p=(()=>{const s={},r=[];g.forEach(a=>{a.session_id?(s[a.session_id]||(s[a.session_id]=[]),s[a.session_id].push(a)):r.push(a)});const i=[];return Object.entries(s).forEach(([a,t])=>{const l=t[0],P=t.reduce((c,f)=>c+f.total,0),n=x[Number(a)]||[];let o=l.smac_passed,u=0;if(n.length>0){const c=n.filter(f=>f.smac_passed);u=c.reduce((f,U)=>f+U.amount,0),c.length===0?o=!1:c.length===n.length?o=!0:o="partial"}else u=l.smac_passed?P:0;i.push({type:"session",sessionId:Number(a),orders:t.sort((c,f)=>(c.order_number||0)-(f.order_number||0)),payments:n,total:P,tableName:l.table_name,customerName:l.customer_name,smacPassed:o,smacAmount:u})}),r.forEach(a=>{i.push({type:"single",orders:[a],payments:[],total:a.total,tableName:a.table_name,customerName:a.customer_name,smacPassed:a.smac_passed,smacAmount:a.smac_passed?a.total:0})}),i.sort((a,t)=>new Date(t.orders[0].created_at).getTime()-new Date(a.orders[0].created_at).getTime())})(),D=p.filter(s=>N==="passed"?s.smacPassed===!0:N==="not_passed"?s.smacPassed===!1||s.smacPassed==="partial":!0),T=p.reduce((s,r)=>s+r.smacAmount,0),I=p.reduce((s,r)=>s+(r.total-r.smacAmount),0),O=p.filter(s=>s.smacPassed===!0).length,w=p.filter(s=>s.smacPassed===!1||s.smacPassed==="partial").length;function J(s){q(r=>{const i=new Set(r);return i.has(s)?i.delete(s):i.add(s),i})}async function X(s){try{const r=!s.smacPassed;for(const i of s.orders)await L(i.id,r);b(i=>i.map(a=>s.orders.some(t=>t.id===a.id)?{...a,smac_passed:r}:a)),d(r?"SMAC registrata":"SMAC rimossa","success")}catch(r){console.error("Error updating SMAC:",r),d("Errore nell'aggiornamento","error")}}async function B(s){try{const r=s.smacPassed!==!0;for(const i of s.payments)await $(i.id,r);s.sessionId&&h(i=>({...i,[s.sessionId]:i[s.sessionId].map(a=>({...a,smac_passed:r}))})),d(r?"SMAC registrata per tutti i pagamenti":"SMAC rimossa da tutti i pagamenti","success")}catch(r){console.error("Error updating payments SMAC:",r),d("Errore nell'aggiornamento","error")}}async function Q(s,r){try{const i=!s.smac_passed;await $(s.id,i),h(a=>({...a,[r]:a[r].map(t=>t.id===s.id?{...t,smac_passed:i}:t)})),d(i?"SMAC registrata":"SMAC rimossa","success")}catch(i){console.error("Error updating payment SMAC:",i),d("Errore nell'aggiornamento","error")}}async function H(){if(confirm(`Segnare tutti i ${w} ordini/conti come SMAC passata?`))try{for(const s of g.filter(r=>!r.smac_passed))await L(s.id,!0);d(`${w} ordini/conti segnati come SMAC passata`,"success"),k()}catch(s){console.error("Error updating SMAC:",s),d("Errore nell'aggiornamento","error")}}const K=s=>new Date(s).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"});return y?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-500"})}):e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-white",children:"Dichiarazioni SMAC"}),e.jsx("p",{className:"text-dark-400 mt-1 text-xs sm:text-sm",children:"Gestione SMAC per la dichiarazione fiscale"})]}),e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[e.jsx("button",{onClick:k,className:"btn-secondary p-2 sm:px-4 sm:py-2",children:e.jsx(ee,{className:"w-4 h-4 sm:w-5 sm:h-5"})}),w>0&&e.jsxs("button",{onClick:H,className:"btn-primary text-xs sm:text-sm flex-1 sm:flex-none justify-center",children:[e.jsx(C,{className:"w-4 h-4 sm:w-5 sm:h-5"}),e.jsx("span",{className:"hidden sm:inline",children:"Segna Tutti come"})," Passati"]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 sm:gap-4",children:[e.jsx(ie,{className:"w-5 h-5 text-dark-400 hidden sm:block"}),e.jsx("input",{type:"date",value:S,onChange:s=>E(s.target.value),className:"input w-auto text-sm sm:text-base"}),e.jsx("span",{className:"text-dark-400 text-sm sm:text-base hidden sm:inline",children:K(S)})]}),j&&j.length>0&&e.jsx("div",{className:"card p-3 bg-amber-500/10 border border-amber-500/30",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-amber-400",children:"Avviso SMAC"}),e.jsx("p",{className:"text-sm text-dark-400",children:"Sono presenti ricavi non SMAC nei giorni recenti:"}),e.jsx("div",{className:"text-sm text-white mt-1",children:j.map(s=>e.jsxs("span",{className:"mr-3",children:[new Date(s.date).toLocaleDateString("it-IT")," — ",v(s.non_smac_total)]},s.date))})]}),e.jsx("div",{children:e.jsx("button",{onClick:()=>{j&&j.length&&(E(j[0].date),k())},className:"btn-secondary",children:"Controlla"})})]})}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-2 sm:gap-4",children:[e.jsx("div",{className:"stat-card",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"stat-label text-xs sm:text-sm",children:"Totali"}),e.jsx("p",{className:"stat-value text-lg sm:text-2xl",children:p.length}),e.jsxs("p",{className:"text-xs text-dark-500",children:[g.length," comande"]})]}),e.jsx("div",{className:"w-8 h-8 sm:w-12 sm:h-12 rounded-xl bg-blue-500/20 flex items-center justify-center flex-shrink-0",children:e.jsx(z,{className:"w-4 h-4 sm:w-6 sm:h-6 text-blue-400"})})]})}),e.jsx("div",{className:"stat-card glow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"stat-label text-xs sm:text-sm",children:"SMAC Passata"}),e.jsxs("p",{className:"stat-value text-emerald-400 text-lg sm:text-2xl",children:["€",T.toFixed(2)]}),e.jsxs("p",{className:"text-xs text-dark-500",children:[O," conti"]})]}),e.jsx("div",{className:"w-8 h-8 sm:w-12 sm:h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center flex-shrink-0",children:e.jsx(C,{className:"w-4 h-4 sm:w-6 sm:h-6 text-emerald-400"})})]})}),e.jsx("div",{className:"stat-card",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"stat-label text-xs sm:text-sm",children:"Non Passata"}),e.jsxs("p",{className:"stat-value text-amber-400 text-lg sm:text-2xl",children:["€",I.toFixed(2)]}),e.jsxs("p",{className:"text-xs text-dark-500",children:[w," conti"]})]}),e.jsx("div",{className:"w-8 h-8 sm:w-12 sm:h-12 rounded-xl bg-amber-500/20 flex items-center justify-center flex-shrink-0",children:e.jsx(_,{className:"w-4 h-4 sm:w-6 sm:h-6 text-amber-400"})})]})}),e.jsx("div",{className:"stat-card",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"stat-label text-xs sm:text-sm",children:"Incasso"}),e.jsxs("p",{className:"stat-value text-lg sm:text-2xl",children:["€",(T+I).toFixed(2)]})]}),e.jsx("div",{className:"w-8 h-8 sm:w-12 sm:h-12 rounded-xl bg-primary-500/20 flex items-center justify-center flex-shrink-0",children:e.jsx(z,{className:"w-4 h-4 sm:w-6 sm:h-6 text-primary-400"})})]})})]}),e.jsxs("div",{className:"flex items-center gap-2 overflow-x-auto -mx-4 px-4 sm:mx-0 sm:px-0",children:[e.jsxs("button",{onClick:()=>A("all"),className:`px-3 sm:px-4 py-1.5 sm:py-2 rounded-xl font-medium transition-all text-xs sm:text-sm whitespace-nowrap ${N==="all"?"bg-primary-500 text-dark-900":"bg-dark-800 text-dark-300 hover:bg-dark-700"}`,children:["Tutti (",p.length,")"]}),e.jsx("button",{onClick:()=>A("passed"),className:`px-3 sm:px-4 py-1.5 sm:py-2 rounded-xl font-medium transition-all text-xs sm:text-sm whitespace-nowrap ${N==="passed"?"bg-emerald-500 text-white":"bg-dark-800 text-dark-300 hover:bg-dark-700"}`,children:e.jsxs("span",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(C,{className:"w-3 h-3 sm:w-4 sm:h-4"}),"Passata (",O,")"]})}),e.jsx("button",{onClick:()=>A("not_passed"),className:`px-3 sm:px-4 py-1.5 sm:py-2 rounded-xl font-medium transition-all text-xs sm:text-sm whitespace-nowrap ${N==="not_passed"?"bg-amber-500 text-dark-900":"bg-dark-800 text-dark-300 hover:bg-dark-700"}`,children:e.jsxs("span",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(_,{className:"w-3 h-3 sm:w-4 sm:h-4"}),"Non Passata (",w,")"]})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{className:"font-semibold text-white text-sm sm:text-base",children:"Ordini del Giorno"})}),e.jsx("div",{className:"divide-y divide-dark-700",children:D.length===0?e.jsxs("div",{className:"p-6 sm:p-8 text-center text-dark-400",children:[e.jsx(de,{className:"w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm sm:text-base",children:"Nessun ordine trovato per questa data"})]}):D.map(s=>{const r=s.type==="session"&&s.orders.length>1,i=r&&G.has(s.sessionId),a=s.orders[0];return e.jsxs("div",{children:[e.jsxs("div",{className:`flex items-center justify-between p-3 sm:p-4 hover:bg-dark-900/50 transition-colors gap-2 ${r?"cursor-pointer":""}`,onClick:r?()=>J(s.sessionId):void 0,children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-4 min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2 flex-shrink-0",children:[e.jsx("div",{className:"w-5 sm:w-6 flex items-center justify-center",children:r?i?e.jsx(ne,{className:"w-4 h-4 sm:w-5 sm:h-5 text-dark-400"}):e.jsx(le,{className:"w-4 h-4 sm:w-5 sm:h-5 text-dark-400"}):null}),e.jsx("div",{className:`w-8 h-8 sm:w-12 sm:h-12 rounded-xl flex items-center justify-center ${s.smacPassed===!0?"bg-emerald-500/20":s.smacPassed==="partial"?"bg-blue-500/20":"bg-amber-500/20"}`,children:s.smacPassed===!0?e.jsx(C,{className:"w-4 h-4 sm:w-6 sm:h-6 text-emerald-400"}):s.smacPassed==="partial"?e.jsx(_,{className:"w-4 h-4 sm:w-6 sm:h-6 text-blue-400"}):e.jsx(_,{className:"w-4 h-4 sm:w-6 sm:h-6 text-amber-400"})})]}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"font-semibold text-white text-sm sm:text-base",children:r?e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"whitespace-nowrap",children:["Conto - ",s.tableName]}),e.jsxs("span",{className:"block sm:inline text-xs text-dark-400 sm:ml-2",children:[s.payments.length>0&&`(${s.payments.length} pag.) `,"(",s.orders.length," com.)"]})]}):`#${a.id}`}),e.jsxs("div",{className:"flex flex-wrap items-center gap-1 sm:gap-3 text-xs sm:text-sm text-dark-400",children:[e.jsx("span",{children:a.order_type==="dine_in"?`T.${s.tableName||a.table_id}`:a.order_type==="takeaway"?"Asporto":"Domicilio"}),e.jsx("span",{className:"hidden sm:inline",children:"•"}),e.jsx("span",{className:"hidden sm:inline",children:a.payment_method==="cash"?"Contanti":a.payment_method==="card"?"Carta":"Online"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 sm:gap-4 flex-shrink-0",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-base sm:text-xl font-bold text-primary-400",children:["€",s.total.toFixed(2)]}),e.jsx("p",{className:`text-xs sm:text-sm ${s.smacPassed===!0?"text-emerald-400":s.smacPassed==="partial"?"text-blue-400":"text-amber-400"}`,children:s.smacPassed===!0?"Passata":s.smacPassed==="partial"?e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"block",children:["Parziale (€",s.smacAmount.toFixed(2),")"]}),e.jsxs("span",{className:"block sm:inline",children:["Manc. €",(s.total-s.smacAmount).toFixed(2)]})]}):"Non Passata"})]}),e.jsx("button",{onClick:t=>{t.stopPropagation(),s.payments.length>0?B(s):X(s)},className:`p-2 sm:p-3 rounded-xl transition-all ${s.smacPassed===!0?"bg-emerald-500 text-white hover:bg-emerald-600":"bg-dark-700 text-dark-300 hover:bg-amber-500 hover:text-dark-900"}`,title:s.smacPassed===!0?"Rimuovi SMAC":"Segna come SMAC passata",children:e.jsx(se,{className:"w-4 h-4 sm:w-5 sm:h-5"})})]})]}),r&&i&&e.jsx("div",{className:"bg-dark-900/30 border-t border-dark-700",children:s.payments.length>0?s.payments.map(t=>e.jsxs("div",{className:"flex items-center justify-between px-3 sm:px-4 py-2 sm:py-3 pl-10 sm:pl-20 border-b border-dark-800 last:border-b-0",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[e.jsx("span",{className:"text-dark-500",children:"└"}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-xs sm:text-sm text-white font-medium",children:["€",t.amount.toFixed(2),t.notes&&e.jsxs("span",{className:"text-dark-400 ml-2 font-normal",children:["(",t.notes,")"]})]}),e.jsxs("p",{className:"text-xs text-dark-500",children:[t.payment_method==="cash"?"Contanti":t.payment_method==="card"?"Carta":"Online"," • ",new Date(t.paid_at).toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})]})]})]}),e.jsxs("button",{onClick:l=>{l.stopPropagation(),Q(t,s.sessionId)},className:`flex items-center gap-1 text-xs px-2 py-1 rounded transition-all ${t.smac_passed?"bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500/40":"bg-red-500/20 text-red-400 hover:bg-red-500/40"}`,title:t.smac_passed?"Rimuovi SMAC":"Segna come SMAC passata",children:["SMAC ",t.smac_passed?"✓":"✗"]})]},t.id)):s.orders.map(t=>e.jsxs("div",{className:"flex items-center justify-between px-3 sm:px-4 py-2 sm:py-3 pl-10 sm:pl-20 border-b border-dark-800 last:border-b-0",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[e.jsx("span",{className:"text-dark-500",children:"└"}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-xs sm:text-sm text-dark-300",children:["Comanda ",t.order_number||1]}),e.jsx("p",{className:"text-xs text-dark-500",children:new Date(t.created_at).toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("p",{className:"text-xs sm:text-sm font-medium text-dark-300",children:["€",t.total.toFixed(2)]})]},t.id))})]},s.type==="session"?`session-${s.sessionId}`:`order-${a.id}`)})})]}),e.jsxs("div",{className:"bg-blue-500/10 border border-blue-500/30 rounded-xl p-3 sm:p-4",children:[e.jsx("h3",{className:"font-semibold text-blue-400 mb-2 text-sm sm:text-base",children:"Cos'è la SMAC?"}),e.jsxs("p",{className:"text-xs sm:text-sm text-dark-300",children:["La ",e.jsx("strong",{children:"SMAC"})," (Carta Servizi) è il sistema di San Marino per la tracciabilità delle transazioni commerciali. Quando un cliente presenta la sua carta SMAC al momento del pagamento, l'importo viene registrato per beneficiare di detrazioni fiscali."]})]})]})}export{fe as Smac};
