import{u as Q,i as X,r,bf as J,bg as K,D as Y,t as o,j as e,H as Z,bc as E,c as R,Q as ee,f as se,bh as te,O as D,M as b,bi as ae,bj as le}from"./index-CraoOkNm.js";import{C as ne}from"./calendar-CTpBwHKA.js";import{B as re}from"./banknote-w54ZrSRe.js";import{S as ie}from"./smartphone-CpqxaWqY.js";import{F as ce}from"./file-text-DoyU40tA.js";import{T as de}from"./trending-up-CQ9T6PRH.js";import{T as me}from"./trending-down-Bck4XmO5.js";import{P as xe}from"./printer-EkMAB1w3.js";function ve(){Q();const{smacEnabled:u}=X(),[c,T]=r.useState(new Date().toISOString().split("T")[0]),[A,v]=r.useState(!0),[a,O]=r.useState(null),[N,z]=r.useState([]),[h,U]=r.useState([]),[I,p]=r.useState(!1),[M,g]=r.useState(!1),[$,w]=r.useState(!1),[l,L]=r.useState(null),[d,y]=r.useState(""),[x,C]=r.useState(""),[_,k]=r.useState(""),f=r.useRef(null);r.useEffect(()=>{S()},[c]);async function S(){v(!0);try{const[s,t,i]=await Promise.all([J(c),K(),Y(c)]);O(s),z(t),U(i.filter(m=>m.status!=="cancelled"))}catch(s){console.error("Error loading data:",s),o("Errore nel caricamento dati","error")}finally{v(!1)}}const F=N.some(s=>s.date===c);async function P(){if(!d||!x){o("Inserisci fondo cassa iniziale e finale","error");return}const s=parseFloat(d),t=parseFloat(x);if(isNaN(s)||isNaN(t)||s<0||t<0){o("Inserisci valori numerici validi","error");return}const i=s+(a?.cash_revenue||0),m=t-i;try{await le({date:c,opening_cash:s,closing_cash:t,expected_cash:i,difference:m,total_orders:a?.total_orders||0,total_revenue:a?.total_revenue||0,cash_revenue:a?.cash_revenue||0,card_revenue:a?.card_revenue||0,online_revenue:a?.online_revenue||0,smac_total:a?.smac_total||0,non_smac_total:a?.non_smac_total||0,notes:_,closed_by:"Admin"}),o("Chiusura cassa salvata con successo","success"),p(!1),y(""),C(""),k(""),S()}catch(n){console.error("Error saving closure:",n),o("Errore nel salvataggio","error")}}async function H(s){try{const t=await ae(s);t&&(L(t),w(!0))}catch(t){console.error("Error generating receipt:",t),o("Errore nella generazione scontrino","error")}}function B(){if(f.current){const s=f.current.innerHTML,t=window.open("","_blank");t&&(t.document.write(`
          <html>
            <head>
              <title>Scontrino</title>
              <style>
                body { font-family: 'Courier New', monospace; padding: 20px; max-width: 300px; margin: 0 auto; }
                .header { text-align: center; margin-bottom: 20px; }
                .shop-name { font-size: 18px; font-weight: bold; }
                .divider { border-top: 1px dashed #000; margin: 10px 0; }
                .item { display: flex; justify-content: space-between; margin: 5px 0; }
                .total { font-weight: bold; font-size: 16px; }
                .footer { text-align: center; margin-top: 20px; font-size: 12px; }
              </style>
            </head>
            <body>${s}</body>
          </html>
        `),t.document.close(),t.print())}}const G=s=>new Date(s).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"});return A?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-500"})}):e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-white",children:"Chiusura Cassa"}),e.jsx("p",{className:"text-dark-400 mt-1 text-sm sm:text-base",children:"Riepilogo giornaliero e scontrini"})]}),e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[e.jsxs("button",{onClick:()=>g(!0),className:"btn-secondary text-sm sm:text-base px-3 py-2 sm:px-4 sm:py-2.5",children:[e.jsx(Z,{className:"w-4 h-4 sm:w-5 sm:h-5"}),"Storico"]}),!F&&a&&a.total_orders>0&&e.jsxs("button",{onClick:()=>p(!0),className:"btn-primary text-sm sm:text-base px-3 py-2 sm:px-4 sm:py-2.5",children:[e.jsx(E,{className:"w-4 h-4 sm:w-5 sm:h-5"}),"Chiudi Cassa"]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 sm:gap-4",children:[e.jsx(ne,{className:"w-5 h-5 text-dark-400 hidden sm:block"}),e.jsx("input",{type:"date",value:c,onChange:s=>T(s.target.value),className:"input w-auto text-sm sm:text-base"}),e.jsx("span",{className:"text-dark-400 text-sm sm:text-base hidden sm:inline",children:G(c)}),F&&e.jsxs("span",{className:"px-2 py-1 sm:px-3 bg-emerald-500/20 text-emerald-400 rounded-full text-xs sm:text-sm flex items-center gap-1",children:[e.jsx(R,{className:"w-3 h-3 sm:w-4 sm:h-4"}),"Cassa Chiusa"]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4",children:[e.jsx("div",{className:"stat-card glow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"stat-label text-xs sm:text-sm",children:"Incasso Totale"}),e.jsxs("p",{className:"stat-value text-primary-400 text-lg sm:text-2xl",children:["€",a?.total_revenue.toFixed(2)]}),e.jsxs("p",{className:"text-xs text-dark-500 mt-1",children:[a?.total_orders," ordini"]})]}),e.jsx("div",{className:"w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-primary-500/20 flex items-center justify-center flex-shrink-0",children:e.jsx(ee,{className:"w-5 h-5 sm:w-6 sm:h-6 text-primary-400"})})]})}),e.jsx("div",{className:"stat-card",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"stat-label text-xs sm:text-sm",children:"Contanti"}),e.jsxs("p",{className:"stat-value text-emerald-400 text-lg sm:text-2xl",children:["€",a?.cash_revenue.toFixed(2)]})]}),e.jsx("div",{className:"w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center flex-shrink-0",children:e.jsx(re,{className:"w-5 h-5 sm:w-6 sm:h-6 text-emerald-400"})})]})}),e.jsx("div",{className:"stat-card",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"stat-label text-xs sm:text-sm",children:"Carta"}),e.jsxs("p",{className:"stat-value text-blue-400 text-lg sm:text-2xl",children:["€",a?.card_revenue.toFixed(2)]})]}),e.jsx("div",{className:"w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-blue-500/20 flex items-center justify-center flex-shrink-0",children:e.jsx(se,{className:"w-5 h-5 sm:w-6 sm:h-6 text-blue-400"})})]})}),e.jsx("div",{className:"stat-card",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"stat-label text-xs sm:text-sm",children:"Online"}),e.jsxs("p",{className:"stat-value text-purple-400 text-lg sm:text-2xl",children:["€",a?.online_revenue.toFixed(2)]})]}),e.jsx("div",{className:"w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-purple-500/20 flex items-center justify-center flex-shrink-0",children:e.jsx(ie,{className:"w-5 h-5 sm:w-6 sm:h-6 text-purple-400"})})]})})]}),u&&e.jsxs("div",{className:"grid grid-cols-2 gap-3 sm:gap-4",children:[e.jsxs("div",{className:"card p-3 sm:p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 mb-2 sm:mb-3",children:[e.jsx(R,{className:"w-4 h-4 sm:w-5 sm:h-5 text-emerald-400"}),e.jsx("h3",{className:"font-semibold text-white text-sm sm:text-base",children:"SMAC Passata"})]}),e.jsxs("p",{className:"text-xl sm:text-2xl font-bold text-emerald-400",children:["€",a?.smac_total.toFixed(2)]})]}),e.jsxs("div",{className:"card p-3 sm:p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 mb-2 sm:mb-3",children:[e.jsx(te,{className:"w-4 h-4 sm:w-5 sm:h-5 text-amber-400"}),e.jsx("h3",{className:"font-semibold text-white text-sm sm:text-base",children:"SMAC Non Passata"})]}),e.jsxs("p",{className:"text-xl sm:text-2xl font-bold text-amber-400",children:["€",a?.non_smac_total.toFixed(2)]})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{className:"font-semibold text-white text-sm sm:text-base",children:"Ordini per Tipologia"})}),e.jsxs("div",{className:"p-3 sm:p-4 grid grid-cols-3 gap-2 sm:gap-4",children:[e.jsxs("div",{className:"text-center p-2 sm:p-4 bg-dark-800 rounded-xl",children:[e.jsx("p",{className:"text-xl sm:text-3xl font-bold text-white",children:a?.orders_by_type.dine_in||0}),e.jsx("p",{className:"text-dark-400 text-xs sm:text-sm",children:"In Sala"})]}),e.jsxs("div",{className:"text-center p-2 sm:p-4 bg-dark-800 rounded-xl",children:[e.jsx("p",{className:"text-xl sm:text-3xl font-bold text-white",children:a?.orders_by_type.takeaway||0}),e.jsx("p",{className:"text-dark-400 text-xs sm:text-sm",children:"Asporto"})]}),e.jsxs("div",{className:"text-center p-2 sm:p-4 bg-dark-800 rounded-xl",children:[e.jsx("p",{className:"text-xl sm:text-3xl font-bold text-white",children:a?.orders_by_type.delivery||0}),e.jsx("p",{className:"text-dark-400 text-xs sm:text-sm",children:"Domicilio"})]})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("h2",{className:"font-semibold text-white flex items-center gap-2 text-sm sm:text-base",children:[e.jsx(D,{className:"w-4 h-4 sm:w-5 sm:h-5"}),"Ordini del Giorno (",h.length," ",h.length===1?"comanda":"comande",")"]})}),e.jsx("div",{className:"divide-y divide-dark-700 max-h-80 sm:max-h-96 overflow-y-auto",children:h.length===0?e.jsxs("div",{className:"p-6 sm:p-8 text-center text-dark-400",children:[e.jsx(ce,{className:"w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm sm:text-base",children:"Nessun ordine per questa data"})]}):(()=>{const s={};return h.forEach(t=>{const i=t.session_id?`session_${t.session_id}`:`order_${t.id}`;s[i]||(s[i]=[]),s[i].push(t)}),Object.entries(s).map(([t,i])=>{const m=t.startsWith("session_"),n=i[0],V=i.reduce((q,W)=>q+W.total,0),j=i.length;return e.jsxs("div",{className:"flex items-center justify-between p-3 sm:p-4 hover:bg-dark-900/50 transition-colors gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-4 min-w-0 flex-1",children:[e.jsx("div",{className:"w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-dark-700 flex items-center justify-center flex-shrink-0",children:m?e.jsx("span",{className:"text-xs font-bold text-primary-400",children:j>1?`${j}C`:`#${n.id}`}):e.jsxs("span",{className:"text-xs sm:text-sm font-bold text-primary-400",children:["#",n.id]})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("p",{className:"font-medium text-white text-sm sm:text-base truncate",children:[n.order_type==="dine_in"?"Tavolo":n.order_type==="takeaway"?"Asporto":"Domicilio",n.table_name&&` - ${n.table_name}`,m&&j>1&&e.jsxs("span",{className:"ml-1 sm:ml-2 text-xs text-primary-400",children:["(",j," comande)"]})]}),e.jsxs("p",{className:"text-xs sm:text-sm text-dark-400 truncate",children:[n.payment_method==="cash"?"Contanti":n.payment_method==="card"?"Carta":"Online",u&&n.smac_passed&&" • SMAC",m&&e.jsxs("span",{className:`ml-1 sm:ml-2 ${n.session_status==="open"?"text-amber-400":"text-emerald-400"}`,children:["• ",n.session_status==="open"?"Aperto":"Chiuso"]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 sm:gap-4 flex-shrink-0",children:[e.jsxs("p",{className:"text-sm sm:text-lg font-bold text-primary-400 whitespace-nowrap",children:["€",V.toFixed(2)]}),e.jsx("button",{onClick:()=>H(n.id),className:"p-1.5 sm:p-2 bg-dark-700 rounded-lg hover:bg-dark-600 transition-colors",title:"Visualizza scontrino",children:e.jsx(D,{className:"w-4 h-4 sm:w-5 sm:h-5 text-dark-300"})})]})]},t)})})()})]}),e.jsx(b,{isOpen:I,onClose:()=>p(!1),title:"Chiusura Cassa",size:"lg",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-dark-800 rounded-xl p-4 space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-dark-400",children:"Incasso Totale:"}),e.jsxs("span",{className:"font-bold text-white",children:[a?.total_revenue.toFixed(2)," EUR"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-dark-400",children:"Di cui Contanti:"}),e.jsxs("span",{className:"font-bold text-emerald-400",children:[a?.cash_revenue.toFixed(2)," EUR"]})]})]}),e.jsxs("div",{className:"md:grid md:grid-cols-2 md:gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-dark-300 mb-2",children:"Fondo Cassa Iniziale (EUR)"}),e.jsx("input",{type:"number",step:"0.01",value:d,onChange:s=>y(s.target.value),className:"input",placeholder:"Es: 100.00"})]}),e.jsxs("div",{className:"mt-4 md:mt-0",children:[e.jsx("label",{className:"block text-sm font-medium text-dark-300 mb-2",children:"Contanti in Cassa Finale (EUR)"}),e.jsx("input",{type:"number",step:"0.01",value:x,onChange:s=>C(s.target.value),className:"input",placeholder:"Es: 350.00"})]})]}),d&&x&&e.jsxs("div",{className:"bg-dark-800 rounded-xl p-4",children:[e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("span",{className:"text-dark-400",children:"Contanti Attesi:"}),e.jsxs("span",{className:"font-bold text-white",children:[(parseFloat(d)+(a?.cash_revenue||0)).toFixed(2)," EUR"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-dark-400",children:"Differenza:"}),e.jsxs("span",{className:`font-bold ${parseFloat(x)-(parseFloat(d)+(a?.cash_revenue||0))>=0?"text-emerald-400":"text-red-400"}`,children:[(parseFloat(x)-(parseFloat(d)+(a?.cash_revenue||0))).toFixed(2)," EUR"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-dark-300 mb-2",children:"Note (opzionale)"}),e.jsx("textarea",{value:_,onChange:s=>k(s.target.value),className:"input resize-none h-16",placeholder:"Eventuali note sulla chiusura..."})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{onClick:()=>p(!1),className:"btn-secondary flex-1",children:"Annulla"}),e.jsxs("button",{onClick:P,className:"btn-primary flex-1",children:[e.jsx(E,{className:"w-5 h-5"}),"Conferma Chiusura"]})]})]})}),e.jsx(b,{isOpen:M,onClose:()=>g(!1),title:"Storico Chiusure Cassa",size:"lg",children:e.jsx("div",{className:"space-y-4 max-h-96 overflow-y-auto",children:N.length===0?e.jsx("p",{className:"text-center text-dark-400 py-8",children:"Nessuna chiusura registrata"}):N.slice(0,30).map(s=>e.jsxs("div",{className:"bg-dark-800 rounded-xl p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"font-semibold text-white",children:new Date(s.date).toLocaleDateString("it-IT",{weekday:"short",day:"numeric",month:"short",year:"numeric"})}),e.jsxs("span",{className:`flex items-center gap-1 text-sm ${s.difference>=0?"text-emerald-400":"text-red-400"}`,children:[s.difference>=0?e.jsx(de,{className:"w-4 h-4"}):e.jsx(me,{className:"w-4 h-4"}),s.difference>=0?"+":"",s.difference.toFixed(2)," EUR"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-dark-400",children:"Incasso:"}),e.jsxs("span",{className:"text-white ml-2",children:[s.total_revenue.toFixed(2)," EUR"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-dark-400",children:"Ordini:"}),e.jsx("span",{className:"text-white ml-2",children:s.total_orders})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-dark-400",children:"Contanti:"}),e.jsxs("span",{className:"text-emerald-400 ml-2",children:[s.cash_revenue.toFixed(2)," EUR"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-dark-400",children:"Carta:"}),e.jsxs("span",{className:"text-blue-400 ml-2",children:[s.card_revenue.toFixed(2)," EUR"]})]})]}),s.notes&&e.jsxs("p",{className:"text-dark-500 text-sm mt-2 italic",children:['"',s.notes,'"']})]},s.id))})}),e.jsx(b,{isOpen:$,onClose:()=>w(!1),title:"Scontrino",children:l&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{ref:f,className:"bg-white text-black p-6 rounded-lg font-mono text-sm",children:[e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("p",{className:"font-bold text-lg",children:l.shop_info.name}),l.shop_info.address&&e.jsx("p",{className:"text-xs",children:l.shop_info.address}),l.shop_info.phone&&e.jsxs("p",{className:"text-xs",children:["Tel: ",l.shop_info.phone]})]}),e.jsx("div",{className:"border-t border-dashed border-gray-400 my-3"}),e.jsxs("div",{className:"text-xs mb-3",children:[e.jsxs("p",{children:["Scontrino: ",l.receipt_number]}),e.jsxs("p",{children:["Data: ",l.date," ",l.time]})]}),e.jsx("div",{className:"border-t border-dashed border-gray-400 my-3"}),e.jsx("div",{className:"space-y-1",children:l.items.map((s,t)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:[s.quantity,"x ",s.name]}),e.jsx("span",{children:s.total.toFixed(2)})]},t))}),e.jsx("div",{className:"border-t border-dashed border-gray-400 my-3"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Imponibile:"}),e.jsxs("span",{children:[l.subtotal.toFixed(2)," EUR"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["IVA (",l.iva_rate,"%):"]}),e.jsxs("span",{children:[l.iva_amount.toFixed(2)," EUR"]})]}),e.jsxs("div",{className:"flex justify-between font-bold text-base",children:[e.jsx("span",{children:"TOTALE:"}),e.jsxs("span",{children:[l.total.toFixed(2)," EUR"]})]})]}),e.jsx("div",{className:"border-t border-dashed border-gray-400 my-3"}),e.jsxs("div",{className:"text-xs text-center",children:[e.jsxs("p",{children:["Pagamento: ",l.payment_method==="cash"?"Contanti":l.payment_method==="card"?"Carta":"Online"]}),u&&l.smac_passed&&e.jsx("p",{className:"font-bold",children:"SMAC REGISTRATA"})]}),e.jsx("div",{className:"border-t border-dashed border-gray-400 my-3"}),e.jsx("p",{className:"text-center text-xs",children:"Grazie e arrivederci!"})]}),e.jsxs("button",{onClick:B,className:"btn-primary w-full",children:[e.jsx(xe,{className:"w-5 h-5"}),"Stampa Scontrino"]})]})})]})}export{ve as CashRegister};
