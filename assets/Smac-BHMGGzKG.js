import{d as V,u as ss,r as c,D as es,bb as as,a3 as ts,t as d,j as s,R as rs,c as y,v as A,h as is,bc as ns,bd as I,E as ls,F as z}from"./index-DTQOtD2j.js";import{u as cs}from"./useCurrency-CnO8RJjc.js";import{C as ms}from"./calendar-D8XHi2a0.js";import{C as ds}from"./chevron-down-WPXV6KUR.js";import{C as os}from"./chevron-right-3MLw7nJr.js";const xs=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"m9 15 2 2 4-4",key:"1grp1n"}]],L=V("file-check",xs);const hs=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"m14.5 12.5-5 5",key:"b62r18"}],["path",{d:"m9.5 12.5 5 5",key:"1rk7el"}]],ps=V("file-x",hs);async function R(j,N){if(ls&&z){const{error:h}=await z.from("orders").update({smac_passed:N}).eq("id",j);if(h)throw h}else{const h="kebab_",p=JSON.parse(localStorage.getItem(h+"orders")||"[]"),C=p.findIndex(P=>P.id===j);C!==-1&&(p[C].smac_passed=N,localStorage.setItem(h+"orders",JSON.stringify(p)))}}function Ns(){ss();const[j,N]=c.useState([]),[h,p]=c.useState({}),[C,P]=c.useState({}),{formatPrice:G}=cs(),[q,E]=c.useState(!0),[w,D]=c.useState(new Date().toISOString().split("T")[0]),[b,B]=c.useState([]),[v,M]=c.useState("all"),[J,X]=c.useState(new Set);c.useEffect(()=>{_()},[w]),c.useEffect(()=>{let e=!0;async function t(){try{const a=[],r=[],m=new Date().toISOString().slice(0,10);for(let l=0;l<7;l++){const o=new Date;o.setDate(o.getDate()-l);const x=o.toISOString().slice(0,10);x!==m&&r.push(ns(x).then(k=>({date:x,non_smac_total:k.non_smac_total})))}(await Promise.all(r)).forEach(l=>{l.non_smac_total&&l.non_smac_total>.001&&a.push(l)}),e&&B(a)}catch(i){console.error("Error loading SMAC alerts:",i)}}return t(),()=>{e=!1}},[]);async function _(){E(!0);try{const t=(await es(w)).filter(n=>n.status!=="cancelled");N(t);const i=[...new Set(t.filter(n=>n.session_id).map(n=>n.session_id))],a={},r={};(await as(w)).forEach(n=>{r[n.id]=n}),await Promise.all(i.map(async n=>{const l=await ts(n);a[n]=l})),p(a),P(r)}catch(e){console.error("Error loading orders:",e),d("Errore nel caricamento ordini","error")}finally{E(!1)}}const u=(()=>{const e={},t=[];j.forEach(a=>{a.session_id?(e[a.session_id]||(e[a.session_id]=[]),e[a.session_id].push(a)):t.push(a)});const i=[];return Object.entries(e).forEach(([a,r])=>{const m=r[0],n=C[Number(a)],l=n?n.total:r.reduce((f,g)=>f+g.total,0),o=h[Number(a)]||[];let x=m.smac_passed,k=0;if(o.length>0){const f=o.filter(g=>g.smac_passed);k=f.reduce((g,Z)=>g+Z.amount,0),f.length===0?x=!1:f.length===o.length?x=!0:x="partial"}else k=m.smac_passed?l:0;i.push({type:"session",sessionId:Number(a),orders:r.sort((f,g)=>(f.order_number||0)-(g.order_number||0)),payments:o,total:l,tableName:m.table_name,customerName:m.customer_name,smacPassed:x,smacAmount:k})}),t.forEach(a=>{i.push({type:"single",orders:[a],payments:[],total:a.total,tableName:a.table_name,customerName:a.customer_name,smacPassed:a.smac_passed,smacAmount:a.smac_passed?a.total:0})}),i.sort((a,r)=>new Date(r.orders[0].created_at).getTime()-new Date(a.orders[0].created_at).getTime())})(),T=u.filter(e=>v==="passed"?e.smacPassed===!0:v==="not_passed"?e.smacPassed===!1||e.smacPassed==="partial":!0),O=u.reduce((e,t)=>e+t.smacAmount,0),$=u.reduce((e,t)=>e+(t.total-t.smacAmount),0),F=u.filter(e=>e.smacPassed===!0).length,S=u.filter(e=>e.smacPassed===!1||e.smacPassed==="partial").length;function Q(e){X(t=>{const i=new Set(t);return i.has(e)?i.delete(e):i.add(e),i})}async function H(e){try{const t=!e.smacPassed;for(const i of e.orders)await R(i.id,t);N(i=>i.map(a=>e.orders.some(r=>r.id===a.id)?{...a,smac_passed:t}:a)),d(t?"SMAC registrata":"SMAC rimossa","success")}catch(t){console.error("Error updating SMAC:",t),d("Errore nell'aggiornamento","error")}}async function K(e){try{const t=e.smacPassed!==!0;for(const i of e.payments)await I(i.id,t);e.sessionId&&p(i=>({...i,[e.sessionId]:i[e.sessionId].map(a=>({...a,smac_passed:t}))})),d(t?"SMAC registrata per tutti i pagamenti":"SMAC rimossa da tutti i pagamenti","success")}catch(t){console.error("Error updating payments SMAC:",t),d("Errore nell'aggiornamento","error")}}async function U(e,t){try{const i=!e.smac_passed;await I(e.id,i),p(a=>({...a,[t]:a[t].map(r=>r.id===e.id?{...r,smac_passed:i}:r)})),d(i?"SMAC registrata":"SMAC rimossa","success")}catch(i){console.error("Error updating payment SMAC:",i),d("Errore nell'aggiornamento","error")}}async function W(){if(confirm(`Segnare tutti i ${S} ordini/conti come SMAC passata?`))try{for(const e of j.filter(t=>!t.smac_passed))await R(e.id,!0);d(`${S} ordini/conti segnati come SMAC passata`,"success"),_()}catch(e){console.error("Error updating SMAC:",e),d("Errore nell'aggiornamento","error")}}const Y=e=>new Date(e).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"});return q?s.jsx("div",{className:"flex items-center justify-center h-64",children:s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-500"})}):s.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[s.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-white",children:"Dichiarazioni SMAC"}),s.jsx("p",{className:"text-dark-400 mt-1 text-xs sm:text-sm",children:"Gestione SMAC per la dichiarazione fiscale"})]}),s.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[s.jsx("button",{onClick:_,className:"btn-secondary p-2 sm:px-4 sm:py-2",children:s.jsx(rs,{className:"w-4 h-4 sm:w-5 sm:h-5"})}),S>0&&s.jsxs("button",{onClick:W,className:"btn-primary text-xs sm:text-sm flex-1 sm:flex-none justify-center",children:[s.jsx(y,{className:"w-4 h-4 sm:w-5 sm:h-5"}),s.jsx("span",{className:"hidden sm:inline",children:"Segna Tutti come"})," Passati"]})]})]}),s.jsxs("div",{className:"flex flex-wrap items-center gap-2 sm:gap-4",children:[s.jsx(ms,{className:"w-5 h-5 text-dark-400 hidden sm:block"}),s.jsx("input",{type:"date",value:w,onChange:e=>D(e.target.value),className:"input w-auto text-sm sm:text-base"}),s.jsx("span",{className:"text-dark-400 text-sm sm:text-base hidden sm:inline",children:Y(w)})]}),b&&b.length>0&&s.jsx("div",{className:"card p-3 bg-amber-500/10 border border-amber-500/30",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"font-medium text-amber-400",children:"Avviso SMAC"}),s.jsx("p",{className:"text-sm text-dark-400",children:"Sono presenti ricavi non SMAC nei giorni recenti:"}),s.jsx("div",{className:"text-sm text-white mt-1",children:b.map(e=>s.jsxs("span",{className:"mr-3",children:[new Date(e.date).toLocaleDateString("it-IT")," — ",G(e.non_smac_total)]},e.date))})]}),s.jsx("div",{children:s.jsx("button",{onClick:()=>{b&&b.length&&(D(b[0].date),_())},className:"btn-secondary",children:"Controlla"})})]})}),s.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-2 sm:gap-4",children:[s.jsx("div",{className:"stat-card",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"min-w-0 flex-1",children:[s.jsx("p",{className:"stat-label text-xs sm:text-sm",children:"Totali"}),s.jsx("p",{className:"stat-value text-lg sm:text-2xl",children:u.length}),s.jsxs("p",{className:"text-xs text-dark-500",children:[j.length," comande"]})]}),s.jsx("div",{className:"w-8 h-8 sm:w-12 sm:h-12 rounded-xl bg-blue-500/20 flex items-center justify-center flex-shrink-0",children:s.jsx(L,{className:"w-4 h-4 sm:w-6 sm:h-6 text-blue-400"})})]})}),s.jsx("div",{className:"stat-card glow-sm",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"min-w-0 flex-1",children:[s.jsx("p",{className:"stat-label text-xs sm:text-sm",children:"SMAC Passata"}),s.jsxs("p",{className:"stat-value text-emerald-400 text-lg sm:text-2xl",children:["€",O.toFixed(2)]}),s.jsxs("p",{className:"text-xs text-dark-500",children:[F," conti"]})]}),s.jsx("div",{className:"w-8 h-8 sm:w-12 sm:h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center flex-shrink-0",children:s.jsx(y,{className:"w-4 h-4 sm:w-6 sm:h-6 text-emerald-400"})})]})}),s.jsx("div",{className:"stat-card",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"min-w-0 flex-1",children:[s.jsx("p",{className:"stat-label text-xs sm:text-sm",children:"Non Passata"}),s.jsxs("p",{className:"stat-value text-amber-400 text-lg sm:text-2xl",children:["€",$.toFixed(2)]}),s.jsxs("p",{className:"text-xs text-dark-500",children:[S," conti"]})]}),s.jsx("div",{className:"w-8 h-8 sm:w-12 sm:h-12 rounded-xl bg-amber-500/20 flex items-center justify-center flex-shrink-0",children:s.jsx(A,{className:"w-4 h-4 sm:w-6 sm:h-6 text-amber-400"})})]})}),s.jsx("div",{className:"stat-card",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"min-w-0 flex-1",children:[s.jsx("p",{className:"stat-label text-xs sm:text-sm",children:"Incasso"}),s.jsxs("p",{className:"stat-value text-lg sm:text-2xl",children:["€",(O+$).toFixed(2)]})]}),s.jsx("div",{className:"w-8 h-8 sm:w-12 sm:h-12 rounded-xl bg-primary-500/20 flex items-center justify-center flex-shrink-0",children:s.jsx(L,{className:"w-4 h-4 sm:w-6 sm:h-6 text-primary-400"})})]})})]}),s.jsxs("div",{className:"flex items-center gap-2 overflow-x-auto -mx-4 px-4 sm:mx-0 sm:px-0",children:[s.jsxs("button",{onClick:()=>M("all"),className:`px-3 sm:px-4 py-1.5 sm:py-2 rounded-xl font-medium transition-all text-xs sm:text-sm whitespace-nowrap ${v==="all"?"bg-primary-500 text-dark-900":"bg-dark-800 text-dark-300 hover:bg-dark-700"}`,children:["Tutti (",u.length,")"]}),s.jsx("button",{onClick:()=>M("passed"),className:`px-3 sm:px-4 py-1.5 sm:py-2 rounded-xl font-medium transition-all text-xs sm:text-sm whitespace-nowrap ${v==="passed"?"bg-emerald-500 text-white":"bg-dark-800 text-dark-300 hover:bg-dark-700"}`,children:s.jsxs("span",{className:"flex items-center gap-1 sm:gap-2",children:[s.jsx(y,{className:"w-3 h-3 sm:w-4 sm:h-4"}),"Passata (",F,")"]})}),s.jsx("button",{onClick:()=>M("not_passed"),className:`px-3 sm:px-4 py-1.5 sm:py-2 rounded-xl font-medium transition-all text-xs sm:text-sm whitespace-nowrap ${v==="not_passed"?"bg-amber-500 text-dark-900":"bg-dark-800 text-dark-300 hover:bg-dark-700"}`,children:s.jsxs("span",{className:"flex items-center gap-1 sm:gap-2",children:[s.jsx(A,{className:"w-3 h-3 sm:w-4 sm:h-4"}),"Non Passata (",S,")"]})})]}),s.jsxs("div",{className:"card",children:[s.jsx("div",{className:"card-header",children:s.jsx("h2",{className:"font-semibold text-white text-sm sm:text-base",children:"Ordini del Giorno"})}),s.jsx("div",{className:"divide-y divide-dark-700",children:T.length===0?s.jsxs("div",{className:"p-6 sm:p-8 text-center text-dark-400",children:[s.jsx(ps,{className:"w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-3 opacity-50"}),s.jsx("p",{className:"text-sm sm:text-base",children:"Nessun ordine trovato per questa data"})]}):T.map(e=>{const t=e.type==="session"&&e.orders.length>1,i=t&&J.has(e.sessionId),a=e.orders[0];return s.jsxs("div",{children:[s.jsxs("div",{className:`flex items-center justify-between p-3 sm:p-4 hover:bg-dark-900/50 transition-colors gap-2 ${t?"cursor-pointer":""}`,onClick:t?()=>Q(e.sessionId):void 0,children:[s.jsxs("div",{className:"flex items-center gap-2 sm:gap-4 min-w-0 flex-1",children:[s.jsxs("div",{className:"flex items-center gap-1 sm:gap-2 flex-shrink-0",children:[s.jsx("div",{className:"w-5 sm:w-6 flex items-center justify-center",children:t?i?s.jsx(ds,{className:"w-4 h-4 sm:w-5 sm:h-5 text-dark-400"}):s.jsx(os,{className:"w-4 h-4 sm:w-5 sm:h-5 text-dark-400"}):null}),s.jsx("div",{className:`w-8 h-8 sm:w-12 sm:h-12 rounded-xl flex items-center justify-center ${e.smacPassed===!0?"bg-emerald-500/20":e.smacPassed==="partial"?"bg-blue-500/20":"bg-amber-500/20"}`,children:e.smacPassed===!0?s.jsx(y,{className:"w-4 h-4 sm:w-6 sm:h-6 text-emerald-400"}):e.smacPassed==="partial"?s.jsx(A,{className:"w-4 h-4 sm:w-6 sm:h-6 text-blue-400"}):s.jsx(A,{className:"w-4 h-4 sm:w-6 sm:h-6 text-amber-400"})})]}),s.jsxs("div",{className:"min-w-0 flex-1",children:[s.jsx("div",{className:"font-semibold text-white text-sm sm:text-base",children:t?s.jsxs(s.Fragment,{children:[s.jsxs("span",{className:"whitespace-nowrap",children:["Conto - ",e.tableName]}),s.jsxs("span",{className:"block sm:inline text-xs text-dark-400 sm:ml-2",children:[e.payments.length>0&&`(${e.payments.length} pag.) `,"(",e.orders.length," com.)"]})]}):`#${a.id}`}),s.jsxs("div",{className:"flex flex-wrap items-center gap-1 sm:gap-3 text-xs sm:text-sm text-dark-400",children:[s.jsx("span",{children:a.order_type==="dine_in"?`T.${e.tableName||a.table_id}`:a.order_type==="takeaway"?"Asporto":"Domicilio"}),s.jsx("span",{className:"hidden sm:inline",children:"•"}),s.jsx("span",{className:"hidden sm:inline",children:a.payment_method==="cash"?"Contanti":a.payment_method==="card"?"Carta":"Online"})]})]})]}),s.jsxs("div",{className:"flex items-center gap-2 sm:gap-4 flex-shrink-0",children:[s.jsxs("div",{className:"text-right",children:[s.jsxs("p",{className:"text-base sm:text-xl font-bold text-primary-400",children:["€",e.total.toFixed(2)]}),s.jsx("p",{className:`text-xs sm:text-sm ${e.smacPassed===!0?"text-emerald-400":e.smacPassed==="partial"?"text-blue-400":"text-amber-400"}`,children:e.smacPassed===!0?"Passata":e.smacPassed==="partial"?s.jsxs(s.Fragment,{children:[s.jsxs("span",{className:"block",children:["Parziale (€",e.smacAmount.toFixed(2),")"]}),s.jsxs("span",{className:"block sm:inline",children:["Manc. €",(e.total-e.smacAmount).toFixed(2)]})]}):"Non Passata"})]}),s.jsx("button",{onClick:r=>{r.stopPropagation(),e.payments.length>0?K(e):H(e)},className:`p-2 sm:p-3 rounded-xl transition-all ${e.smacPassed===!0?"bg-emerald-500 text-white hover:bg-emerald-600":"bg-dark-700 text-dark-300 hover:bg-amber-500 hover:text-dark-900"}`,title:e.smacPassed===!0?"Rimuovi SMAC":"Segna come SMAC passata",children:s.jsx(is,{className:"w-4 h-4 sm:w-5 sm:h-5"})})]})]}),t&&i&&s.jsx("div",{className:"bg-dark-900/30 border-t border-dark-700",children:e.payments.length>0?e.payments.map(r=>s.jsxs("div",{className:"flex items-center justify-between px-3 sm:px-4 py-2 sm:py-3 pl-10 sm:pl-20 border-b border-dark-800 last:border-b-0",children:[s.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[s.jsx("span",{className:"text-dark-500",children:"└"}),s.jsxs("div",{children:[s.jsxs("p",{className:"text-xs sm:text-sm text-white font-medium",children:["€",r.amount.toFixed(2),r.notes&&s.jsxs("span",{className:"text-dark-400 ml-2 font-normal",children:["(",r.notes,")"]})]}),s.jsxs("p",{className:"text-xs text-dark-500",children:[r.payment_method==="cash"?"Contanti":r.payment_method==="card"?"Carta":"Online"," • ",new Date(r.paid_at).toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})]})]})]}),s.jsxs("button",{onClick:m=>{m.stopPropagation(),U(r,e.sessionId)},className:`flex items-center gap-1 text-xs px-2 py-1 rounded transition-all ${r.smac_passed?"bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500/40":"bg-red-500/20 text-red-400 hover:bg-red-500/40"}`,title:r.smac_passed?"Rimuovi SMAC":"Segna come SMAC passata",children:["SMAC ",r.smac_passed?"✓":"✗"]})]},r.id)):e.orders.map(r=>s.jsxs("div",{className:"flex items-center justify-between px-3 sm:px-4 py-2 sm:py-3 pl-10 sm:pl-20 border-b border-dark-800 last:border-b-0",children:[s.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[s.jsx("span",{className:"text-dark-500",children:"└"}),s.jsxs("div",{children:[s.jsxs("p",{className:"text-xs sm:text-sm text-dark-300",children:["Comanda ",r.order_number||1]}),s.jsx("p",{className:"text-xs text-dark-500",children:new Date(r.created_at).toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})})]})]}),s.jsxs("p",{className:"text-xs sm:text-sm font-medium text-dark-300",children:["€",r.total.toFixed(2)]})]},r.id))})]},e.type==="session"?`session-${e.sessionId}`:`order-${a.id}`)})})]}),s.jsxs("div",{className:"bg-blue-500/10 border border-blue-500/30 rounded-xl p-3 sm:p-4",children:[s.jsx("h3",{className:"font-semibold text-blue-400 mb-2 text-sm sm:text-base",children:"Cos'è la SMAC?"}),s.jsxs("p",{className:"text-xs sm:text-sm text-dark-300",children:["La ",s.jsx("strong",{children:"SMAC"})," (Carta Servizi) è il sistema di San Marino per la tracciabilità delle transazioni commerciali. Quando un cliente presenta la sua carta SMAC al momento del pagamento, l'importo viene registrato per beneficiare di detrazioni fiscali."]})]})]})}export{Ns as Smac};
